name: Deploy jarek-va-ui

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # Initialize Docker resources (network and volumes) if they don't exist
            echo "Initializing Docker resources..."
            
            # Create network if it doesn't exist
            if ! docker network ls | grep -q "virtual-assistant-network"; then
              echo "Creating virtual-assistant-network..."
              docker network create virtual-assistant-network || true
            fi
            
            # Navigate to jarek-va-ui directory
            cd jarek-va-ui || { echo "Directory jarek-va-ui not found"; exit 1; }
            
            echo "Current directory: $(pwd)"
            echo "Listing files in current directory:"
            ls -la || true
            
            # Update code
            echo "Updating code from git..."
            git fetch origin || { echo "Git fetch failed"; exit 1; }
            BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
            echo "Current branch: $BRANCH"
            git reset --hard origin/$BRANCH || { echo "Git reset failed"; exit 1; }
            
            # Verify docker-compose.yml exists
            echo "Checking for docker-compose.yml..."
            if [ ! -f "docker-compose.yml" ]; then
              echo "Error: docker-compose.yml not found in $(pwd)"
              exit 1
            fi
            echo "âœ“ docker-compose.yml found"
            
            # Load DOMAIN_NAME from .env file if it exists
            echo "Checking for .env file..."
            # Use test command with || true to avoid set -e exit on false
            if test -f ".env" || true; then
              if test -f ".env"; then
                echo ".env file found"
                ENV_FILE_EXISTS=true
              else
                echo ".env file not found"
                ENV_FILE_EXISTS=false
              fi
            else
              echo ".env file not found"
              ENV_FILE_EXISTS=false
            fi
            
            if [ "$ENV_FILE_EXISTS" = "true" ]; then
              echo "Loading environment variables from .env file..."
              set -a  # Automatically export all variables
              if source .env 2>&1; then
                set +a  # Stop automatically exporting
                echo "Successfully loaded .env file"
                echo "DOMAIN_NAME loaded: ${DOMAIN_NAME:-not set}"
              else
                set +a  # Stop automatically exporting even on error
                echo "Error: Failed to source .env file"
                echo "Contents of .env file (first 10 lines):"
                head -10 .env 2>&1 || true
                exit 1
              fi
            else
              echo "Warning: .env file not found, DOMAIN_NAME may not be set"
            fi
            echo "Environment variable check completed"
            
            # Build the container first
            echo "Building Docker container..."
            if ! docker compose build jarek-va-ui; then
              echo "Docker build failed"
              echo "Docker build logs:"
              docker compose build jarek-va-ui 2>&1 || true
              exit 1
            fi
            
            # Force recreate container with DOMAIN_NAME from environment
            echo "Starting Docker container..."
            if ! DOMAIN_NAME=${DOMAIN_NAME:-} docker compose up -d --force-recreate jarek-va-ui; then
              echo "Docker up failed"
              echo "Docker compose logs:"
              docker compose logs jarek-va-ui 2>&1 || true
              echo "Docker compose ps:"
              docker compose ps 2>&1 || true
              exit 1
            fi
            
            # Wait a few seconds for the service to start
            echo "Waiting for service to start..."
            sleep 10
            
            # Verify the container is running
            if docker compose ps jarek-va-ui | grep -q "Up"; then
              echo "Container is running successfully"
            else
              echo "Warning: Container may not be running properly"
              docker compose ps jarek-va-ui || true
            fi
            
            echo "Deployment completed successfully"
          script_stop: true
          debug: true

