name: Deploy jarek-va-ui

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to (or "all" for all environments)'
        required: true
        type: choice
        options:
          - jarekva
          - bluetractorva
          - all
        default: 'jarekva'

jobs:
  # Determine deployment target(s) based on trigger
  determine-environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-envs.outputs.environments }}
    steps:
      - id: set-envs
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger: use selected environment
            ENV="${{ github.event.inputs.environment }}"
            if [ "$ENV" == "all" ]; then
              JSON_ARRAY='["jarekva","bluetractorva"]'
            else
              JSON_ARRAY="[\"$ENV\"]"
            fi
          else
            # Push to main/master: deploy to both environments
            JSON_ARRAY='["jarekva","bluetractorva"]'
          fi
          echo "environments=$JSON_ARRAY" >> $GITHUB_OUTPUT

  deploy:
    needs: determine-environments
    runs-on: ubuntu-latest
    # Only run if the push is to the main branch
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    # Deploy to each environment in the matrix
    strategy:
      matrix:
        environment: ${{ fromJson(needs.determine-environments.outputs.environments) }}
      fail-fast: false
    
    # Use GitHub Environments for environment-specific secrets and protection rules
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Deploy to ${{ matrix.environment }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # Initialize Docker resources (network and volumes) if they don't exist
            echo "Initializing Docker resources for ${{ matrix.environment }}..."
            
            # Create network if it doesn't exist
            if ! docker network ls | grep -q "virtual-assistant-network"; then
              echo "Creating virtual-assistant-network..."
              docker network create virtual-assistant-network || true
            fi
            
            # Navigate to jarek-va-ui directory
            cd jarek-va-ui || { echo "Directory jarek-va-ui not found"; exit 1; }
            
            # Update code
            git fetch origin || { echo "Git fetch failed"; exit 1; }
            BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
            git reset --hard origin/$BRANCH || { echo "Git reset failed"; exit 1; }
            
            # Verify docker-compose.yml exists
            if [ ! -f "docker-compose.yml" ]; then
              echo "Error: docker-compose.yml not found in $(pwd)"
              exit 1
            fi
            
            # DOMAIN_NAME is optional - used for Traefik routing labels
            # Should be just the domain name (e.g., "jarekva.com") without protocol
            # Can be set via GitHub secret DOMAIN_NAME or environment variable
            export DOMAIN_NAME=${DOMAIN_NAME:-jarekva.com}
            
            # Build the container first
            echo "Building Docker container..."
            docker compose build jarek-va-ui || { echo "Docker build failed"; exit 1; }
            
            # Force recreate container with DOMAIN_NAME from environment
            echo "Starting Docker container..."
            docker compose up -d --force-recreate jarek-va-ui || { echo "Docker up failed"; exit 1; }
            
            # Wait a few seconds for the service to start
            echo "Waiting for service to start..."
            sleep 10
            
            # Verify the container is running
            if docker compose ps jarek-va-ui | grep -q "Up"; then
              echo "Container is running successfully"
            else
              echo "Warning: Container may not be running properly"
              docker compose ps jarek-va-ui || true
            fi
            
            echo "Deployment to ${{ matrix.environment }} completed successfully"
          script_stop: true

