server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Prevent caching of HTML files (index.html and any HTML files)
    # This ensures users always get the latest version after deployments
    location ~* \.html$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }

    # Prevent caching of the root index.html specifically
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }

    # Proxy API requests to cursor-runner (for direct access via localhost:3002)
    # When accessing via Traefik, these requests are handled by Traefik routing
    # But for local development/direct access, nginx proxies them
    # Handle both /api/ and /conversations/api/ paths
    location ~ ^/conversations/api/ {
        # Strip /conversations prefix, then proxy to cursor-runner
        rewrite ^/conversations/api/(.*) /api/$1 break;
        proxy_pass http://cursor-runner:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # Don't cache API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }
    
    # Also handle direct /api/ requests (if accessed without /conversations prefix)
    location ~ ^/api/ {
        proxy_pass http://cursor-runner:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # Don't cache API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }
    
    # Proxy agent-conversations session endpoint to elevenlabs-agent (must come before general rule)
    # This handles /agent-conversations/api/:id/session POST requests
    location ~ ^/agent-conversations/api/[^/]+/session$ {
        # Keep the original path and proxy to elevenlabs-agent
        proxy_pass http://elevenlabs-agent:3004;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # Don't cache API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }
    
    # Proxy agent-conversations API requests to cursor-runner (for direct access via localhost:3002)
    # When accessing via Traefik, these requests are handled by Traefik routing
    # But for local development/direct access, nginx proxies them
    location ~ ^/agent-conversations/api/ {
        # Strip /agent-conversations/api prefix, then add /api/agent prefix
        # So /agent-conversations/api/list becomes /api/agent/list
        rewrite ^/agent-conversations/api/(.*) /api/agent/$1 break;
        proxy_pass http://cursor-runner:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # Don't cache API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }

    # Serve static files (SPA routing)
    # Note: When accessed via Traefik, the /conversations prefix is stripped,
    # so requests to /conversations/ become / here, and we serve index.html
    location / {
        # Don't cache HTML responses for SPA routing
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets (JS, CSS, images, fonts) - these have hashes in filenames
    # Vite already includes content hashes in filenames, so these can be cached safely
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

