services:
  # jarek-va-ui React frontend application service
  jarek-va-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time environment variables for Vite
        # These are baked into the JavaScript bundle during build
        VITE_ELEVENLABS_AGENT_ENABLED: ${VITE_ELEVENLABS_AGENT_ENABLED:-false}
        VITE_ELEVENLABS_AGENT_URL: ${VITE_ELEVENLABS_AGENT_URL:-http://localhost:3004}
        VITE_ELEVENLABS_AGENT_ID: ${VITE_ELEVENLABS_AGENT_ID:-}
        VITE_ELEVENLABS_AGENT_PUBLIC: ${VITE_ELEVENLABS_AGENT_PUBLIC:-}
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/conversations/api}
    container_name: jarek-va-ui
    restart: unless-stopped
    # Port mapping for local development access
    # Traefik will also route traffic in production
    ports:
      - "3002:80"
    networks:
      - virtual-assistant-network
    # Note: Traefik service is defined in cursor-runner/docker-compose.yml
    # This service connects to it via the shared network
    labels:
      - "traefik.enable=true"
      # Path-based routing - accessible at /conversations/*, /tasks, and /task/* on the same domain
      # Priority ensures this router is evaluated before the general Rails app router
      # Exclude /api/* paths explicitly - these are handled by cursor-runner (API routes)
      # HTTPS router (for production domains only - exclude localhost)
      # Only create HTTPS router when DOMAIN_NAME is set and contains a dot (real domain, not localhost)
      - "traefik.http.routers.jarek-va-ui.priority=10"
      - "traefik.http.routers.jarek-va-ui.rule=HostRegexp(`.*\\..*`) && Host(`${DOMAIN_NAME:-localhost}`) && ((PathPrefix(`/conversations`) && !PathPrefix(`/conversations/api`)) || (PathPrefix(`/tasks`) && !PathPrefix(`/api`)) || (PathPrefix(`/task`) && !PathPrefix(`/api`)))"
      - "traefik.http.routers.jarek-va-ui.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui.tls.certresolver=letsencrypt"
      - "traefik.http.services.jarek-va-ui.loadbalancer.server.port=80"
      # HTTP router for localhost (no TLS, no redirect)
      - "traefik.http.routers.jarek-va-ui-localhost.priority=10"
      - "traefik.http.routers.jarek-va-ui-localhost.rule=Host(`localhost`) && ((PathPrefix(`/conversations`) && !PathPrefix(`/conversations/api`)) || (PathPrefix(`/tasks`) && !PathPrefix(`/api`)) || (PathPrefix(`/task`) && !PathPrefix(`/api`)))"
      - "traefik.http.routers.jarek-va-ui-localhost.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-localhost.service=jarek-va-ui"
      - "traefik.http.routers.jarek-va-ui-localhost.middlewares=jarek-va-ui-stripprefix,jarek-va-ui-headers"
      # HTTP router for direct IP access - serve UI at root (no TLS, no redirect)
      # This enables http://3.148.184.96/ (React Router root) while keeping API paths owned by cursor-runner.
      - "traefik.http.routers.jarek-va-ui-ip.priority=10"
      # Match any IPv4 host (optionally with :port)
      - "traefik.http.routers.jarek-va-ui-ip.rule=HostRegexp(`{host:[0-9]{1,3}(\\.[0-9]{1,3}){3}(:[0-9]+)?}`) && PathPrefix(`/`) && !PathPrefix(`/api`) && !PathPrefix(`/conversations/api`) && !PathPrefix(`/agent-conversations/api`) && !PathPrefix(`/cursor/execute`) && !PathPrefix(`/agents`)"
      - "traefik.http.routers.jarek-va-ui-ip.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-ip.service=jarek-va-ui"
      # HTTPS router for direct IP access - redirect to HTTP (IPs can't get valid certificates)
      - "traefik.http.routers.jarek-va-ui-ip-https.priority=10"
      - "traefik.http.routers.jarek-va-ui-ip-https.rule=HostRegexp(`{host:[0-9]{1,3}(\\.[0-9]{1,3}){3}(:[0-9]+)?}`) && PathPrefix(`/`) && !PathPrefix(`/api`) && !PathPrefix(`/conversations/api`) && !PathPrefix(`/agent-conversations/api`) && !PathPrefix(`/cursor/execute`) && !PathPrefix(`/agents`)"
      - "traefik.http.routers.jarek-va-ui-ip-https.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui-ip-https.tls=true"
      - "traefik.http.routers.jarek-va-ui-ip-https.middlewares=jarek-va-ui-ip-https-to-http"
      - "traefik.http.middlewares.jarek-va-ui-ip-https-to-http.redirectscheme.scheme=http"
      - "traefik.http.middlewares.jarek-va-ui-ip-https-to-http.redirectscheme.permanent=false"
      # Static assets router (Vite build outputs under /assets and root-level files like /vite.svg)
      # HTTPS router (for production domains only - exclude localhost)
      # Only create HTTPS router when DOMAIN_NAME is set and contains a dot (real domain, not localhost)
      - "traefik.http.routers.jarek-va-ui-assets.priority=10"
      - "traefik.http.routers.jarek-va-ui-assets.rule=HostRegexp(`.*\\..*`) && Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui-assets.tls.certresolver=letsencrypt"
      - "traefik.http.routers.jarek-va-ui-assets.service=jarek-va-ui"
      # HTTP router for localhost assets (no TLS)
      - "traefik.http.routers.jarek-va-ui-assets-localhost.priority=10"
      - "traefik.http.routers.jarek-va-ui-assets-localhost.rule=Host(`localhost`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets-localhost.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-assets-localhost.service=jarek-va-ui"
      - "traefik.http.routers.jarek-va-ui-assets-localhost.middlewares=jarek-va-ui-headers"
      # HTTP router for direct IP access - static assets at /assets (no TLS, no redirect)
      - "traefik.http.routers.jarek-va-ui-assets-ip.priority=10"
      - "traefik.http.routers.jarek-va-ui-assets-ip.rule=HostRegexp(`{host:[0-9]{1,3}(\\.[0-9]{1,3}){3}(:[0-9]+)?}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets-ip.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-assets-ip.service=jarek-va-ui"
      # HTTPS router for direct IP access - redirect to HTTP (IPs can't get valid certificates)
      - "traefik.http.routers.jarek-va-ui-assets-ip-https.priority=10"
      - "traefik.http.routers.jarek-va-ui-assets-ip-https.rule=HostRegexp(`{host:[0-9]{1,3}(\\.[0-9]{1,3}){3}(:[0-9]+)?}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets-ip-https.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui-assets-ip-https.tls=true"
      - "traefik.http.routers.jarek-va-ui-assets-ip-https.middlewares=jarek-va-ui-ip-https-to-http"
      # Reuse security headers for assets, no prefix stripping
      - "traefik.http.routers.jarek-va-ui-assets.middlewares=jarek-va-ui-headers"
      # HTTP router for /conversations* that redirects to HTTPS
      - "traefik.http.routers.jarek-va-ui-http.rule=Host(`${DOMAIN_NAME:-localhost}`) && ((PathPrefix(`/conversations`) && !PathPrefix(`/conversations/api`)) || (PathPrefix(`/tasks`) && !PathPrefix(`/api`)) || (PathPrefix(`/task`) && !PathPrefix(`/api`)))"
      - "traefik.http.routers.jarek-va-ui-http.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-http.middlewares=jarek-va-ui-https-redirect"
      - "traefik.http.routers.jarek-va-ui-http.priority=10"
      # HTTP router for assets that redirects to HTTPS
      - "traefik.http.routers.jarek-va-ui-assets-http.rule=Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets-http.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-assets-http.middlewares=jarek-va-ui-https-redirect"
      - "traefik.http.routers.jarek-va-ui-assets-http.priority=10"
      # Per-service HTTP -> HTTPS redirect middleware (keeps redirect logic close to the UI service)
      - "traefik.http.middlewares.jarek-va-ui-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.jarek-va-ui-https-redirect.redirectscheme.permanent=true"
      # Strip /conversations prefix before forwarding to the service
      - "traefik.http.middlewares.jarek-va-ui-stripprefix.stripprefix.prefixes=/conversations"
      # Security headers middleware
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsPreload=true"
      # Apply both strip prefix and security headers
      - "traefik.http.routers.jarek-va-ui.middlewares=jarek-va-ui-stripprefix,jarek-va-ui-headers"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  virtual-assistant-network:
    external: true

