services:
  # jarek-va-ui React frontend application service
  jarek-va-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time environment variables for Vite
        # These are baked into the JavaScript bundle during build
        VITE_ELEVENLABS_AGENT_ENABLED: ${VITE_ELEVENLABS_AGENT_ENABLED:-false}
        VITE_ELEVENLABS_AGENT_URL: ${VITE_ELEVENLABS_AGENT_URL:-http://localhost:3004}
        VITE_ELEVENLABS_AGENT_ID: ${VITE_ELEVENLABS_AGENT_ID:-}
        VITE_ELEVENLABS_AGENT_PUBLIC: ${VITE_ELEVENLABS_AGENT_PUBLIC:-}
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/conversations/api}
    container_name: jarek-va-ui
    restart: unless-stopped
    # Port mapping for local development access
    # Traefik will also route traffic in production
    ports:
      - "3002:80"
    networks:
      - virtual-assistant-network
    # Note: Traefik service is defined in cursor-runner/docker-compose.yml
    # This service connects to it via the shared network
    labels:
      - "traefik.enable=true"
      # Path-based routing - accessible at /conversations/*, /tasks, and /task/* on the same domain
      # Priority ensures this router is evaluated before the general Rails app router
      # Exclude /api/* paths explicitly - these are handled by Rails (API routes)
      - "traefik.http.routers.jarek-va-ui.priority=10"
      - "traefik.http.routers.jarek-va-ui.rule=Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/conversations`) || (PathPrefix(`/tasks`) && !PathPrefix(`/api`)) || (PathPrefix(`/task`) && !PathPrefix(`/api`)))"
      - "traefik.http.routers.jarek-va-ui.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui.tls.certresolver=letsencrypt"
      - "traefik.http.services.jarek-va-ui.loadbalancer.server.port=80"
      # Static assets router (Vite build outputs under /assets and root-level files like /vite.svg)
      - "traefik.http.routers.jarek-va-ui-assets.priority=10"
      - "traefik.http.routers.jarek-va-ui-assets.rule=Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets.entrypoints=websecure"
      - "traefik.http.routers.jarek-va-ui-assets.tls.certresolver=letsencrypt"
      - "traefik.http.routers.jarek-va-ui-assets.service=jarek-va-ui"
      # Reuse security headers for assets, no prefix stripping
      - "traefik.http.routers.jarek-va-ui-assets.middlewares=jarek-va-ui-headers"
      # HTTP router for /conversations* that redirects to HTTPS
      - "traefik.http.routers.jarek-va-ui-http.rule=Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/conversations`) || (PathPrefix(`/tasks`) && !PathPrefix(`/api`)) || (PathPrefix(`/task`) && !PathPrefix(`/api`)))"
      - "traefik.http.routers.jarek-va-ui-http.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-http.middlewares=jarek-va-ui-https-redirect"
      - "traefik.http.routers.jarek-va-ui-http.priority=10"
      # HTTP router for assets that redirects to HTTPS
      - "traefik.http.routers.jarek-va-ui-assets-http.rule=Host(`${DOMAIN_NAME:-localhost}`) && (PathPrefix(`/assets`) || Path(`/vite.svg`))"
      - "traefik.http.routers.jarek-va-ui-assets-http.entrypoints=web"
      - "traefik.http.routers.jarek-va-ui-assets-http.middlewares=jarek-va-ui-https-redirect"
      - "traefik.http.routers.jarek-va-ui-assets-http.priority=10"
      # Per-service HTTP -> HTTPS redirect middleware (keeps redirect logic close to the UI service)
      - "traefik.http.middlewares.jarek-va-ui-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.jarek-va-ui-https-redirect.redirectscheme.permanent=true"
      # Strip /conversations prefix before forwarding to the service
      - "traefik.http.middlewares.jarek-va-ui-stripprefix.stripprefix.prefixes=/conversations"
      # Security headers middleware
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.jarek-va-ui-headers.headers.stsPreload=true"
      # Apply both strip prefix and security headers
      - "traefik.http.routers.jarek-va-ui.middlewares=jarek-va-ui-stripprefix,jarek-va-ui-headers"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  virtual-assistant-network:
    external: true

