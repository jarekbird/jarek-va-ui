# TASK-TD-006: Implement Conversations API Hooks for Notes

**Section**: 4. API and Hook Implementation
**Subsection**: 4.1
**Task ID**: TASK-TD-006
**Order**: 006

## Description

This task extends the conversations API client and creates TanStack Query hooks needed for the NoteTakingPanel component. It implements API functions for creating conversations and adding messages, and creates corresponding query and mutation hooks following the existing patterns in `cursor-executor-front`.

**Reference Implementation**: 
- `python-cursor/cursor-executor/cursor-executor-front/src/api/conversations.ts`
- `python-cursor/cursor-executor/cursor-executor-front/src/hooks/useConversationsQuery.ts`
- `python-cursor/cursor-executor/cursor-executor-front/src/query/queryClient.ts`

## Current State

- `src/api/conversations.ts` exists with `fetchConversations` and `fetchConversation`
- `src/hooks/useConversationsQuery.ts` exists for listing conversations
- No API functions exist for creating conversations or adding messages
- No mutation hooks exist for conversations
- Backend contracts documented in TASK-TD-003

**Important**: This task focuses on API layer and hooks only. Component implementation comes in TASK-TD-007.

## Checklist

### Preparation and Setup

- [ ] Navigate to `python-cursor/cursor-executor/cursor-executor-front` directory
- [ ] Review existing `src/api/conversations.ts` implementation
- [ ] Review existing `src/hooks/useConversationsQuery.ts` implementation
- [ ] Review backend contracts from TASK-TD-003
- [ ] Review `src/api/client.ts` to understand API client patterns
- [ ] Review existing test patterns in `src/api/conversations.test.ts`

### Implementation Steps

- [ ] Step 1: Extend conversations API functions
  - [ ] Open `src/api/conversations.ts`
  - [ ] Add `createConversation` function:
    - [ ] Accept parameters (e.g., initial message content, metadata)
    - [ ] Use `apiPost` or appropriate HTTP method from client
    - [ ] Call backend endpoint (from TASK-TD-003 documentation)
    - [ ] Transform response to `Conversation` type
    - [ ] Handle errors appropriately
  - [ ] Add `addMessageToConversation` function:
    - [ ] Accept `conversationId` and message content
    - [ ] Use `apiPost` or appropriate HTTP method
    - [ ] Call backend endpoint (from TASK-TD-003 documentation)
    - [ ] Transform response to appropriate type
    - [ ] Handle errors appropriately
  - [ ] Export new functions
- [ ] Step 2: Create mutation hooks
  - [ ] Create or update `src/hooks/useConversationsQuery.ts` (or create separate file)
  - [ ] Add `useCreateConversationMutation` hook:
    - [ ] Use `useMutation` from TanStack Query
    - [ ] Call `createConversation` API function
    - [ ] Configure mutation options (onSuccess, onError)
    - [ ] Invalidate conversations query on success
  - [ ] Add `useAddMessageMutation` hook:
    - [ ] Use `useMutation` from TanStack Query
    - [ ] Call `addMessageToConversation` API function
    - [ ] Configure mutation options
    - [ ] Invalidate conversation query on success
- [ ] Step 3: Extend existing query hooks if needed
  - [ ] Review `useConversationsQuery` - ensure it supports all needed parameters
  - [ ] Create `useConversationQuery` hook if needed (for single conversation):
    - [ ] Use `useQuery` from TanStack Query
    - [ ] Call `fetchConversation` API function
    - [ ] Use `conversationId` in query key
    - [ ] Configure query options (staleTime, cacheTime, etc.)
  - [ ] Ensure query keys follow naming conventions

### Specific Requirements

- [ ] Requirement 1: API functions
  - [ ] Functions follow existing patterns in `conversations.ts`
  - [ ] Functions use typed request/response shapes
  - [ ] Functions handle errors consistently
  - [ ] Functions transform backend responses to frontend types
- [ ] Requirement 2: Mutation hooks
  - [ ] Hooks use TanStack Query `useMutation`
  - [ ] Hooks invalidate relevant queries on success
  - [ ] Hooks handle loading, error, and success states
  - [ ] Hooks are properly typed
- [ ] Requirement 3: Query hooks
  - [ ] Hooks use TanStack Query `useQuery`
  - [ ] Hooks have appropriate query keys
  - [ ] Hooks have appropriate cache configuration
  - [ ] Hooks are properly typed

### Error Handling and Edge Cases

- [ ] API functions handle network errors
- [ ] API functions handle validation errors (400)
- [ ] API functions handle not found errors (404)
- [ ] API functions handle server errors (500)
- [ ] Mutation hooks handle errors gracefully
- [ ] Query hooks handle errors gracefully
- [ ] Handle edge cases (empty responses, null values, etc.)

### Testing

- [ ] Step 1: Test API functions
  - [ ] Update `src/api/conversations.test.ts`
  - [ ] Test `createConversation`:
    - [ ] Test successful creation
    - [ ] Test error handling
    - [ ] Test request/response transformation
  - [ ] Test `addMessageToConversation`:
    - [ ] Test successful message addition
    - [ ] Test error handling
    - [ ] Test request/response transformation
- [ ] Step 2: Test mutation hooks
  - [ ] Create or update `src/hooks/useCreateConversationMutation.test.tsx`
  - [ ] Test `useCreateConversationMutation`:
    - [ ] Test successful mutation
    - [ ] Test error handling
    - [ ] Test query invalidation
    - [ ] Test loading states
  - [ ] Create `src/hooks/useAddMessageMutation.test.tsx`
  - [ ] Test `useAddMessageMutation`:
    - [ ] Test successful mutation
    - [ ] Test error handling
    - [ ] Test query invalidation
    - [ ] Test loading states
- [ ] Step 3: Test query hooks
  - [ ] Update `src/hooks/useConversationsQuery.test.tsx` if needed
  - [ ] Create `src/hooks/useConversationQuery.test.tsx` if created
  - [ ] Test query hooks:
    - [ ] Test successful queries
    - [ ] Test error handling
    - [ ] Test loading states
    - [ ] Test query key structure
- [ ] Step 4: Run all tests
  - [ ] Run: `npm test`
  - [ ] Verify: All tests pass
  - [ ] Verify: Test coverage is adequate

### Documentation

- [ ] Add JSDoc comments to new API functions
  - [ ] Document parameters
  - [ ] Document return types
  - [ ] Document error cases
- [ ] Add JSDoc comments to new hooks
  - [ ] Document hook purpose
  - [ ] Document return values
  - [ ] Document usage examples
- [ ] Update type definitions if needed
  - [ ] Ensure all types are exported
  - [ ] Ensure types match API contracts

### Verification

- [ ] Verify API functions work with backend (if backend is available)
  - [ ] Test `createConversation` against real backend
  - [ ] Test `addMessageToConversation` against real backend
- [ ] Verify hooks work correctly
  - [ ] Test hooks in a simple component (if needed)
  - [ ] Verify query invalidation works
- [ ] Verify tests pass
- [ ] Verify type checking passes

## Notes

- This task is part of the Task Dashboard React/TanStack Port project
- **Execution Timing**: Must be completed after TASK-TD-003 and TASK-TD-005, before TASK-TD-007
- **Dependencies**:
  - TASK-TD-003: Provides backend contract documentation
  - TASK-TD-005: Provides TaskDashboard shell structure
- **Important Considerations**:
  - Follow existing API and hook patterns for consistency
  - Ensure proper error handling
  - Ensure proper TypeScript typing
  - Backend endpoints may need to be implemented separately
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: Basic conversations API exists, needs extension for mutations

## Related Tasks

- Previous: TASK-TD-005
- Next: TASK-TD-007
- Dependencies:
  - TASK-TD-003: Provides backend contracts
- Related:
  - TASK-TD-007: Will use these hooks in NoteTakingPanel component

## Definition of Done

### User Stories

**As a developer** implementing NoteTakingPanel, **I need** API hooks for creating conversations and adding messages **so that** I can implement the panel functionality.

**As a user**, **I need** the ability to create conversations and add messages **so that** I can take notes in the Task Dashboard.

### Automated Tests

- [ ] API functions are tested
  - [ ] Test file: `src/api/conversations.test.ts`
  - [ ] Test: `createConversation` function works correctly
  - [ ] Test: `addMessageToConversation` function works correctly
  - [ ] Test: Error handling works correctly
  - [ ] Run: `npm test conversations.test`
  - [ ] Verify: All API tests pass
- [ ] Mutation hooks are tested
  - [ ] Test files: `src/hooks/useCreateConversationMutation.test.tsx`, `src/hooks/useAddMessageMutation.test.tsx`
  - [ ] Test: Mutations work correctly
  - [ ] Test: Query invalidation works
  - [ ] Test: Error handling works
  - [ ] Run: `npm test useCreateConversationMutation useAddMessageMutation`
  - [ ] Verify: All mutation hook tests pass
- [ ] Query hooks are tested
  - [ ] Test: Query hooks work correctly
  - [ ] Test: Loading states work
  - [ ] Test: Error states work
  - [ ] Verify: All query hook tests pass
- [ ] All tests pass
  - [ ] Run: `npm test`
  - [ ] Verify: Exit code is 0, all tests pass
- [ ] Type checking passes
  - [ ] Run: `npm run type-check`
  - [ ] Verify: No type errors
- [ ] Linting passes
  - [ ] Run: `npm run lint`
  - [ ] Verify: No linting errors

### Code Quality

- [ ] API functions follow existing patterns
- [ ] Hooks follow existing patterns
- [ ] Code is properly typed (TypeScript)
- [ ] Code follows project conventions
- [ ] Error handling is consistent

### Git Commit and Push

- [ ] All changes are committed to git:
  - [ ] `src/api/conversations.ts` (modified - new functions)
  - [ ] `src/api/conversations.test.ts` (modified - new tests)
  - [ ] `src/hooks/useConversationsQuery.ts` (modified - or new hooks file)
  - [ ] `src/hooks/useCreateConversationMutation.test.tsx` (new file)
  - [ ] `src/hooks/useAddMessageMutation.test.tsx` (new file)
  - [ ] Any other hook test files (new or modified)
- [ ] Commit message follows project conventions: `"TASK-TD-006: Implement conversations API hooks for notes"`
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Verify push was successful: `git log --oneline -1` shows the commit

### Final Verification

- [ ] All API functions are implemented and tested
- [ ] All hooks are implemented and tested
- [ ] All tests pass
- [ ] Type checking passes
- [ ] Linting passes
- [ ] Code is committed and pushed to origin
- [ ] Task is ready for handoff to TASK-TD-007

