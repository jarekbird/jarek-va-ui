# Implement Signed URL Route

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `routes/signed-url.ts` with `GET /signed-url`:
  - Optional `agentId` query param.
  - Calls `elevenlabs-api.getSignedUrl`.
  - Returns `{ signedUrl, expiresAt? }`.
- Gate the route with `ELEVENLABS_AGENT_ENABLED` flag (return 503 if disabled).
- Add basic rate limiting or logging if necessary.

## Desired Outcomes

### Primary Outcomes
1. **Signed URL Endpoint**: RESTful endpoint that provides signed URLs for private ElevenLabs agents, enabling frontend to connect securely.

2. **Feature Flag Protection**: Route disabled when feature flag is off, preventing unauthorized access.

3. **Security**: Proper handling of agent IDs and API keys without exposure.

4. **Rate Limiting**: Protection against abuse while allowing legitimate use.

### Success Criteria
- Endpoint returns signed URLs successfully
- Feature flag properly gates the route
- Optional agentId parameter handled
- Rate limiting implemented (if needed)
- Error handling for API failures
- Security best practices followed
- Tests cover all paths

## User Stories

### As a Frontend Developer
- **Story 1**: I want a signed URL endpoint so that I can connect to private ElevenLabs agents.
- **Story 2**: I want clear error messages when the endpoint is disabled so that I understand why it's not working.

### As a System Administrator
- **Story 3**: I want rate limiting so that the endpoint isn't abused.

## Suggested Automated Tests

### Unit Tests
1. **Success Path Tests**:
   ```typescript
   describe('GET /signed-url', () => {
     it('returns signed URL', async () => {
       jest.spyOn(elevenlabsApi, 'getSignedUrl').mockResolvedValue({
         signedUrl: 'wss://...',
         expiresAt: '2024-01-01T00:10:00Z'
       });
       
       const response = await request(app)
         .get('/signed-url?agentId=agent-123')
         .expect(200);
       
       expect(response.body).toHaveProperty('signedUrl');
     });
   });
   ```

2. **Feature Flag Tests**:
   ```typescript
   describe('Feature Flag', () => {
     it('returns 503 when feature disabled', async () => {
       process.env.ELEVENLABS_AGENT_ENABLED = 'false';
       const response = await request(app)
         .get('/signed-url')
         .expect(503);
     });
   });
   ```

3. **Error Handling Tests**:
   ```typescript
   describe('Error Handling', () => {
     it('handles API failures', async () => {
       jest.spyOn(elevenlabsApi, 'getSignedUrl').mockRejectedValue(new Error('API Error'));
       await request(app)
         .get('/signed-url')
         .expect(500);
     });
   });
   ```

## Inherent Risks

### High Risk
1. **API Key Exposure**:
   - **Risk**: API key leaked through error messages or logs
   - **Mitigation**: Sanitize errors, never log API key, security review

2. **Rate Limiting Bypass**:
   - **Risk**: Endpoint abused causing API quota exhaustion
   - **Mitigation**: Proper rate limiting, monitoring, alerting

### Medium Risk
3. **Feature Flag Misconfiguration**:
   - **Risk**: Route accessible when it shouldn't be
   - **Mitigation**: Test flag behavior, clear documentation, monitoring

### Low Risk
4. **Agent ID Validation**:
   - **Risk**: Invalid agent IDs causing API errors
   - **Mitigation**: Input validation, error handling, clear messages
