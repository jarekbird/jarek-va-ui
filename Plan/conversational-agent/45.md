# Validate Session TTL and Expiration Behavior

## Scope
`elevenlabs-agent`.

## Subtasks
- Confirm that `elevenlabs:session:{conversation_id}` entries expire around 10 minutes.
- Ensure callbacks after expiration fail gracefully and log clearly.
- Verify that conversations remain even when sessions are gone.

## Desired Outcomes

### Primary Outcomes
1. **TTL Accuracy**: Sessions expire exactly 10 minutes after creation, preventing stale data.

2. **Graceful Expiration Handling**: Callbacks after session expiration handled gracefully without errors.

3. **Conversation Persistence**: Conversations persist even when sessions expire, maintaining history.

4. **Clear Logging**: Expiration events logged clearly for debugging.

### Success Criteria
- Sessions expire at 10 minutes
- Callbacks after expiration handled gracefully
- Conversations persist after session expiration
- Clear error messages logged
- Tests verify TTL behavior
- Tests verify expiration handling

## User Stories

### As a Developer
- **Story 1**: I want accurate TTL so that sessions expire at the right time.
- **Story 2**: I want graceful expiration handling so that expired sessions don't cause errors.

### As a System Administrator
- **Story 3**: I want conversation persistence so that history isn't lost when sessions expire.

## Suggested Automated Tests

### Unit Tests
1. **TTL Tests**:
   ```typescript
   describe('Session TTL', () => {
     it('expires session after 10 minutes', async () => {
       jest.useFakeTimers();
       await sessionStore.set('conv-123', session);
       jest.advanceTimersByTime(10 * 60 * 1000 + 1000);
       const retrieved = await sessionStore.get('conv-123');
       expect(retrieved).toBeNull();
     });
   });
   ```

2. **Expiration Handling Tests**:
   ```typescript
   describe('Expiration Handling', () => {
     it('handles callback after expiration gracefully', async () => {
       // Session expired
       // Callback should fail gracefully
     });
   });
   ```

## Inherent Risks

### Medium Risk
1. **TTL Timing Issues**:
   - **Risk**: TTL not accurate, causing premature or delayed expiration
   - **Mitigation**: Accurate timing, tests, monitoring

2. **Expiration Race Conditions**:
   - **Risk**: Callback arrives during expiration, causing errors
   - **Mitigation**: Atomic operations, proper error handling, idempotent design

### Low Risk
3. **Logging Clarity**:
   - **Risk**: Expiration logs not clear enough for debugging
   - **Mitigation**: Structured logging, clear messages, log levels
