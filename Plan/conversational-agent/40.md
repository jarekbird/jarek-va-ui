# Add Unit Tests for elevenlabs-agent Core

## Scope
`elevenlabs-agent`.

## Subtasks
- Add tests for:
  - Session store TTL and schema.
  - Callback queue behavior and race conditions.
  - Signed URL route.
  - Webhook handling and immediate responses.
  - Callback route push logic (mocking ElevenLabs/WebSocket).

## Desired Outcomes

### Primary Outcomes
1. **Comprehensive Test Coverage**: All core functionality covered by automated tests.

2. **Race Condition Protection**: Tests verify callback queue handles out-of-order completions correctly.

3. **TTL Validation**: Tests confirm session and task TTLs work as expected.

4. **Integration Safety**: Tests ensure webhook and callback routes work correctly.

5. **Maintainability**: Test suite serves as documentation and prevents regressions.

### Success Criteria
- Session store tests pass
- Callback queue tests pass
- Race condition tests pass
- Route tests pass
- Push logic tests pass
- Test coverage > 80%
- All critical paths tested
- Tests run in CI

## User Stories

### As a Developer
- **Story 1**: I want comprehensive tests so that I can refactor confidently.
- **Story 2**: I want race condition tests so that I know the system handles concurrency correctly.

### As a Code Reviewer
- **Story 3**: I want test coverage so that I can verify functionality works correctly.

## Suggested Automated Tests

### Unit Tests
1. **Session Store Tests** (covered in Task 12 expansion)
2. **Callback Queue Tests** (covered in Task 13 expansion)
3. **Route Tests** (covered in Tasks 16-19 expansions)
4. **Push Logic Tests** (covered in Task 19 expansion)

### Integration Tests
5. **End-to-End Flow Tests**:
   ```typescript
   describe('End-to-End Flow', () => {
     it('webhook → callback → push flow works', async () => {
       // Full flow test
     });
   });
   ```

## Inherent Risks

### Medium Risk
1. **Test Gaps**:
   - **Risk**: Critical paths not covered by tests
   - **Mitigation**: Coverage analysis, review test plans, add missing tests

2. **Brittle Tests**:
   - **Risk**: Tests break frequently due to implementation changes
   - **Mitigation**: Test behavior not implementation, use stable selectors, maintain test utilities

### Low Risk
3. **Test Maintenance Burden**:
   - **Risk**: Tests require constant updates
   - **Mitigation**: Good test design, stable APIs, clear test structure
