# Implement Session Registration Route

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `POST /agent-conversations/api/:id/session` in a new route file.
- Validate body contains `sessionUrl` and optional metadata as per plan.
- Write to Redis via `session-store` with TTL = 10 minutes.
- Return `{ success: true, message: "Session registered" }`.
- Ensure route is behind `ELEVENLABS_AGENT_ENABLED` flag.

## Desired Outcomes

### Primary Outcomes
1. **Session Registration**: Frontend can register active ElevenLabs sessions with the backend, enabling callback routing.

2. **Data Persistence**: Session data stored in Redis with proper TTL for callback system to use.

3. **Validation**: Request validation ensures data integrity and prevents errors.

4. **Feature Flag Protection**: Route disabled when feature is off.

### Success Criteria
- Sessions can be registered successfully
- Session data stored correctly in Redis
- TTL of 10 minutes enforced
- Validation rejects invalid requests
- Feature flag properly gates route
- Clear error messages
- Tests cover all scenarios

## User Stories

### As a Frontend Developer
- **Story 1**: I want to register sessions so that callbacks can route to the correct agent.
- **Story 2**: I want clear error messages when registration fails so that I can debug issues.

### As a System Administrator
- **Story 3**: I want sessions to expire automatically so that Redis doesn't fill up.

## Suggested Automated Tests

### Unit Tests
1. **Success Path Tests**:
   ```typescript
   describe('POST /agent-conversations/api/:id/session', () => {
     it('registers session successfully', async () => {
       const sessionData = {
         sessionUrl: 'wss://...',
         expiresAt: '2024-01-01T00:10:00Z'
       };
       
       const response = await request(app)
         .post('/agent-conversations/api/conv-123/session')
         .send(sessionData)
         .expect(200);
       
       expect(response.body).toHaveProperty('success', true);
       // Verify stored in Redis
     });
   });
   ```

2. **Validation Tests**:
   ```typescript
   describe('Validation', () => {
     it('rejects missing sessionUrl', async () => {
       await request(app)
         .post('/agent-conversations/api/conv-123/session')
         .send({})
         .expect(400);
     });
   });
   ```

3. **TTL Tests**:
   ```typescript
   describe('TTL', () => {
     it('sets 10-minute TTL', async () => {
       // Verify TTL in Redis
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Session Data Loss**:
   - **Risk**: Sessions not stored correctly, breaking callbacks
   - **Mitigation**: Comprehensive tests, validation, error handling

2. **TTL Mismatches**:
   - **Risk**: Incorrect TTL causing sessions to expire too soon or persist too long
   - **Mitigation**: Explicit TTL values, tests, monitoring

### Medium Risk
3. **Validation Gaps**:
   - **Risk**: Invalid data stored causing callback failures
   - **Mitigation**: Strict validation, schema validation, tests

4. **Concurrent Registrations**:
   - **Risk**: Race conditions with multiple session registrations
   - **Mitigation**: Atomic operations, proper locking, tests

### Low Risk
5. **Route Conflicts**:
   - **Risk**: Route conflicts with other endpoints
   - **Mitigation**: Clear route naming, testing, documentation
