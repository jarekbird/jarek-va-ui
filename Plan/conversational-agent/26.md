# Implement Session Registration from Voice Service

## Scope
`jarek-va-ui`, `elevenlabs-agent`.

## Subtasks
- On successful connection (`onConnect`), extract `sessionUrl` (or equivalent push-capable payload) from the ElevenLabs session object.
- Call `registerSession(conversationId, { sessionUrl, ... })` to persist session in Redis.
- Handle registration failures (e.g., show toast, disable cursor-powered tools).

## Desired Outcomes

### Primary Outcomes
1. **Automatic Session Registration**: When voice session connects, session data automatically registered with backend for callback routing.

2. **Payload Extraction**: Correct extraction of push-capable payload from ElevenLabs SDK session object.

3. **Error Handling**: Graceful handling of registration failures with user feedback.

4. **Feature Degradation**: When registration fails, cursor-powered tools disabled with clear messaging.

### Success Criteria
- Sessions automatically registered on connect
- Correct payload extracted from SDK
- Registration failures handled gracefully
- User notified of registration status
- Cursor tools disabled when registration fails
- Tests verify registration flow
- Tests verify error handling

## User Stories

### As a User
- **Story 1**: I want my voice session registered automatically so that cursor tasks can notify me when complete.
- **Story 2**: I want clear feedback when registration fails so that I understand why cursor tools aren't working.

### As a Developer
- **Story 3**: I want automatic registration so that I don't have to manually register sessions.

## Suggested Automated Tests

### Unit Tests
1. **Registration Flow Tests**:
   ```typescript
   describe('Session Registration', () => {
     it('registers session on connect', async () => {
       const mockRegister = jest.spyOn(api, 'registerSession').mockResolvedValue({ success: true });
       
       const service = new ElevenLabsVoiceService();
       service.on('connect', () => {
         // Registration should happen automatically
       });
       
       await service.startVoiceSession('agent-123');
       await waitFor(() => {
         expect(mockRegister).toHaveBeenCalled();
       });
     });
     
     it('extracts correct payload from SDK', () => {
       // Verify payload extraction logic
     });
   });
   ```

2. **Error Handling Tests**:
   ```typescript
   describe('Registration Errors', () => {
     it('handles registration failure', async () => {
       jest.spyOn(api, 'registerSession').mockRejectedValue(new Error('Failed'));
       
       const service = new ElevenLabsVoiceService();
       await service.startVoiceSession('agent-123');
       
       // Verify error handling, toast shown, tools disabled
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Payload Extraction Errors**:
   - **Risk**: Incorrect payload extracted, breaking callbacks
   - **Mitigation**: Test payload extraction, validate structure, document SDK structure

2. **Registration Failures**:
   - **Risk**: Registration fails silently, breaking callback system
   - **Mitigation**: Error handling, user feedback, monitoring, retry logic

### Medium Risk
3. **Timing Issues**:
   - **Risk**: Registration happens before connection fully established
   - **Mitigation**: Wait for onConnect event, validate connection state

4. **Network Failures**:
   - **Risk**: Network issues preventing registration
   - **Mitigation**: Retry logic, error handling, user feedback

### Low Risk
5. **Multiple Registration Attempts**:
   - **Risk**: Multiple registrations for same session
   - **Mitigation**: Idempotent registration, check existing session
