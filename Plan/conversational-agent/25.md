# Implement Basic Voice Service Connection Flow

## Scope
`jarek-va-ui`.

## Subtasks
- Implement `src/services/elevenlabs-voice.ts`:
  - Initialize ElevenLabs SDK and create a connection to the agent.
  - Manage microphone permission requests.
  - Expose `startVoiceSession` and `endVoiceSession`.
- Integrate use of `getVoiceSignedUrl` when agent is private.
- Ensure service respects `VITE_ELEVENLABS_AGENT_ENABLED` flag.
- Add unit tests (or integration-style tests with a mocked SDK) to verify basic connect/disconnect flows and state transitions.

## Desired Outcomes

### Primary Outcomes
1. **Voice Connection**: Users can start and stop voice sessions with ElevenLabs agents.

2. **Microphone Management**: Proper handling of microphone permissions with user-friendly error messages.

3. **Private Agent Support**: Signed URL fetching and usage for private agents.

4. **Feature Flag Integration**: Service respects feature flag, disabling when flag is off.

5. **State Management**: Proper state transitions during connection lifecycle.

### Success Criteria
- Voice sessions can be started and stopped
- Microphone permissions handled correctly
- Signed URLs fetched for private agents
- Feature flag properly respected
- State transitions work correctly
- Error handling for connection failures
- Tests cover connect/disconnect flows
- Tests verify state transitions

## User Stories

### As a User
- **Story 1**: I want to start a voice session so that I can talk to the agent.
- **Story 2**: I want clear permission requests so that I understand why mic access is needed.
- **Story 3**: I want to stop voice sessions so that I can end conversations.

### As a Developer
- **Story 4**: I want a working voice service so that I can build voice features.
- **Story 5**: I want feature flag support so that I can disable features safely.

## Suggested Automated Tests

### Unit Tests
1. **Connection Flow Tests**:
   ```typescript
   describe('Voice Service Connection', () => {
     it('starts voice session', async () => {
       const service = new ElevenLabsVoiceService();
       await service.startVoiceSession('agent-123');
       expect(service.getConnectionStatus()).toBe('connected');
     });
     
     it('ends voice session', async () => {
       await service.startVoiceSession('agent-123');
       await service.endVoiceSession();
       expect(service.getConnectionStatus()).toBe('disconnected');
     });
   });
   ```

2. **Permission Tests**:
   ```typescript
   describe('Microphone Permissions', () => {
     it('requests microphone permission', async () => {
       const mockGetUserMedia = jest.fn();
       navigator.mediaDevices.getUserMedia = mockGetUserMedia;
       
       await service.startVoiceSession('agent-123');
       expect(mockGetUserMedia).toHaveBeenCalled();
     });
     
     it('handles permission denial', async () => {
       // Test permission denied flow
     });
   });
   ```

3. **Feature Flag Tests**:
   ```typescript
   describe('Feature Flag', () => {
     it('respects disabled flag', async () => {
       process.env.VITE_ELEVENLABS_AGENT_ENABLED = 'false';
       await expect(service.startVoiceSession('agent-123'))
         .rejects.toThrow('Feature disabled');
     });
   });
   ```

4. **State Transition Tests**:
   ```typescript
   describe('State Transitions', () => {
     it('transitions: disconnected → connecting → connected', async () => {
       // Verify state transitions
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Microphone Permission Issues**:
   - **Risk**: Users deny permissions, breaking voice functionality
   - **Mitigation**: Clear permission requests, helpful error messages, fallback options

2. **Connection Failures**:
   - **Risk**: SDK connection failures causing poor UX
   - **Mitigation**: Error handling, retry logic, user-friendly messages

### Medium Risk
3. **Signed URL Expiration**:
   - **Risk**: Signed URLs expire during session, breaking connection
   - **Mitigation**: URL renewal logic, expiration handling (covered in Task 27)

4. **State Machine Bugs**:
   - **Risk**: Invalid state transitions causing service to get stuck
   - **Mitigation**: State validation, comprehensive tests, clear state machine

### Low Risk
5. **SDK Version Issues**:
   - **Risk**: SDK version incompatible or has bugs
   - **Mitigation**: Pin versions, test thoroughly, monitor SDK updates
