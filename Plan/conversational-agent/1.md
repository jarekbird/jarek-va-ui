# Create and Align Environment & Feature Flags

## Scope
All services (`jarek-va-ui`, `cursor-runner`, `elevenlabs-agent`).

## Subtasks
- Add `VITE_ELEVENLABS_AGENT_ENABLED` (default `false`) to `jarek-va-ui` env and document its use.
- Add `ELEVENLABS_AGENT_ENABLED` (default `false`) to `cursor-runner` env and Docker configuration.
- Add `ELEVENLABS_AGENT_ENABLED` (default `false`) to `elevenlabs-agent` service env and Docker configuration.
- Add `VITE_ELEVENLABS_AGENT_URL` and, if needed, `VITE_ELEVENLABS_AGENT_ID`, `VITE_ELEVENLABS_AGENT_PUBLIC` to `jarek-va-ui` env.
- Add `ELEVENLABS_API_KEY`, `ELEVENLABS_AGENT_ID`, `WEBHOOK_SECRET`, `CURSOR_RUNNER_URL`, `REDIS_URL` to `elevenlabs-agent` env (with safe defaults for dev).
- Ensure shared Redis instance is available to `cursor-runner` and `elevenlabs-agent` via Docker network.

## Desired Outcomes

### Primary Outcomes
1. **Feature Flag Infrastructure**: All three services have a consistent feature flag mechanism that allows the ElevenLabs agent integration to be deployed in a disabled state (dark release), enabling safe infrastructure deployment without exposing features to users.

2. **Environment Configuration**: Complete environment variable setup across all services with:
   - Clear documentation of each variable's purpose
   - Safe default values (all flags default to `false` for safety)
   - Proper configuration for development, staging, and production environments

3. **Service Connectivity**: All services can communicate with required dependencies:
   - `elevenlabs-agent` can reach `cursor-runner` via HTTP
   - Both `cursor-runner` and `elevenlabs-agent` share the same Redis instance
   - `jarek-va-ui` can reach `elevenlabs-agent` via Traefik routing

4. **Security Baseline**: Sensitive credentials (API keys, webhook secrets) are properly configured and never exposed in logs or client-side code.

### Success Criteria
- Feature flags can be toggled independently per service without requiring code changes
- All environment variables are documented in README files
- Docker compose configuration includes all required environment variables
- Services can start successfully with flags disabled (default state)
- No hardcoded secrets or API keys in source code

## User Stories

### As a Developer
- **Story 1**: I want to deploy new code with ElevenLabs features disabled so that I can safely roll out infrastructure changes without exposing incomplete features to users.
- **Story 2**: I want clear documentation of all environment variables so that I can quickly set up a new development environment.
- **Story 3**: I want feature flags to default to `false` so that accidental feature exposure doesn't occur in production.

### As a DevOps Engineer
- **Story 4**: I want to enable features gradually (dev → staging → production) so that I can validate functionality in lower environments before production rollout.
- **Story 5**: I want all services to share the same Redis instance so that session data is consistent across service instances.

### As a System Administrator
- **Story 6**: I want environment variables to have safe defaults so that services start correctly even if configuration is incomplete.

## Suggested Automated Tests

### Unit Tests
1. **Feature Flag Helper Tests** (`jarek-va-ui`):
   ```typescript
   describe('isElevenLabsEnabled', () => {
     it('returns false when VITE_ELEVENLABS_AGENT_ENABLED is not set', () => {
       // Test default behavior
     });
     it('returns true when VITE_ELEVENLABS_AGENT_ENABLED is "true"', () => {
       // Test enabled state
     });
     it('returns false when VITE_ELEVENLABS_AGENT_ENABLED is "false"', () => {
       // Test explicit disabled state
     });
   });
   ```

2. **Environment Variable Validation Tests** (`elevenlabs-agent`):
   ```typescript
   describe('Environment Configuration', () => {
     it('throws error if REDIS_URL is missing', () => {
       // Test required variables
     });
     it('uses default CURSOR_RUNNER_URL if not provided', () => {
       // Test default values
     });
     it('never logs sensitive variables', () => {
       // Test that ELEVENLABS_API_KEY and WEBHOOK_SECRET are not logged
     });
   });
   ```

### Integration Tests
3. **Docker Compose Configuration Test**:
   ```bash
   # Test that all services start with flags disabled
   docker-compose up -d
   # Verify services are running
   # Verify feature is disabled in UI
   # Verify webhook returns 503 when disabled
   ```

4. **Redis Connectivity Test**:
   ```typescript
   describe('Redis Connection', () => {
     it('connects to shared Redis instance', async () => {
       // Test that cursor-runner and elevenlabs-agent can both connect
     });
     it('can read/write to same Redis instance', async () => {
       // Test data sharing between services
     });
   });
   ```

### E2E Tests
5. **Feature Flag Toggle Test**:
   - Start services with flags disabled
   - Verify UI shows no agent-related features
   - Toggle flags to enabled
   - Restart services
   - Verify agent features appear

## Inherent Risks

### High Risk
1. **Secret Exposure**: 
   - **Risk**: API keys or webhook secrets accidentally committed to version control or logged
   - **Mitigation**: Use environment variables only, add pre-commit hooks to detect secrets, implement secret scanning in CI/CD

2. **Feature Flag Misconfiguration**:
   - **Risk**: Flags enabled in production before feature is ready, causing user-facing errors
   - **Mitigation**: Default all flags to `false`, require explicit opt-in, add monitoring/alerts for unexpected feature usage

### Medium Risk
3. **Environment Variable Mismatch**:
   - **Risk**: Different services using different variable names or formats, causing integration failures
   - **Mitigation**: Centralize variable definitions, use TypeScript types for validation, add startup validation

4. **Redis Connection Issues**:
   - **Risk**: Services unable to connect to shared Redis, causing session/task tracking failures
   - **Mitigation**: Add health checks, implement connection retry logic, provide clear error messages

5. **Docker Network Configuration**:
   - **Risk**: Services unable to communicate due to network misconfiguration
   - **Mitigation**: Use Docker Compose networks, verify connectivity in health checks, document network topology

### Low Risk
6. **Documentation Drift**:
   - **Risk**: Environment variable documentation becomes outdated
   - **Mitigation**: Keep documentation in same directory as code, add validation scripts, review in PRs

7. **Default Value Assumptions**:
   - **Risk**: Developers assume different default values than configured
   - **Mitigation**: Explicit defaults in code, clear documentation, unit tests for defaults
