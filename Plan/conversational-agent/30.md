# Integrate Voice Service with Dashboard (VoiceIndicator + AgentChatPanel)

## Scope
`jarek-va-ui`.

## Subtasks
- Wire `ElevenLabsVoiceService` into the `Dashboard` component and `AgentChatPanel`.
- Add voice-mode state and connection/agent-mode state to `AgentChatPanel` and expose them to `VoiceIndicator`.
- Implement the `VoiceIndicator` circle animation (idle/listening/speaking/connecting/error) driven by voice service state.
- Wire voice session messages into the agent conversation message list (via `AgentConversationDetails` or equivalent, embedded inside `AgentChatPanel`).
- Respect `VITE_ELEVENLABS_AGENT_ENABLED` by hiding voice-related controls and the dashboard route when disabled.

## Desired Outcomes

### Primary Outcomes
1. **Dashboard Voice Integration**: Voice service fully integrated into the Dashboard layout with VoiceIndicator in upper left and voice controls in AgentChatPanel.

2. **Voice Indicator Animation**: Pulsing circle indicator (like ChatGPT phone app) that lights up when agent is talking, showing different states (idle/listening/speaking/connecting/error).

3. **Status Indicators**: Clear visual indicators showing connection status and agent mode in both VoiceIndicator and AgentChatPanel.

4. **Message Integration**: Voice messages appear in agent conversation history alongside text messages within the AgentChatPanel.

5. **Feature Flag Integration**: Dashboard and voice controls hidden when feature is disabled.

6. **User Experience**: Smooth, intuitive voice interaction within the Dashboard layout, with all three sections (voice indicator, agent chat, note-taking) visible simultaneously on desktop.

### Success Criteria
- Voice controls visible and functional
- Status indicators show correct state
- Mic activity visualization works
- Voice messages appear in conversation
- Feature flag properly hides controls
- UI matches design system
- Accessible (keyboard, screen readers)
- Tests cover UI integration

## User Stories

### As a User
- **Story 1**: I want voice controls so that I can easily start and stop voice sessions.
- **Story 2**: I want to see connection status so that I know if voice is working.
- **Story 3**: I want voice messages in conversation history so that I can see what was said.

### As a Developer
- **Story 4**: I want integrated voice UI so that users have a seamless experience.

## Suggested Automated Tests

### Component Tests
1. **Voice Controls Tests**:
   ```typescript
   describe('Voice Controls', () => {
     it('renders start/stop buttons', () => {
       render(<AgentConversationDetails conversation={mockConv} />);
       expect(screen.getByText('Start Voice')).toBeInTheDocument();
     });
     
     it('starts voice session on button click', async () => {
       const mockStart = jest.fn();
       render(<AgentConversationDetails conversation={mockConv} />);
       fireEvent.click(screen.getByText('Start Voice'));
       expect(mockStart).toHaveBeenCalled();
     });
   });
   ```

2. **Status Indicator Tests**:
   ```typescript
   describe('Status Indicators', () => {
     it('shows connection status', () => {
       // Test status display
     });
     
     it('shows agent mode', () => {
       // Test mode indicator
     });
   });
   ```

3. **Feature Flag Tests**:
   ```typescript
   describe('Feature Flag', () => {
     it('hides controls when disabled', () => {
       process.env.VITE_ELEVENLABS_AGENT_ENABLED = 'false';
       render(<AgentConversationDetails conversation={mockConv} />);
       expect(screen.queryByText('Start Voice')).not.toBeInTheDocument();
     });
   });
   ```

## Inherent Risks

### Medium Risk
1. **UI State Management**:
   - **Risk**: Voice state not properly synced with UI, causing inconsistencies
   - **Mitigation**: Proper state management, React hooks, state synchronization

2. **Performance Issues**:
   - **Risk**: Voice UI causing performance problems
   - **Mitigation**: Optimize rendering, use memoization, performance testing

3. **Accessibility Gaps**:
   - **Risk**: Voice controls not accessible to all users
   - **Mitigation**: ARIA labels, keyboard navigation, screen reader testing

### Low Risk
4. **Styling Inconsistencies**:
   - **Risk**: Voice controls don't match design system
   - **Mitigation**: Use design system components, visual QA, style guide

5. **Message Rendering Issues**:
   - **Risk**: Voice messages not rendering correctly
   - **Mitigation**: Test message rendering, handle edge cases, visual QA
