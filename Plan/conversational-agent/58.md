# Step 58: Implement Network Failure Awareness

**Phase**: Phase 4 â€“ Polish, Error Handling, Testing, Documentation

## Description

Implement network-failure and session-expiry awareness in UI:
- Display messages like "Connection lost, attempting to reconnect..." and "Agent session not active, please reconnect voice."

## Detailed Desired Outcomes

### Connection State Awareness

**Connection States:**
- `connected` - Normal operation
- `connecting` - Attempting to connect
- `disconnected` - Not connected
- `reconnecting` - Attempting to reconnect
- `error` - Connection error
- `expired` - Session expired

**State Messages:**
- Connected: "Connected" or no message
- Connecting: "Connecting..."
- Disconnected: "Disconnected"
- Reconnecting: "Connection lost, attempting to reconnect..."
- Error: "Connection error. Please reconnect."
- Expired: "Agent session expired. Please reconnect voice."

### UI Updates

**Status Display:**
- Show connection status indicator
- Update status in real-time
- Show appropriate message for each state
- Color-code status (green/red/yellow)

**User Actions:**
- Enable/disable actions based on state
- Show reconnect option when needed
- Guide user on what to do

**Automatic Handling:**
- Show reconnection attempts
- Update status as reconnection progresses
- Hide status when connected

## User Stories

**As a user**, I want:
- Clear feedback on connection status
- To know when connection is lost
- To know when reconnecting
- Guidance on what to do

**As a developer**, I want:
- Simple state management
- Easy to update status
- Consistent status display

**As a system**, I want:
- Reliable status updates
- Clear user feedback
- Proper state transitions

## Suggested Automated Tests

### Status Awareness Tests

```typescript
describe('Network Failure Awareness', () => {
  it('should show reconnecting message', () => {
    render(<VoiceControls connectionStatus="reconnecting" />);
    expect(screen.getByText(/attempting to reconnect/i)).toBeInTheDocument();
  });

  it('should show expired session message', () => {
    render(<VoiceControls connectionStatus="expired" />);
    expect(screen.getByText(/session expired/i)).toBeInTheDocument();
  });

  it('should update status in real-time', async () => {
    const { rerender } = render(
      <VoiceControls connectionStatus="connected" />
    );

    rerender(<VoiceControls connectionStatus="reconnecting" />);
    expect(screen.getByText(/reconnecting/i)).toBeInTheDocument();

    rerender(<VoiceControls connectionStatus="connected" />);
    expect(screen.queryByText(/reconnecting/i)).not.toBeInTheDocument();
  });
});
```

## Risks

### Low Risk
- **Status not updating**: Status might not update correctly
  - **Mitigation**: Proper state management, test state transitions
  - **Detection**: Integration tests, user reports

- **Message clarity**: Messages might not be clear
  - **Mitigation**: Clear, actionable messages
  - **Detection**: User testing, feedback

### Medium Risk
- **State synchronization**: UI state might not match service state
  - **Mitigation**: Proper event handling, update state on events
  - **Detection**: Integration tests, state monitoring

### High Risk
- **None identified** - Status awareness with low risk

## Implementation Notes

- Detect connection loss
- Show reconnection status
- Detect session expiry
- Display appropriate messages
- Update UI based on connection state
- Provide clear user feedback
- Handle edge cases gracefully
- Test all state transitions
- Make messages actionable
