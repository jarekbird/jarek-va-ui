# Implement Basic Express Server and Health Check

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `src/server.ts` with:
  - JSON body parsing.
  - Basic logging (or reuse existing middleware style from other services).
  - `GET /health` returning simple JSON and Redis connectivity status.
- Wire environment variable loading (e.g., `dotenv` in development).
- Add graceful shutdown handling for Redis and HTTP server.

## Desired Outcomes

### Primary Outcomes
1. **Working HTTP Server**: Express server that can handle requests, parse JSON bodies, and respond appropriately.

2. **Health Monitoring**: Health check endpoint that reports service status and dependency connectivity, enabling monitoring and orchestration.

3. **Graceful Shutdown**: Proper cleanup on shutdown to prevent data loss, incomplete requests, or resource leaks.

4. **Environment Configuration**: Proper loading of environment variables for different deployment contexts.

5. **Logging Infrastructure**: Basic logging setup for debugging and monitoring.

### Success Criteria
- Server starts and listens on configured port
- Health endpoint returns 200 when healthy
- Health endpoint reports Redis connectivity status
- JSON body parsing works correctly
- Graceful shutdown closes connections properly
- Environment variables loaded correctly
- Logging outputs to console/logs
- Follows patterns from cursor-runner service

## User Stories

### As a Developer
- **Story 1**: I want a working server so that I can develop and test endpoints.
- **Story 2**: I want a health check so that I can verify the service is running correctly.
- **Story 3**: I want graceful shutdown so that deployments don't drop requests.

### As a DevOps Engineer
- **Story 4**: I want health checks so that I can monitor service health and implement auto-scaling.
- **Story 5**: I want proper logging so that I can debug issues in production.

### As a System Administrator
- **Story 6**: I want Redis connectivity status in health checks so that I can detect connection issues early.

## Suggested Automated Tests

### Unit Tests
1. **Server Initialization Tests**:
   ```typescript
   describe('Server Initialization', () => {
     it('starts server on configured port', async () => {
       const server = await startServer();
       expect(server.listening).toBe(true);
       await server.close();
     });
     
     it('loads environment variables', () => {
       expect(process.env.PORT).toBeDefined();
       expect(process.env.REDIS_URL).toBeDefined();
     });
   });
   ```

2. **Health Check Tests**:
   ```typescript
   describe('GET /health', () => {
     it('returns 200 when healthy', async () => {
       const response = await request(app).get('/health');
       expect(response.status).toBe(200);
       expect(response.body).toHaveProperty('status', 'healthy');
     });
     
     it('reports Redis connectivity', async () => {
       const response = await request(app).get('/health');
       expect(response.body).toHaveProperty('redis', 'connected');
     });
     
     it('reports Redis disconnection', async () => {
       // Mock Redis disconnect
       const response = await request(app).get('/health');
       expect(response.body).toHaveProperty('redis', 'disconnected');
     });
   });
   ```

3. **JSON Parsing Tests**:
   ```typescript
   describe('JSON Body Parsing', () => {
     it('parses JSON request bodies', async () => {
       const response = await request(app)
         .post('/test')
         .send({ test: 'data' })
         .expect(200);
       // Verify body parsed correctly
     });
   });
   ```

### Integration Tests
4. **Graceful Shutdown Tests**:
   ```typescript
   describe('Graceful Shutdown', () => {
     it('closes HTTP server', async () => {
       const server = await startServer();
       await shutdownServer(server);
       expect(server.listening).toBe(false);
     });
     
     it('closes Redis connection', async () => {
       // Verify Redis connection closed
     });
     
     it('waits for in-flight requests', async () => {
       // Test that ongoing requests complete before shutdown
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Graceful Shutdown Failures**:
   - **Risk**: Server shutdown doesn't wait for requests, causing data loss or errors
   - **Mitigation**: Proper signal handling, request tracking, timeout mechanisms

2. **Health Check False Positives**:
   - **Risk**: Health check reports healthy when service is actually broken
   - **Mitigation**: Comprehensive health checks, dependency validation, realistic test scenarios

### Medium Risk
3. **Port Conflicts**:
   - **Risk**: Server fails to start due to port already in use
   - **Mitigation**: Configurable port, clear error messages, port validation

4. **Environment Variable Issues**:
   - **Risk**: Missing or incorrect environment variables causing runtime errors
   - **Mitigation**: Validation on startup, clear error messages, documentation

5. **Logging Performance**:
   - **Risk**: Excessive logging causing performance issues
   - **Mitigation**: Log levels, structured logging, performance monitoring

### Low Risk
6. **Middleware Order Issues**:
   - **Risk**: Incorrect middleware order causing request handling problems
   - **Mitigation**: Follow Express best practices, test request flow, documentation

7. **Development vs Production Differences**:
   - **Risk**: Different behavior in dev vs prod causing deployment issues
   - **Mitigation**: Consistent configuration, environment-specific settings, testing in both
