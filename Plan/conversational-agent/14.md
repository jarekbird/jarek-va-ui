# Implement ElevenLabs API Client

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `services/elevenlabs-api.ts` with:
  - `getSignedUrl(agentId?: string)` calling the ElevenLabs signed URL endpoint.
  - Typed responses and robust error handling (timeout, non-200 status).
- Ensure API key is passed from `ELEVENLABS_API_KEY` and never logged.
- Add unit tests for success and error paths (mock HTTP).

## Desired Outcomes

### Primary Outcomes
1. **Signed URL Generation**: Reliable function to fetch signed URLs from ElevenLabs API for private agent connections.

2. **Security**: API key properly secured, never exposed in logs or error messages.

3. **Error Handling**: Robust handling of network errors, timeouts, and API errors with appropriate retry logic.

4. **Type Safety**: Typed responses matching ElevenLabs API contracts.

### Success Criteria
- Signed URLs can be fetched successfully
- API key never logged or exposed
- Timeout errors handled gracefully
- Non-200 status codes handled
- Typed response structures
- Tests cover success and error paths
- Retry logic for transient failures

## User Stories

### As a Developer
- **Story 1**: I want a typed API client so that I can easily call ElevenLabs endpoints with type safety.
- **Story 2**: I want secure API key handling so that credentials are never exposed.

### As a System Administrator
- **Story 3**: I want robust error handling so that API failures don't crash the service.

## Suggested Automated Tests

### Unit Tests
1. **Success Path Tests**:
   ```typescript
   describe('ElevenLabs API Client', () => {
     it('fetches signed URL successfully', async () => {
       mockFetch.mockResolvedValue({
         ok: true,
         json: async () => ({ signed_url: 'wss://...', expires_at: '...' })
       });
       
       const result = await elevenlabsApi.getSignedUrl('agent-123');
       expect(result.signedUrl).toBeDefined();
       expect(result.expiresAt).toBeDefined();
     });
   });
   ```

2. **Error Handling Tests**:
   ```typescript
   describe('Error Handling', () => {
     it('handles network timeouts', async () => {
       mockFetch.mockRejectedValue(new Error('Timeout'));
       await expect(elevenlabsApi.getSignedUrl()).rejects.toThrow();
     });
     
     it('handles 401 unauthorized', async () => {
       mockFetch.mockResolvedValue({ ok: false, status: 401 });
       await expect(elevenlabsApi.getSignedUrl()).rejects.toThrow('Unauthorized');
     });
     
     it('handles 500 server errors', async () => {
       // Test server error handling
     });
   });
   ```

3. **Security Tests**:
   ```typescript
   describe('Security', () => {
     it('never logs API key', () => {
       const logSpy = jest.spyOn(console, 'log');
       elevenlabsApi.getSignedUrl();
       expect(logSpy).not.toHaveBeenCalledWith(
         expect.stringContaining(process.env.ELEVENLABS_API_KEY)
       );
     });
   });
   ```

## Inherent Risks

### High Risk
1. **API Key Exposure**:
   - **Risk**: API key logged or exposed in error messages
   - **Mitigation**: Never log API key, sanitize error messages, code review, security audit

2. **API Rate Limiting**:
   - **Risk**: Too many requests causing rate limit errors
   - **Mitigation**: Implement rate limiting, caching, exponential backoff

### Medium Risk
3. **Network Failures**:
   - **Risk**: Unreliable network causing frequent failures
   - **Mitigation**: Retry logic, timeout handling, circuit breaker pattern

4. **API Contract Changes**:
   - **Risk**: ElevenLabs API changes breaking integration
   - **Mitigation**: Version pinning, contract tests, monitoring, documentation

### Low Risk
5. **Response Parsing Errors**:
   - **Risk**: Unexpected response format causing parsing errors
   - **Mitigation**: Schema validation, type guards, error handling
