# Add Repository File Browser Backend Endpoint

## Scope
`cursor-runner`.

## Subtasks
- Implement `GET /repositories/api/:repository/files` endpoint returning a `FileNode[]` tree.
- Re-use existing filesystem utilities (e.g., FilesystemService) to build a nested directory tree.
- Filter out `.git`, `node_modules`, and other heavy/ignored directories.
- Add unit tests for the file tree generation (including large/empty directories).

## Desired Outcomes

### Primary Outcomes
1. **File Tree API**: RESTful endpoint that returns a hierarchical file structure for a given repository, enabling the frontend to display repository contents.

2. **Performance**: Efficient file tree generation that handles large repositories without excessive memory usage or slow response times.

3. **Filtering**: Intelligent filtering of unnecessary directories (`.git`, `node_modules`, build artifacts) to reduce payload size and improve UX.

4. **Reusability**: Leverages existing filesystem utilities to avoid code duplication and maintain consistency.

5. **Test Coverage**: Comprehensive tests ensuring correct tree structure, filtering, and edge cases.

### Success Criteria
- Endpoint returns correct nested file tree structure
- Large repositories handled efficiently (< 2s response time for typical repos)
- Filtered directories excluded from response
- Empty directories handled correctly
- Deeply nested structures supported
- Error handling for invalid repository names
- Tests cover all edge cases

## User Stories

### As a User
- **Story 1**: I want to see the file structure of the repository I'm working on so that I can understand the codebase organization.
- **Story 2**: I want the file browser to load quickly even for large repositories so that I'm not waiting.

### As a Developer
- **Story 3**: I want a clean API endpoint for file trees so that I can easily integrate it into the frontend.
- **Story 4**: I want filtered directories excluded so that I don't see irrelevant files like `node_modules`.

### As a System Administrator
- **Story 5**: I want the endpoint to handle errors gracefully so that invalid repository names don't crash the service.

## Suggested Automated Tests

### Unit Tests
1. **File Tree Generation Tests**:
   ```typescript
   describe('File Tree Generation', () => {
     it('generates nested tree structure', () => {
       const tree = generateFileTree('/test-repo');
       expect(tree).toHaveProperty('children');
       expect(tree.children[0]).toHaveProperty('type', 'directory');
     });
     
     it('filters out .git directory', () => {
       const tree = generateFileTree('/test-repo');
       const gitDir = findNode(tree, '.git');
       expect(gitDir).toBeUndefined();
     });
     
     it('filters out node_modules', () => {
       const tree = generateFileTree('/test-repo');
       const nodeModules = findNode(tree, 'node_modules');
       expect(nodeModules).toBeUndefined();
     });
     
     it('handles empty directories', () => {
       const tree = generateFileTree('/empty-repo');
       expect(tree.children).toEqual([]);
     });
     
     it('handles deeply nested structures', () => {
       const tree = generateFileTree('/deep-repo');
       const depth = calculateMaxDepth(tree);
       expect(depth).toBeGreaterThan(10);
     });
   });
   ```

2. **Endpoint Tests**:
   ```typescript
   describe('GET /repositories/api/:repository/files', () => {
     it('returns file tree for valid repository', async () => {
       const response = await request(app)
         .get('/repositories/api/test-repo/files')
         .expect(200);
       
       expect(response.body).toHaveProperty('files');
       expect(Array.isArray(response.body.files)).toBe(true);
     });
     
     it('returns 404 for invalid repository', async () => {
       await request(app)
         .get('/repositories/api/invalid-repo/files')
         .expect(404);
     });
     
     it('filters excluded directories', async () => {
       const response = await request(app)
         .get('/repositories/api/test-repo/files')
         .expect(200);
       
       const hasNodeModules = response.body.files.some(
         (file: FileNode) => file.path.includes('node_modules')
       );
       expect(hasNodeModules).toBe(false);
     });
   });
   ```

### Performance Tests
3. **Load Tests**:
   ```typescript
   describe('Performance', () => {
     it('handles large repositories efficiently', async () => {
       const start = Date.now();
       await request(app)
         .get('/repositories/api/large-repo/files')
         .expect(200);
       const duration = Date.now() - start;
       expect(duration).toBeLessThan(2000); // 2 seconds
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Performance Issues with Large Repos**:
   - **Risk**: Endpoint slow or crashes on repositories with thousands of files
   - **Mitigation**: Implement pagination or lazy loading, cache results, optimize tree building, set timeouts

2. **Memory Exhaustion**:
   - **Risk**: Building full file tree in memory causes OOM errors
   - **Mitigation**: Stream tree building, limit depth, implement pagination, monitor memory usage

### Medium Risk
3. **Incomplete Filtering**:
   - **Risk**: Important directories filtered or irrelevant ones included
   - **Mitigation**: Comprehensive filter list, configurable filters, test with real repositories

4. **Path Traversal Vulnerabilities**:
   - **Risk**: Malicious repository names allowing access to files outside repository
   - **Mitigation**: Validate repository names, sanitize paths, use absolute paths with validation

5. **Race Conditions**:
   - **Risk**: Repository structure changes during tree building causing inconsistencies
   - **Mitigation**: Handle errors gracefully, validate tree structure, retry on failures

### Low Risk
6. **Encoding Issues**:
   - **Risk**: Special characters in file names causing encoding problems
   - **Mitigation**: Proper UTF-8 handling, test with various file names, URL encoding

7. **Symlink Handling**:
   - **Risk**: Symlinks causing infinite loops or incorrect trees
   - **Mitigation**: Detect and handle symlinks, limit follow depth, document behavior
