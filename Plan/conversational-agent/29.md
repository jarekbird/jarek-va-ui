# Handle Safari, Mobile, and Multi-Tab Voice Edge Cases

## Scope
`jarek-va-ui`.

## Subtasks
- Detect Safari and adjust WebRTC/connection parameters as required.
- Detect tab visibility changes and pause/resume sessions when tab is backgrounded.
- Track active session in `localStorage`/`sessionStorage` to warn when multiple tabs use the same agent.
- Display human-friendly messages for these edge cases.

## Desired Outcomes

### Primary Outcomes
1. **Safari Compatibility**: Voice service works correctly in Safari despite WebRTC quirks.

2. **Mobile Support**: Proper handling of mobile browser limitations (background tab behavior).

3. **Multi-Tab Detection**: Detection and handling of multiple tabs with same agent.

4. **User Experience**: Clear messaging explaining edge case behaviors to users.

### Success Criteria
- Safari voice sessions work correctly
- Tab backgrounding handled gracefully
- Multiple tabs detected and handled
- Clear user messages for edge cases
- Tests cover Safari-specific behavior
- Tests cover mobile scenarios
- Tests cover multi-tab scenarios

## User Stories

### As a User
- **Story 1**: I want voice to work in Safari so that I can use any browser.
- **Story 2**: I want to know when voice pauses due to tab backgrounding so that I understand what's happening.
- **Story 3**: I want warnings about multiple tabs so that I don't have conflicts.

### As a Developer
- **Story 4**: I want browser-specific handling so that the service works across all browsers.

## Suggested Automated Tests

### Unit Tests
1. **Safari Detection Tests**:
   ```typescript
   describe('Safari Handling', () => {
     it('detects Safari browser', () => {
       Object.defineProperty(navigator, 'userAgent', {
         value: 'Safari'
       });
       expect(isSafari()).toBe(true);
     });
     
     it('adjusts WebRTC parameters for Safari', () => {
       // Test Safari-specific configuration
     });
   });
   ```

2. **Tab Visibility Tests**:
   ```typescript
   describe('Tab Visibility', () => {
     it('pauses session when tab backgrounded', () => {
       // Simulate tab visibility change
       // Verify session paused
     });
     
     it('resumes session when tab foregrounded', () => {
       // Test resume logic
     });
   });
   ```

3. **Multi-Tab Tests**:
   ```typescript
   describe('Multi-Tab Detection', () => {
     it('detects multiple tabs', () => {
       // Test localStorage/sessionStorage detection
     });
     
     it('warns user about multiple tabs', () => {
       // Test warning display
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Safari WebRTC Issues**:
   - **Risk**: Safari-specific WebRTC problems breaking voice functionality
   - **Mitigation**: Safari-specific testing, parameter adjustments, fallback options

2. **Mobile Background Limitations**:
   - **Risk**: Mobile browsers killing voice sessions in background
   - **Mitigation**: Proper pause/resume, clear messaging, accept limitations

### Medium Risk
3. **Multi-Tab Conflicts**:
   - **Risk**: Multiple tabs causing session conflicts or errors
   - **Mitigation**: Detection, warnings, disable in one tab, clear messaging

4. **Storage API Limitations**:
   - **Risk**: localStorage/sessionStorage not available or restricted
   - **Mitigation**: Graceful fallback, error handling, alternative detection

### Low Risk
5. **User Confusion**:
   - **Risk**: Edge case messages confusing users
   - **Mitigation**: Clear, friendly messaging, user testing
