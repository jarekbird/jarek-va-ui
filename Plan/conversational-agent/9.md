# Wire File Browser to the Correct Repository Context

## Scope
`cursor-runner`, `jarek-va-ui`.

## Subtasks
- Decide how the repository is identified for a note-taking session (conversation metadata, route param, or global context).
- Ensure `RepositoryFileBrowser` is passed the correct repository identifier.
- Handle cases where repository metadata is missing (render a helpful empty state).

## Desired Outcomes

### Primary Outcomes
1. **Repository Context Resolution**: Clear mechanism for determining which repository to display based on the current note-taking session context.

2. **Data Flow**: Proper data flow from conversation metadata → repository identifier → file tree API call → component display.

3. **Graceful Degradation**: When repository information is unavailable, show helpful empty state rather than errors.

4. **Consistency**: Same repository identification logic used across all components that need repository context.

### Success Criteria
- Repository correctly identified from conversation context
- File browser receives correct repository ID
- Empty state shown when repository unavailable
- Error handling for invalid repository IDs
- Clear user messaging about repository context
- No hardcoded repository values

## User Stories

### As a User
- **Story 1**: I want to see the file structure for the repository I'm currently working on so that it's relevant to my current task.
- **Story 2**: I want a clear message when repository information isn't available so that I understand why the file browser is empty.

### As a Developer
- **Story 3**: I want a consistent way to get repository context so that I don't have to duplicate logic.
- **Story 4**: I want the repository identification to be flexible so that it works with different conversation types.

## Suggested Automated Tests

### Unit Tests
1. **Repository Context Resolution Tests**:
   ```typescript
   describe('Repository Context Resolution', () => {
     it('extracts repository from conversation metadata', () => {
       const conversation = { metadata: { repository: 'test-repo' } };
       const repoId = getRepositoryFromConversation(conversation);
       expect(repoId).toBe('test-repo');
     });
     
     it('falls back to route param if metadata missing', () => {
       const conversation = { metadata: {} };
       const repoId = getRepositoryFromConversation(conversation, 'route-repo');
       expect(repoId).toBe('route-repo');
     });
     
     it('returns null when no repository available', () => {
       const conversation = { metadata: {} };
       const repoId = getRepositoryFromConversation(conversation);
       expect(repoId).toBeNull();
     });
   });
   ```

2. **Component Integration Tests**:
   ```typescript
   describe('RepositoryFileBrowser Integration', () => {
     it('receives repository ID from conversation context', () => {
       const conversation = { metadata: { repository: 'test-repo' } };
       render(<ConversationDetails conversation={conversation} />);
       // Verify RepositoryFileBrowser receives correct prop
     });
     
     it('shows empty state when repository missing', () => {
       const conversation = { metadata: {} };
       render(<ConversationDetails conversation={conversation} />);
       expect(screen.getByText(/no repository/i)).toBeInTheDocument();
     });
   });
   ```

### Integration Tests
3. **End-to-End Context Flow**:
   ```typescript
   describe('Repository Context Flow', () => {
     it('loads file tree for repository from conversation', async () => {
       // Full flow: conversation → repo ID → API call → display
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Repository Context Loss**:
   - **Risk**: Repository information not available when needed, causing file browser to fail
   - **Mitigation**: Multiple fallback strategies, clear error handling, validate context early

2. **Incorrect Repository Display**:
   - **Risk**: Wrong repository shown due to context resolution bugs
   - **Mitigation**: Validate repository IDs, test with various conversation types, clear logging

### Medium Risk
3. **Performance with Context Resolution**:
   - **Risk**: Context resolution adds latency to file browser loading
   - **Mitigation**: Cache repository context, optimize resolution logic, async loading

4. **Empty State UX**:
   - **Risk**: Empty state confusing or unhelpful to users
   - **Mitigation**: Clear messaging, actionable guidance, user testing

### Low Risk
5. **Context Source Confusion**:
   - **Risk**: Multiple sources of repository context causing inconsistency
   - **Mitigation**: Single source of truth, clear priority order, document decision

6. **Migration Issues**:
   - **Risk**: Old conversations without repository metadata causing issues
   - **Mitigation**: Handle missing metadata gracefully, migration script if needed
