# Implement Redis Session Store Service

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `services/session-store.ts`:
  - Functions to set, get, and delete `elevenlabs:session:{conversation_id}` entries with TTL.
  - Store `sessionPayload`, `wsUrl`, `createdAt`, and `ttl` as described in the plan.
- Enforce the "raw push-capable payload" rule and document it in code comments.
- Add tests for TTL behavior and schema backwards compatibility.

## Desired Outcomes

### Primary Outcomes
1. **Session Persistence**: Reliable storage and retrieval of ElevenLabs session data in Redis with proper TTL management.

2. **Data Integrity**: Session data stored correctly with all required fields, ensuring callback system can push updates to agents.

3. **TTL Management**: Automatic expiration of sessions after 10 minutes, preventing stale session data from accumulating.

4. **Type Safety**: Strong TypeScript types ensuring correct session data structure throughout the codebase.

5. **Documentation**: Clear code comments explaining the critical "raw push-capable payload" requirement.

### Success Criteria
- Sessions can be stored and retrieved correctly
- TTL of 10 minutes enforced automatically
- All required fields (sessionPayload, wsUrl, createdAt, ttl) stored
- Sessions automatically expire after TTL
- Missing sessions handled gracefully
- Type-safe session data structures
- Code comments explain payload requirements
- Tests verify TTL behavior
- Tests verify schema compatibility

## User Stories

### As a Developer
- **Story 1**: I want a reliable session store so that I can persist agent sessions for callback routing.
- **Story 2**: I want automatic TTL so that I don't have to manually clean up expired sessions.
- **Story 3**: I want type-safe session data so that I can't accidentally store incorrect structures.

### As a System Administrator
- **Story 4**: I want sessions to expire automatically so that Redis doesn't fill up with stale data.

## Suggested Automated Tests

### Unit Tests
1. **Session Storage Tests**:
   ```typescript
   describe('Session Store', () => {
     it('stores session with all required fields', async () => {
       const session = {
         sessionPayload: { wsUrl: 'wss://...', config: {...} },
         wsUrl: 'wss://...',
         createdAt: new Date().toISOString(),
         ttl: 600
       };
       await sessionStore.set('conv-123', session);
       const retrieved = await sessionStore.get('conv-123');
       expect(retrieved).toMatchObject(session);
     });
     
     it('retrieves session by conversation ID', async () => {
       // Test retrieval
     });
     
     it('deletes session', async () => {
       await sessionStore.set('conv-123', session);
       await sessionStore.delete('conv-123');
       const retrieved = await sessionStore.get('conv-123');
       expect(retrieved).toBeNull();
     });
   });
   ```

2. **TTL Tests**:
   ```typescript
   describe('TTL Behavior', () => {
     it('sets TTL of 10 minutes', async () => {
       await sessionStore.set('conv-123', session);
       const ttl = await redis.ttl('elevenlabs:session:conv-123');
       expect(ttl).toBeCloseTo(600, -2); // ~600 seconds
     });
     
     it('session expires after TTL', async () => {
       await sessionStore.set('conv-123', session);
       // Fast-forward time
       jest.advanceTimersByTime(601 * 1000);
       const retrieved = await sessionStore.get('conv-123');
       expect(retrieved).toBeNull();
     });
   });
   ```

3. **Schema Tests**:
   ```typescript
   describe('Schema Compatibility', () => {
     it('handles missing optional fields', async () => {
       const minimalSession = { sessionPayload: {...}, wsUrl: '...' };
       await sessionStore.set('conv-123', minimalSession);
       const retrieved = await sessionStore.get('conv-123');
       expect(retrieved).toBeDefined();
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Session Data Loss**:
   - **Risk**: Sessions not stored correctly, causing callback failures
   - **Mitigation**: Comprehensive tests, validation, error handling, monitoring

2. **TTL Mismatches**:
   - **Risk**: TTL not set correctly, causing sessions to persist too long or expire too soon
   - **Mitigation**: Explicit TTL values, tests verify TTL, monitoring

3. **Payload Structure Errors**:
   - **Risk**: Incorrect session payload structure preventing callback pushes
   - **Mitigation**: Type safety, validation, code comments, tests

### Medium Risk
4. **Redis Connection Failures**:
   - **Risk**: Redis unavailable causing session storage failures
   - **Mitigation**: Error handling, retry logic, health checks, fallback behavior

5. **Race Conditions**:
   - **Risk**: Concurrent session updates causing data corruption
   - **Mitigation**: Atomic operations, proper locking if needed, test concurrency

### Low Risk
6. **Schema Evolution**:
   - **Risk**: Future schema changes breaking existing sessions
   - **Mitigation**: Versioning, migration strategy, backwards compatibility tests
