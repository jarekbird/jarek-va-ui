# Step 59: Add Unit Tests for Voice Service

**Phase**: Phase 4 â€“ Polish, Error Handling, Testing, Documentation

## Description

Add unit tests for `elevenlabs-voice`:
- Test reconnection backoff logic.
- Test heartbeat timeout behavior.
- Test signed URL renewal flow.

## Detailed Desired Outcomes

### Test Coverage

**Reconnection Backoff:**
- Test exponential backoff calculation
- Test max retries enforcement
- Test backoff delays
- Test retry on success
- Test failure after max retries

**Heartbeat:**
- Test heartbeat timer fires correctly
- Test heartbeat detects failures
- Test heartbeat triggers reconnection
- Test heartbeat cleanup

**Signed URL Renewal:**
- Test renewal scheduling
- Test renewal before expiration
- Test renewal on expiration error
- Test renewal failure handling
- Test seamless renewal

**General:**
- Test connection lifecycle
- Test event handling
- Test error handling
- Test state management

## User Stories

**As a developer**, I want:
- Comprehensive tests for voice service
- Tests that catch regressions
- Easy to run tests
- Good test coverage

**As a tester**, I want:
- Tests that cover all scenarios
- Tests that are easy to understand
- Fast-running tests

**As a system**, I want:
- Reliable voice service
- Tests that verify correctness
- No regressions

## Suggested Automated Tests

### Reconnection Tests

```typescript
describe('Voice Service - Reconnection', () => {
  beforeEach(() => {
    jest.useFakeTimers();
  });

  it('should use exponential backoff for reconnection', async () => {
    const service = new ElevenLabsVoiceService();
    const delays: number[] = [];

    // Mock setTimeout to track delays
    const originalSetTimeout = global.setTimeout;
    global.setTimeout = jest.fn((callback, delay) => {
      delays.push(delay);
      return originalSetTimeout(callback, delay);
    });

    // Trigger reconnection
    await service.handleConnectionFailure();

    expect(delays[0]).toBe(1000); // Initial delay
    expect(delays[1]).toBe(2000); // 2x backoff
    expect(delays[2]).toBe(4000); // 4x backoff
  });

  it('should respect max retries', async () => {
    const service = new ElevenLabsVoiceService();
    jest.spyOn(service, 'attemptReconnect').mockRejectedValue(new Error('Failed'));

    await expect(service.handleConnectionFailure()).rejects.toThrow();
    expect(service.attemptReconnect).toHaveBeenCalledTimes(5); // Max retries
  });
});
```

### Heartbeat Tests

```typescript
describe('Voice Service - Heartbeat', () => {
  beforeEach(() => {
    jest.useFakeTimers();
  });

  it('should check connection health periodically', () => {
    const service = new ElevenLabsVoiceService();
    service.startHeartbeat();

    const checkSpy = jest.spyOn(service, 'checkConnectionHealth');

    jest.advanceTimersByTime(30000); // 30 seconds

    expect(checkSpy).toHaveBeenCalled();
  });

  it('should trigger reconnection on heartbeat failure', () => {
    const service = new ElevenLabsVoiceService();
    service.startHeartbeat();
    jest.spyOn(service, 'checkConnectionHealth').mockReturnValue(false);
    const reconnectSpy = jest.spyOn(service, 'reconnect');

    jest.advanceTimersByTime(30000);

    expect(reconnectSpy).toHaveBeenCalled();
  });
});
```

### Signed URL Renewal Tests

```typescript
describe('Voice Service - Signed URL Renewal', () => {
  beforeEach(() => {
    jest.useFakeTimers();
  });

  it('should schedule renewal before expiration', async () => {
    const service = new ElevenLabsVoiceService();
    const expiresAt = new Date(Date.now() + 600000); // 10 minutes

    await service.startVoiceSession('agent-123', 'wss://url', expiresAt);

    const getSignedUrlSpy = jest.spyOn(api, 'getVoiceSignedUrl');

    // Advance to 5 minutes before expiration
    jest.advanceTimersByTime(300000);

    expect(getSignedUrlSpy).toHaveBeenCalled();
  });

  it('should renew on expiration error', async () => {
    const service = new ElevenLabsVoiceService();
    const getSignedUrlSpy = jest.spyOn(api, 'getVoiceSignedUrl')
      .mockResolvedValue({ signedUrl: 'wss://new-url', expiresAt: new Date() });

    // Simulate expiration error
    service.handleError(new Error('Signed URL expired'));

    expect(getSignedUrlSpy).toHaveBeenCalled();
  });
});
```

## Risks

### Low Risk
- **Incomplete test coverage**: Some scenarios might not be tested
  - **Mitigation**: Aim for high coverage, test edge cases
  - **Detection**: Coverage reports, code review

- **Flaky tests**: Tests might be flaky
  - **Mitigation**: Use proper mocks, avoid timing issues
  - **Detection**: Test runs, CI/CD failures

### Medium Risk
- **Test maintenance**: Tests might break when code changes
  - **Mitigation**: Write maintainable tests, update when needed
  - **Detection**: Test failures, maintenance burden

### High Risk
- **None identified** - Unit testing with low risk

## Implementation Notes

- Write tests for retry logic
- Test exponential backoff
- Test heartbeat monitoring
- Test timeout handling
- Test signed URL renewal
- Mock ElevenLabs SDK
- Achieve good test coverage
- Use proper test utilities
- Test edge cases
- Keep tests maintainable
