# Implement Agent Tools Webhook Route

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `POST /agent-tools`:
  - Verify `WEBHOOK_SECRET` / Authorization header.
  - Parse `tool`, `args`, and `conversation_id`.
  - Look up active session from Redis; fail gracefully if none.
  - Create a callback task in Redis with session payload and task metadata.
  - Invoke `cursor-client.startAsyncCursorTask` with callback URL pointing back to `/callback`.
  - Respond immediately to ElevenLabs with "task started" message and `requestId`.
- Route non-cursor "fast tools" synchronously (if any).

## Desired Outcomes

### Primary Outcomes
1. **Webhook Handler**: Reliable endpoint that receives tool calls from ElevenLabs agent and routes them appropriately.

2. **Immediate Response**: Webhook returns immediately (< 1 second) to ElevenLabs, preventing timeout errors.

3. **Async Task Routing**: Cursor tools executed asynchronously with proper callback setup.

4. **Security**: Webhook authentication prevents unauthorized access.

5. **Session Management**: Proper lookup and handling of active agent sessions.

### Success Criteria
- Webhook receives and processes tool calls
- Authentication verified correctly
- Immediate response to ElevenLabs (< 1s)
- Async cursor tasks started correctly
- Callback tasks created in Redis
- Missing sessions handled gracefully
- Fast tools executed synchronously
- Clear error messages
- Comprehensive test coverage

## User Stories

### As a Developer
- **Story 1**: I want a webhook endpoint so that ElevenLabs can call tools.
- **Story 2**: I want immediate responses so that ElevenLabs doesn't timeout.

### As a System Administrator
- **Story 3**: I want secure webhooks so that unauthorized parties can't trigger tool calls.

## Suggested Automated Tests

### Unit Tests
1. **Webhook Handler Tests**:
   ```typescript
   describe('POST /agent-tools', () => {
     it('processes cursor tool call', async () => {
       const webhookPayload = {
         tool: 'write_code',
         args: { file: 'test.ts', content: '...' },
         conversation_id: 'conv-123'
       };
       
       const response = await request(app)
         .post('/agent-tools')
         .set('Authorization', `Bearer ${WEBHOOK_SECRET}`)
         .send(webhookPayload)
         .expect(200);
       
       expect(response.body).toHaveProperty('ok', true);
       expect(response.body).toHaveProperty('say');
       expect(response.body).toHaveProperty('result.requestId');
     });
   });
   ```

2. **Authentication Tests**:
   ```typescript
   describe('Authentication', () => {
     it('rejects requests without secret', async () => {
       await request(app)
         .post('/agent-tools')
         .send({ tool: 'test' })
         .expect(401);
     });
     
     it('rejects requests with wrong secret', async () => {
       await request(app)
         .post('/agent-tools')
         .set('Authorization', 'Bearer wrong-secret')
         .send({ tool: 'test' })
         .expect(401);
     });
   });
   ```

3. **Session Handling Tests**:
   ```typescript
   describe('Session Handling', () => {
     it('handles missing session gracefully', async () => {
       // No session in Redis
       const response = await request(app)
         .post('/agent-tools')
         .set('Authorization', `Bearer ${WEBHOOK_SECRET}`)
         .send({ tool: 'write_code', conversation_id: 'conv-123' })
         .expect(200);
       
       expect(response.body.say).toContain('session not active');
     });
   });
   ```

4. **Async Task Tests**:
   ```typescript
   describe('Async Task Routing', () => {
     it('starts async cursor task', async () => {
       jest.spyOn(cursorClient, 'startAsyncCursorTask');
       
       await request(app)
         .post('/agent-tools')
         .set('Authorization', `Bearer ${WEBHOOK_SECRET}`)
         .send({ tool: 'write_code', conversation_id: 'conv-123' })
         .expect(200);
       
       expect(cursorClient.startAsyncCursorTask).toHaveBeenCalled();
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Webhook Timeout**:
   - **Risk**: Webhook takes too long, causing ElevenLabs to timeout
   - **Mitigation**: Immediate response pattern, async execution, timeout monitoring

2. **Authentication Bypass**:
   - **Risk**: Unauthorized tool calls causing security issues
   - **Mitigation**: Strong authentication, secret validation, rate limiting, monitoring

3. **Session Lookup Failures**:
   - **Risk**: Missing sessions causing callback failures
   - **Mitigation**: Graceful error handling, clear messages, session validation

### Medium Risk
4. **Callback Task Creation Failures**:
   - **Risk**: Tasks not stored correctly, breaking callbacks
   - **Mitigation**: Error handling, validation, monitoring, tests

5. **Cursor Client Failures**:
   - **Risk**: cursor-runner unavailable causing tool failures
   - **Mitigation**: Graceful error handling, clear error messages, monitoring

### Low Risk
6. **Tool Routing Errors**:
   - **Risk**: Wrong tool routed to wrong handler
   - **Mitigation**: Clear tool identification, validation, tests
