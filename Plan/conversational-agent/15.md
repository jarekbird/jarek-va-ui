# Implement Cursor Runner HTTP Client

## Scope
`elevenlabs-agent`.

## Subtasks
- Implement `services/cursor-client.ts` with:
  - `startAsyncCursorTask(taskId, payload, callbackUrl)` calling `/cursor/iterate/async`.
- Make base URL configurable via `CURSOR_RUNNER_URL`.
- Handle network errors with clear logs and non-fatal behavior toward ElevenLabs caller.

## Desired Outcomes

### Primary Outcomes
1. **Async Task Initiation**: Reliable function to start cursor tasks asynchronously, returning immediately without blocking.

2. **Callback URL Configuration**: Proper callback URL setup so cursor-runner can notify elevenlabs-agent when tasks complete.

3. **Error Resilience**: Network errors don't crash the service or cause poor responses to ElevenLabs.

4. **Configurability**: Base URL configurable for different environments.

### Success Criteria
- Async cursor tasks can be started successfully
- Callback URL correctly formatted
- Network errors handled gracefully
- Clear error logging
- Non-fatal error responses to ElevenLabs
- Base URL configurable
- Tests cover success and error paths

## User Stories

### As a Developer
- **Story 1**: I want a reliable cursor client so that I can start async cursor tasks from the webhook.
- **Story 2**: I want configurable base URLs so that I can point to different cursor-runner instances.

### As a System Administrator
- **Story 3**: I want graceful error handling so that cursor-runner failures don't break the agent service.

## Suggested Automated Tests

### Unit Tests
1. **Success Path Tests**:
   ```typescript
   describe('Cursor Client', () => {
     it('starts async cursor task', async () => {
       mockFetch.mockResolvedValue({ ok: true, status: 200 });
       
       await cursorClient.startAsyncCursorTask('task-123', payload, 'http://callback');
       expect(mockFetch).toHaveBeenCalledWith(
         expect.stringContaining('/cursor/iterate/async'),
         expect.objectContaining({
           method: 'POST',
           body: expect.stringContaining('task-123')
         })
       );
     });
     
     it('includes callback URL in request', async () => {
       // Verify callback URL in payload
     });
   });
   ```

2. **Error Handling Tests**:
   ```typescript
   describe('Error Handling', () => {
     it('handles cursor-runner unavailable gracefully', async () => {
       mockFetch.mockRejectedValue(new Error('Connection refused'));
       // Should not throw, should log error
       await expect(cursorClient.startAsyncCursorTask(...)).resolves.not.toThrow();
     });
     
     it('logs errors clearly', async () => {
       const logSpy = jest.spyOn(console, 'error');
       mockFetch.mockRejectedValue(new Error('Failed'));
       await cursorClient.startAsyncCursorTask(...);
       expect(logSpy).toHaveBeenCalledWith(expect.stringContaining('Failed'));
     });
   });
   ```

3. **Configuration Tests**:
   ```typescript
   describe('Configuration', () => {
     it('uses CURSOR_RUNNER_URL from environment', () => {
       process.env.CURSOR_RUNNER_URL = 'http://custom-url:3001';
       const client = new CursorClient();
       // Verify base URL used
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Callback URL Incorrect**:
   - **Risk**: Wrong callback URL causing task completions to fail
   - **Mitigation**: Validate callback URL format, test end-to-end, clear logging

2. **Cursor Runner Unavailable**:
   - **Risk**: cursor-runner down causing all tool calls to fail
   - **Mitigation**: Graceful error handling, clear error messages to agent, monitoring

### Medium Risk
3. **Network Timeouts**:
   - **Risk**: Slow cursor-runner causing webhook timeouts
   - **Mitigation**: Appropriate timeouts, async pattern, error handling

4. **Payload Format Errors**:
   - **Risk**: Incorrect payload format causing cursor-runner to reject requests
   - **Mitigation**: Validate payload structure, tests, coordinate with cursor-runner team

### Low Risk
5. **Base URL Misconfiguration**:
   - **Risk**: Wrong base URL pointing to incorrect service
   - **Mitigation**: Environment variable validation, clear documentation, default values
