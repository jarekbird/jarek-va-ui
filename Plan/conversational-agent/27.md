# Implement Signed URL Expiration Handling in Voice Service

## Scope
`jarek-va-ui`.

## Subtasks
- Track `signedUrl` issuance time and TTL (if provided).
- Use timers to proactively renew signed URLs 5 minutes before expiration.
- Handle ElevenLabs expiration errors by automatically fetching a new URL and reconnecting.
- Provide user feedback (e.g., "Reconnecting to voice agent...").

## Desired Outcomes

### Primary Outcomes
1. **Proactive Renewal**: Signed URLs renewed before expiration, preventing connection drops.

2. **Automatic Reconnection**: When URLs expire, automatic reconnection with new URL.

3. **Seamless Experience**: Users don't experience connection drops due to URL expiration.

4. **User Feedback**: Clear messaging when reconnection occurs.

### Success Criteria
- URLs tracked with issuance time and TTL
- Proactive renewal 5 minutes before expiration
- Automatic reconnection on expiration
- User feedback during reconnection
- No connection drops due to expiration
- Tests verify renewal logic
- Tests verify reconnection flow

## User Stories

### As a User
- **Story 1**: I want seamless voice sessions so that I don't experience unexpected disconnections.
- **Story 2**: I want to know when reconnection happens so that I understand any brief interruptions.

### As a Developer
- **Story 3**: I want automatic URL renewal so that I don't have to manually manage URL expiration.

## Suggested Automated Tests

### Unit Tests
1. **Renewal Logic Tests**:
   ```typescript
   describe('Signed URL Renewal', () => {
     it('renews URL 5 minutes before expiration', async () => {
       jest.useFakeTimers();
       const mockGetSignedUrl = jest.spyOn(api, 'getVoiceSignedUrl');
       
       const service = new ElevenLabsVoiceService();
       await service.startVoiceSession('agent-123', {
         signedUrl: 'wss://...',
         expiresAt: new Date(Date.now() + 10 * 60 * 1000).toISOString() // 10 min TTL
       });
       
       // Fast-forward 5 minutes
       jest.advanceTimersByTime(5 * 60 * 1000);
       
       await waitFor(() => {
         expect(mockGetSignedUrl).toHaveBeenCalled();
       });
     });
   });
   ```

2. **Expiration Handling Tests**:
   ```typescript
   describe('Expiration Handling', () => {
     it('reconnects on expiration error', async () => {
       // Simulate expiration error
       // Verify reconnection with new URL
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Renewal Timing Errors**:
   - **Risk**: Renewal happens too late or too early, causing connection drops
   - **Mitigation**: Accurate timing, buffer time, test timing logic

2. **Reconnection Failures**:
   - **Risk**: Reconnection fails, breaking voice session
   - **Mitigation**: Retry logic, error handling, user feedback, fallback

### Medium Risk
3. **TTL Information Missing**:
   - **Risk**: TTL not provided by API, making proactive renewal impossible
   - **Mitigation**: Default TTL assumption, monitor expiration, handle gracefully

4. **Multiple Renewal Attempts**:
   - **Risk**: Multiple renewal timers causing race conditions
   - **Mitigation**: Single renewal timer, proper cleanup, state management

### Low Risk
5. **User Experience During Renewal**:
   - **Risk**: Brief interruption during renewal noticeable to users
   - **Mitigation**: Seamless renewal, clear messaging, minimize interruption
