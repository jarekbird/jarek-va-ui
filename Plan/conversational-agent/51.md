# Migrate Webhook Logic from jarek-va to elevenlabs-agent

## Scope
`elevenlabs-agent`, `jarek-va`.

## Subtasks
- Audit the existing `agent_tools_controller` (or equivalent) in `jarek-va` to catalog all supported tools and behaviors.
- Reconcile differences between the legacy synchronous pattern and the new async callback-queue design.
- Port only the necessary tool-routing logic into `elevenlabs-agent`'s `tool-router`/webhook implementation, ensuring it uses async cursor execution.
- Add tests that compare representative legacy requests/responses against the new webhook to ensure behavioral equivalence where required.
- Gate any remaining Rails-based webhook paths behind a feature flag or clearly mark them as deprecated.

## Desired Outcomes

### Primary Outcomes
1. **Complete Migration**: All webhook logic successfully migrated from Rails to Node.js service, eliminating dependency on deprecated service.

2. **Behavioral Equivalence**: New webhook implementation behaves identically to legacy implementation for all supported tools.

3. **Async Pattern Adoption**: All cursor tools use async callback pattern instead of synchronous execution.

4. **Deprecation Path**: Legacy Rails webhook clearly marked as deprecated with migration timeline.

5. **Test Coverage**: Comprehensive tests ensure no regressions during migration.

### Success Criteria
- All tools cataloged and documented
- Tool routing logic ported correctly
- Async pattern used for all cursor tools
- Tests verify behavioral equivalence
- Legacy webhook deprecated
- Feature flag gates legacy code
- No functionality lost in migration

## User Stories

### As a Developer
- **Story 1**: I want webhook logic in the new service so that I can maintain it more easily.
- **Story 2**: I want behavioral equivalence so that existing integrations continue to work.

### As a System Administrator
- **Story 3**: I want deprecated code clearly marked so that I know what to remove later.

## Suggested Automated Tests

### Migration Tests
1. **Behavioral Equivalence Tests**:
   ```typescript
   describe('Webhook Migration', () => {
     it('handles tool X identically to legacy', async () => {
       const legacyResponse = await legacyWebhook({ tool: 'X', args: {...} });
       const newResponse = await newWebhook({ tool: 'X', args: {...} });
       expect(newResponse).toMatchObject(legacyResponse);
     });
   });
   ```

2. **Tool Catalog Tests**:
   ```typescript
   describe('Tool Catalog', () => {
     it('all legacy tools are supported', () => {
       const legacyTools = getLegacyTools();
       const newTools = getNewTools();
       expect(newTools).toContainAll(legacyTools);
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Behavioral Differences**:
   - **Risk**: New implementation behaves differently, breaking existing integrations
   - **Mitigation**: Comprehensive tests, side-by-side comparison, gradual migration

2. **Missing Tools**:
   - **Risk**: Some tools not migrated, causing functionality loss
   - **Mitigation**: Complete audit, test all tools, verify coverage

### Medium Risk
3. **Async Pattern Issues**:
   - **Risk**: Async pattern causes timing or ordering issues
   - **Mitigation**: Proper async handling, tests, monitoring

4. **Deprecation Timeline**:
   - **Risk**: Legacy code not removed, causing maintenance burden
   - **Mitigation**: Clear deprecation timeline, feature flags, removal plan

### Low Risk
5. **Test Maintenance**:
   - **Risk**: Equivalence tests become outdated
   - **Mitigation**: Keep tests updated, remove when legacy code removed
