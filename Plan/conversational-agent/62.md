# Step 62: Validate Complete Callback Flow

**Phase**: Phase 4 â€“ Polish, Error Handling, Testing, Documentation

## Description

Validate complete callback flow in a dev environment:
- Start `cursor-runner`, `elevenlabs-agent`, and `jarek-va-ui`.
- Start a voice session in a browser, verify session registration POST.
- Trigger a tool call that goes through cursor-runner.
- Wait for callback and confirm agent receives completion message via ElevenLabs.

## Detailed Desired Outcomes

### End-to-End Validation

**Service Startup:**
- Start all services: cursor-runner, elevenlabs-agent, jarek-va-ui
- Verify all services are healthy
- Verify Redis is accessible
- Verify services can communicate

**Voice Session:**
- Open browser to agent conversation
- Start voice session
- Verify session registration POST to backend
- Verify session stored in Redis
- Verify connection status in UI

**Tool Execution:**
- Trigger cursor tool via voice (e.g., "Write code to create auth system")
- Verify webhook received by elevenlabs-agent
- Verify task created in callback queue
- Verify cursor-runner receives request
- Monitor cursor execution

**Callback Flow:**
- Wait for cursor execution to complete
- Verify callback received by elevenlabs-agent
- Verify task retrieved from callback queue
- Verify message pushed to ElevenLabs agent
- Verify agent receives and responds to message

**Validation Checklist:**
- [ ] All services start successfully
- [ ] Voice session connects
- [ ] Session registered in backend
- [ ] Tool call triggers cursor execution
- [ ] Callback received
- [ ] Message pushed to agent
- [ ] Agent responds to completion message

## User Stories

**As a developer**, I want:
- To verify the complete flow works end-to-end
- To catch integration issues early
- Clear validation steps

**As a tester**, I want:
- Comprehensive validation process
- Clear success/failure criteria
- Easy to reproduce

**As a system**, I want:
- Reliable end-to-end flow
- Proper error handling throughout
- Good observability

## Suggested Automated Tests

### End-to-End Tests

```typescript
describe('Complete Callback Flow', () => {
  it('should complete full flow', async () => {
    // 1. Start voice session
    const voiceService = new ElevenLabsVoiceService();
    await voiceService.startVoiceSession('agent-123');

    // 2. Verify session registration
    const sessionResponse = await fetch('/agent-conversations/api/conv-123/session');
    expect(sessionResponse.status).toBe(200);

    // 3. Trigger tool call
    const webhookResponse = await fetch('/agent-tools', {
      method: 'POST',
      headers: { 'x-webhook-secret': 'test-secret' },
      body: JSON.stringify({
        tool: 'cursor_execute',
        args: { prompt: 'Create auth system' },
        conversation_id: 'conv-123'
      })
    });
    expect(webhookResponse.status).toBe(200);

    // 4. Wait for callback
    await waitForCallback('task-123', { timeout: 300000 }); // 5 minutes

    // 5. Verify message pushed to agent
    // (This might require monitoring or checking agent responses)
  });
});
```

## Risks

### Low Risk
- **Service dependencies**: Services might not be available
  - **Mitigation**: Use docker-compose, ensure all services running
  - **Detection**: Service health checks

- **Timing issues**: Callback might take longer than expected
  - **Mitigation**: Use appropriate timeouts, monitor execution
  - **Detection**: Timeout errors, monitoring

### Medium Risk
- **Integration issues**: Services might not integrate correctly
  - **Mitigation**: Test integration points, verify communication
  - **Detection**: Integration tests, validation

### High Risk
- **Callback failures**: Callback might not complete
  - **Mitigation**: Monitor callbacks, handle errors
  - **Detection**: Callback monitoring, error logs

## Implementation Notes

- Start all services locally
- Open browser and start voice session
- Verify session registration in logs
- Trigger cursor tool via voice
- Monitor cursor-runner execution
- Verify callback received
- Confirm message pushed to agent
- Document any issues found
- Create validation checklist
- Document expected behavior
- Test with real ElevenLabs agent if possible
