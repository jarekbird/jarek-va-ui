# Validate Security and Secrets Handling

## Scope
`elevenlabs-agent`, `cursor-runner`, infra.

## Subtasks
- Ensure `ELEVENLABS_API_KEY` and `WEBHOOK_SECRET` are never logged.
- Validate webhook authentication logic for `/agent-tools` and `/callback`.
- Confirm CORS/Traefik configuration does not expose unintended routes.

## Desired Outcomes

### Primary Outcomes
1. **Secret Protection**: API keys and webhook secrets never exposed in logs, error messages, or client-side code.

2. **Authentication Validation**: Webhook authentication properly validates requests, preventing unauthorized access.

3. **Route Security**: Only intended routes exposed through Traefik, preventing access to internal endpoints.

4. **Security Audit**: Complete security review ensuring no vulnerabilities introduced.

### Success Criteria
- Secrets never logged
- Webhook authentication works correctly
- CORS properly configured
- Traefik routes secure
- No unintended routes exposed
- Security review completed
- Tests verify security measures

## User Stories

### As a Security Engineer
- **Story 1**: I want secrets protected so that credentials aren't exposed.
- **Story 2**: I want proper authentication so that unauthorized access is prevented.

### As a System Administrator
- **Story 3**: I want secure routes so that internal services aren't exposed.

## Suggested Automated Tests

### Security Tests
1. **Secret Protection Tests**:
   ```typescript
   describe('Secret Protection', () => {
     it('never logs API key', () => {
       const logSpy = jest.spyOn(console, 'log');
       // Trigger operations that might log
       expect(logSpy).not.toHaveBeenCalledWith(
         expect.stringContaining(process.env.ELEVENLABS_API_KEY)
       );
     });
   });
   ```

2. **Authentication Tests**:
   ```typescript
   describe('Webhook Authentication', () => {
     it('rejects requests without secret', async () => {
       await request(app)
         .post('/agent-tools')
         .expect(401);
     });
   });
   ```

3. **Route Security Tests**:
   ```typescript
   describe('Route Security', () => {
     it('internal routes not exposed', async () => {
       // Verify internal routes not accessible via Traefik
     });
   });
   ```

## Inherent Risks

### High Risk
1. **Secret Exposure**:
   - **Risk**: API keys or secrets logged or exposed
   - **Mitigation**: Never log secrets, sanitize errors, code review, security audit

2. **Authentication Bypass**:
   - **Risk**: Webhook authentication bypassed, allowing unauthorized access
   - **Mitigation**: Strong authentication, validation, testing, security review

3. **Route Exposure**:
   - **Risk**: Internal routes exposed, causing security issues
   - **Mitigation**: Proper Traefik configuration, route validation, security review

### Medium Risk
4. **CORS Misconfiguration**:
   - **Risk**: CORS allows unauthorized origins
   - **Mitigation**: Proper CORS configuration, origin validation, testing

### Low Risk
5. **Error Message Leakage**:
   - **Risk**: Error messages leak sensitive information
   - **Mitigation**: Sanitize error messages, generic error responses, review
