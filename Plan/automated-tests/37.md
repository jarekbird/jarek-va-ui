# TASK-37: Raise and enforce coverage to target thresholds

**Section**: 8. Finalization & Ongoing Maintenance
**Subsection**: 8.1 Coverage Enforcement
**Task ID**: TASK-37

## Description

This task verifies that test coverage meets the target thresholds established in TASK-4 and adjusts thresholds upward if appropriate. This ensures the test suite has comprehensive coverage across the codebase.

The task will:
- Re-run coverage report and verify thresholds are met
- Confirm global coverage ≥ 80%
- Confirm critical directories (conversations/tasks/dashboards) ≥ 90%
- Adjust thresholds upward if stable and appropriate
- Ensure coverage thresholds are enforced in CI

This finalizes the coverage requirements and ensures they are maintained going forward.

## Current State

- Coverage thresholds should be configured (from TASK-4)
- Test suite should be comprehensive (from previous tasks)
- Coverage report can be generated
- Coverage may or may not meet target thresholds yet

**Reference Implementation**: 
- `vitest.config.ts` coverage configuration (from TASK-4)
- Coverage report output

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, and all test implementation tasks (TASK-5 through TASK-36) are complete.

## Checklist

### Preparation and Setup

- [ ] Review coverage thresholds from TASK-4
- [ ] Review current test coverage
- [ ] Review coverage report
- [ ] Understand coverage metrics (statements, branches, functions, lines)
- [ ] Review CI configuration

### Implementation Steps

- [ ] Step 1: Run coverage report
  - [ ] Run `npm run test:coverage`
  - [ ] Review coverage report output
  - [ ] Review HTML coverage report (if generated)
  - [ ] Document current coverage percentages

- [ ] Step 2: Verify global coverage
  - [ ] Check global coverage for statements
  - [ ] Check global coverage for branches
  - [ ] Check global coverage for functions
  - [ ] Check global coverage for lines
  - [ ] Verify all metrics are ≥ 80%
  - [ ] Document any metrics below threshold

- [ ] Step 3: Verify critical directory coverage
  - [ ] Check `src/components` coverage (should be ≥ 90%)
  - [ ] Check `src/api` coverage (should be ≥ 90%)
  - [ ] Check `src/services` coverage (should be ≥ 90% if exists)
  - [ ] Check conversations-related directories coverage
  - [ ] Check tasks-related directories coverage
  - [ ] Check dashboards-related directories coverage
  - [ ] Verify all critical directories are ≥ 90%
  - [ ] Document any directories below threshold

- [ ] Step 4: Address coverage gaps (if needed)
  - [ ] Identify files/directories below thresholds
  - [ ] Prioritize critical files for additional tests
  - [ ] Write additional tests to raise coverage
  - [ ] Re-run coverage to verify improvements
  - [ ] Repeat until thresholds are met

- [ ] Step 5: Adjust thresholds upward (if appropriate)
  - [ ] Review coverage stability
  - [ ] If coverage is stable and above thresholds, consider raising
  - [ ] Update `vitest.config.ts` with new thresholds
  - [ ] Document threshold changes
  - [ ] Verify new thresholds are achievable

- [ ] Step 6: Verify CI enforcement
  - [ ] Check CI configuration runs coverage
  - [ ] Verify CI fails if thresholds are not met
  - [ ] Test CI enforcement by temporarily lowering threshold
  - [ ] Restore correct thresholds
  - [ ] Document CI enforcement

- [ ] Step 7: Document coverage status
  - [ ] Document current coverage percentages
  - [ ] Document threshold values
  - [ ] Document any known gaps or limitations
  - [ ] Document coverage goals

### Specific Requirements

- [ ] Requirement 1: Global coverage verified
  - Global coverage is ≥ 80% for all metrics
  - Coverage is documented

- [ ] Requirement 2: Critical directory coverage verified
  - Critical directories are ≥ 90%
  - Coverage is documented

- [ ] Requirement 3: Thresholds enforced
  - Thresholds are configured in vitest.config.ts
  - CI enforces thresholds
  - Tests fail if thresholds are not met

- [ ] Requirement 4: Coverage gaps addressed
  - Any gaps below thresholds are addressed
  - Additional tests are written if needed
  - Coverage meets all thresholds

### Error Handling and Edge Cases

- [ ] Handle case: Coverage is below thresholds
  - Identify gaps
  - Write additional tests
  - Raise coverage to meet thresholds

- [ ] Handle case: Coverage is significantly above thresholds
  - Consider raising thresholds
  - Document rationale
  - Ensure new thresholds are maintainable

- [ ] Handle case: Some files are difficult to test
  - Document limitations
  - Consider excluding from coverage (if appropriate)
  - Or write targeted tests

### Testing

- [ ] Run coverage report: `npm run test:coverage`
- [ ] Verify coverage meets thresholds
- [ ] Verify CI enforcement works
- [ ] Test threshold enforcement by temporarily failing
- [ ] Verify all tests still pass
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`

### Documentation

- [ ] Document current coverage percentages
- [ ] Document threshold values
- [ ] Document coverage goals
- [ ] Document any known gaps or limitations
- [ ] Update README with coverage information (if applicable)

### Verification

- [ ] Verify coverage meets all thresholds
- [ ] Verify thresholds are enforced
- [ ] Verify CI enforcement works
- [ ] Verify coverage is documented

## Notes

- This task is part of Section 8: Finalization & Ongoing Maintenance
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, and all test implementation tasks (TASK-5 through TASK-36) are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required for this task)
  - TASK-4: Configure coverage thresholds (required)
  - All test implementation tasks (TASK-5 through TASK-36)
- **Important Considerations**: 
  - Coverage thresholds should be realistic and maintainable
  - Focus on raising coverage for critical code first
  - Some files may be difficult to test - document limitations
  - Consider excluding certain files from coverage if appropriate
  - Ensure CI enforces thresholds
  - Coverage should be stable, not just meeting thresholds once
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: Coverage thresholds may be configured but coverage may not meet them yet

## Related Tasks

- Previous: TASK-36 (Add negative E2E journeys)
- Next: TASK-38 (Wire tests into CI/CD)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required)
  - TASK-4: Configure coverage thresholds (required)
  - All test implementation tasks (TASK-5 through TASK-36)
- Related: TASK-4 (coverage threshold configuration), TASK-38 (CI/CD integration)

## Definition of Done

### Task Type: SYSTEM/ENVIRONMENT OPERATION TASK + CONFIGURATION TASK

**Description**: This task involves running coverage reports, verifying thresholds are met, and enforcing coverage requirements.

**Definition of Done**: 

1. **Coverage verified**:
   - Coverage report is run: `npm run test:coverage`
   - Global coverage is ≥ 80% for all metrics
   - Critical directories are ≥ 90%
   - Coverage gaps are addressed (if any)

2. **Thresholds enforced**:
   - Thresholds are configured in vitest.config.ts
   - CI enforces thresholds
   - Tests fail if thresholds are not met

3. **Coverage documented**:
   - Current coverage percentages are documented
   - Threshold values are documented
   - Any gaps or limitations are documented

4. **Code committed and pushed**:
   - Coverage configuration changes committed (if any)
   - Additional test files committed (if written)
   - Documentation committed (if applicable)
   - Commit message: `chore: raise and enforce coverage to target thresholds`
   - Code pushed to origin: `git push origin <branch-name>`

5. **User Story** (as a developer):
   - **As a** developer maintaining test coverage
   - **I want** coverage thresholds to be met and enforced
   - **So that** I can ensure comprehensive test coverage across the codebase

6. **Automated Tests**:
   - Coverage report runs successfully: `npm run test:coverage` must complete successfully
   - Coverage meets all thresholds
   - CI enforces thresholds (tests fail if not met)
   - Test verification: Run `npm run test:coverage` and confirm all thresholds are met

**Acceptance Criteria**:
- ✅ Coverage report shows global coverage ≥ 80%
- ✅ Coverage report shows critical directories ≥ 90%
- ✅ Thresholds are enforced in CI
- ✅ All coverage gaps are addressed (if any)
- ✅ Coverage is documented
- ✅ All changes committed and pushed to origin

**The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete.**
