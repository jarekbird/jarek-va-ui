# TASK-22: Add tests for `src/api/tasks.ts`

**Section**: 4. Unit Tests for Untested API Clients (Phase 2B)
**Subsection**: 4.3 Tasks API Client
**Task ID**: TASK-22

## Description

This task creates comprehensive unit tests for the `src/api/tasks.ts` API client module. This module provides functions to interact with the tasks API endpoints, including fetching, creating, and getting tasks with support for pagination, filtering, and sorting.

The tests will verify:
- `fetchTasks` function handles various parameter combinations
- `fetchTasks` function constructs correct query strings
- `fetchTasks` function handles pagination response format
- `fetchTasks` function handles array-only response format
- `listTasks` function handles successful responses
- `listTasks` function handles non-JSON responses
- `getTaskById` / `fetchTask` function handles successful responses
- `getTaskById` / `fetchTask` function handles 404 responses
- `createTask` function handles successful responses
- `createTask` function handles error responses
- Error messages are clear and meaningful
- Response parsing works correctly

This is a complex API client module with multiple functions and response formats requiring thorough test coverage.

## Current State

- `src/api/tasks.ts` exists and exports multiple functions (`fetchTasks`, `listTasks`, `getTaskById`, `fetchTask`, `createTask`)
- Functions use `fetch` API directly
- Functions use `getApiBasePath()` for API base path
- Functions check content-type before parsing JSON
- Functions handle different response formats (array vs object with pagination)
- Functions handle 404 errors specially
- Functions extract error messages from responses
- No tests currently exist for this module
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/api/tasks.ts` (full file)
- `src/utils/api-base.ts` for `getApiBasePath` function
- Existing API client tests for patterns

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `src/api/tasks.ts` code
- [ ] Review all function signatures and parameters
- [ ] Review `getApiBasePath` function usage
- [ ] Review MSW handlers from TASK-3 for tasks endpoints
- [ ] Review existing API client tests for patterns
- [ ] Understand error handling patterns
- [ ] Understand response format handling (array vs paginated)

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/api/__tests__/tasks.test.ts`
  - [ ] Import necessary testing utilities
  - [ ] Import functions from `../tasks`
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe blocks for each function
  - [ ] Set up MSW handlers for `/api/tasks` (GET, POST) and `/api/tasks/:id` (GET)
  - [ ] Create mock task data

- [ ] Step 3: Write tests for `fetchTasks` - without params
  - [ ] Test: Calling without params returns tasks list
  - [ ] Test: Response is parsed correctly
  - [ ] Test: Tasks array is returned

- [ ] Step 4: Write tests for `fetchTasks` - with pagination/filters/sorting
  - [ ] Test: Query string is constructed correctly with all params
  - [ ] Test: Pagination params (page, limit) are included
  - [ ] Test: Filter params (status, status_label, conversation_id) are included
  - [ ] Test: Sort params (sortBy, sortOrder) are included
  - [ ] Test: Response with pagination metadata is parsed correctly
  - [ ] Test: Structured response `{ tasks, pagination }` is returned

- [ ] Step 5: Write tests for `fetchTasks` - array-only response
  - [ ] Test: When backend returns array only, wraps in `{ tasks, pagination? }` correctly
  - [ ] Test: Tasks array is extracted correctly
  - [ ] Test: Pagination is optional when not provided

- [ ] Step 6: Write tests for `fetchTasks` - error responses
  - [ ] Test: Non-JSON response throws error with clear message
  - [ ] Test: Error responses (4xx/5xx) are handled with clear error messages
  - [ ] Test: Error messages include server-provided messages when available
  - [ ] Test: Error messages use status text as fallback

- [ ] Step 7: Write tests for `listTasks` - success
  - [ ] Test: Successful JSON array response returns tasks array
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: Tasks array structure is correct

- [ ] Step 8: Write tests for `listTasks` - non-JSON response
  - [ ] Test: Non-JSON response logs error and throws
  - [ ] Test: Assert on thrown error, not logs
  - [ ] Test: Error message is clear

- [ ] Step 9: Write tests for `listTasks` - error responses
  - [ ] Test: Error responses with JSON error payload propagate message
  - [ ] Test: Error responses without JSON use status text
  - [ ] Test: Error messages are clear

- [ ] Step 10: Write tests for `getTaskById` / `fetchTask` - success
  - [ ] Test: Successful JSON response returns task object
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: Task structure is correct

- [ ] Step 11: Write tests for `getTaskById` / `fetchTask` - 404 response
  - [ ] Test: 404 response throws "Task not found" error
  - [ ] Test: Error message is clear and specific
  - [ ] Test: Error is thrown correctly

- [ ] Step 12: Write tests for `getTaskById` / `fetchTask` - other errors
  - [ ] Test: Other errors (4xx/5xx) return error with status text
  - [ ] Test: Error messages are clear

- [ ] Step 13: Write tests for `createTask` - success
  - [ ] Test: Successful JSON response returns created task
  - [ ] Test: Request body includes `prompt` field
  - [ ] Test: Created task structure is correct

- [ ] Step 14: Write tests for `createTask` - error responses
  - [ ] Test: Error responses (JSON and non-JSON) produce meaningful errors
  - [ ] Test: Error messages are clear
  - [ ] Test: 4xx errors are handled
  - [ ] Test: 5xx errors are handled

### Specific Requirements

- [ ] Requirement 1: Parameter handling tested
  - All parameter combinations work correctly
  - Query string construction is correct
  - Parameters are URL-encoded correctly

- [ ] Requirement 2: Response format handling tested
  - Paginated response format is handled
  - Array-only response format is handled
  - Response wrapping works correctly

- [ ] Requirement 3: Error handling tested
  - Non-JSON responses are handled
  - JSON error responses are handled
  - 404 errors are handled specially
  - Error messages are clear and meaningful

- [ ] Requirement 4: All functions tested
  - `fetchTasks` is fully tested
  - `listTasks` is fully tested
  - `getTaskById` / `fetchTask` is fully tested
  - `createTask` is fully tested

### Error Handling and Edge Cases

- [ ] Handle case: Response has no content-type header
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Response is empty
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: JSON parsing fails
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Network error
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Invalid parameter values
  - Function handles gracefully
  - Query string is constructed correctly

### Testing

- [ ] Write all test cases for tasks API client
- [ ] Use MSW to mock API responses
- [ ] Test all parameter combinations
- [ ] Test all response formats
- [ ] Test error message extraction
- [ ] Test `getApiBasePath` integration (if applicable)
- [ ] Run tests: `npm test -- tasks.test.ts`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document response format handling

### Verification

- [ ] Verify all tasks API client functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 4: Unit Tests for Untested API Clients (Phase 2B)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Use MSW handlers from TASK-3 for API mocking
  - Test query string construction carefully
  - Test response format handling (array vs paginated)
  - Test error message extraction from responses
  - Test both JSON and non-JSON error responses
  - Test 404 handling specially for `getTaskById`
  - Test `getApiBasePath` integration if it affects behavior
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: tasks.ts API client exists but has no tests

## Related Tasks

- Previous: TASK-21 (Add tests for src/api/repositories.ts)
- Next: TASK-23 (Add tests for getApiBasePath)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-12, TASK-13, TASK-14 (components use tasks API client), TASK-23 (getApiBasePath is used by tasks)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the tasks API client module.

**Definition of Done**: 

1. **Test file created**:
   - `src/api/__tests__/tasks.test.ts` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - `fetchTasks` tested (with/without params, response formats, errors)
   - `listTasks` tested (success, non-JSON, errors)
   - `getTaskById` / `fetchTask` tested (success, 404, errors)
   - `createTask` tested (success, errors)

3. **Tests pass**:
   - All tasks API client tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - tasks.ts module has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum, ≥90% for API clients)

5. **Code quality**:
   - Tests use MSW for API mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for tasks API client`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the tasks API client
   - **I want** comprehensive unit tests that verify all functions, parameter handling, response formats, and error handling
   - **So that** I can confidently refactor and extend the API client without breaking functionality

8. **Automated Tests**:
   - All tasks API client tests written and passing
   - Test coverage for module meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- tasks.test.ts` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/api/__tests__/tasks.test.ts` created with comprehensive tests
- ✅ All functions tested (fetchTasks, listTasks, getTaskById, createTask)
- ✅ All scenarios tested (params, response formats, errors)
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements (≥90% for API clients)
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
