# TASK-24: Add tests for `detectBasename`

**Section**: 5. Unit Tests for Utilities & Bootstrapping (Phase 2C)
**Subsection**: 5.2 Basename Detection Utility
**Task ID**: TASK-24

## Description

This task creates comprehensive unit tests for the `detectBasename` utility function. This function detects whether the app is being served behind a path prefix (e.g., `/conversations`) so React Router can trim the prefix before matching routes.

The task involves:
1. Refactoring `src/main.tsx` to extract `detectBasename` into a separate exported helper function
2. Creating comprehensive tests for the extracted function

The tests will verify:
- Function returns `'/'` when `window` is undefined (Node.js/test environment)
- Function returns `/conversations` when pathname is exactly `/conversations`
- Function returns `/conversations` when pathname starts with `/conversations/`
- Function returns `'/'` for all other paths
- Function handles edge cases correctly

This is a pure utility function that requires thorough test coverage of all path scenarios.

## Current State

- `detectBasename` function exists in `src/main.tsx` but is not exported
- Function checks `window` object existence
- Function checks `window.location.pathname`
- Function returns different basenames based on pathname
- Function is not currently testable (not exported)
- No tests currently exist for this function

**Reference Implementation**: 
- `src/main.tsx` (lines 13-23)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `src/main.tsx` code
- [ ] Review `detectBasename` function implementation
- [ ] Understand the path matching logic
- [ ] Understand the use cases (local vs production)
- [ ] Review existing utility tests for patterns

### Implementation Steps

- [ ] Step 1: Refactor `src/main.tsx`
  - [ ] Extract `detectBasename` function into a separate exported helper
  - [ ] Ensure function is pure (no React dependencies)
  - [ ] Export function from `src/main.tsx` or create `src/utils/basename.ts`
  - [ ] Update `src/main.tsx` to use the extracted function
  - [ ] Verify refactoring doesn't break existing functionality

- [ ] Step 2: Create test file
  - [ ] Create `src/__tests__/basename.test.ts` or `src/utils/__tests__/basename.test.ts` (depending on where function is placed)
  - [ ] Import necessary testing utilities
  - [ ] Import function from appropriate location

- [ ] Step 3: Set up test structure
  - [ ] Create describe block for detectBasename
  - [ ] Set up mocks for `window` object
  - [ ] Set up mocks for `window.location.pathname`

- [ ] Step 4: Write tests for Node.js/test environment
  - [ ] Test: When `window` is undefined, returns `'/'`
  - [ ] Test: Function handles missing window gracefully
  - [ ] Test: No errors thrown when window is undefined

- [ ] Step 5: Write tests for `/conversations` path
  - [ ] Test: When pathname is exactly `/conversations`, returns `/conversations`
  - [ ] Test: When pathname starts with `/conversations/`, returns `/conversations`
  - [ ] Test: Path matching works for nested paths (e.g., `/conversations/123`)
  - [ ] Test: Path matching works for deep paths (e.g., `/conversations/123/details`)

- [ ] Step 6: Write tests for other paths
  - [ ] Test: When pathname is `/`, returns `'/'`
  - [ ] Test: When pathname is `/tasks`, returns `'/'`
  - [ ] Test: When pathname is `/dashboard`, returns `'/'`
  - [ ] Test: When pathname is any other path, returns `'/'`

- [ ] Step 7: Write tests for edge cases
  - [ ] Test: Empty pathname returns `'/'`
  - [ ] Test: Pathname with query string works correctly
  - [ ] Test: Pathname with hash works correctly
  - [ ] Test: Case sensitivity (if applicable)

### Specific Requirements

- [ ] Requirement 1: Function extracted
  - Function is extracted from `main.tsx`
  - Function is exported and testable
  - Function is pure (no React dependencies)
  - Refactoring doesn't break existing functionality

- [ ] Requirement 2: Window detection tested
  - Function handles undefined window correctly
  - Function uses window when available

- [ ] Requirement 3: Path matching tested
  - Exact match `/conversations` works
  - Prefix match `/conversations/` works
  - Other paths return default `'/'`

- [ ] Requirement 4: Return values tested
  - Correct basename returned for each scenario
  - Basename format is correct

### Error Handling and Edge Cases

- [ ] Handle case: Window is undefined
  - Function returns `'/'`
  - No errors thrown

- [ ] Handle case: Pathname is empty
  - Function handles gracefully
  - Returns appropriate basename

- [ ] Handle case: Pathname has query string
  - Function uses pathname only
  - Query string doesn't affect result

- [ ] Handle case: Pathname has hash
  - Function uses pathname only
  - Hash doesn't affect result

### Testing

- [ ] Write all test cases for detectBasename
- [ ] Mock `window` object for different scenarios
- [ ] Mock `window.location.pathname` for different paths
- [ ] Test all path scenarios
- [ ] Run tests: `npm test -- basename.test.ts`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage
- [ ] Verify refactoring didn't break app (manual check or integration test)

### Documentation

- [ ] Add JSDoc comments to extracted function
- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document refactoring changes

### Verification

- [ ] Verify function is extracted correctly
- [ ] Verify all detectBasename functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements
- [ ] Verify app still works after refactoring

## Notes

- This task is part of Section 5: Unit Tests for Utilities & Bootstrapping (Phase 2C)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not needed for this utility)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Function must be extracted before testing
  - Function should be pure (no React dependencies)
  - Mock `window` object for testing
  - Mock `window.location.pathname` for different scenarios
  - Test both Node.js (undefined window) and browser (window available) scenarios
  - Test path matching logic carefully
  - Use Vitest's mocking capabilities
  - Verify refactoring doesn't break app functionality
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: detectBasename function exists in main.tsx but is not testable

## Related Tasks

- Previous: TASK-23 (Add tests for getApiBasePath)
- Next: TASK-25 (Add integration tests for navigation + feature flags)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-23 (similar utility function), TASK-25 (integration tests may use basename)

## Definition of Done

### Task Type: CODE/FILE WRITING TASK + TESTING TASK

**Description**: This task involves refactoring `detectBasename` to be testable and writing comprehensive unit tests.

**Definition of Done**: 

1. **Function extracted**:
   - `detectBasename` is extracted from `main.tsx`
   - Function is exported and testable
   - Function is pure (no React dependencies)
   - `main.tsx` still works correctly after refactoring

2. **Test file created**:
   - Test file exists in appropriate location
   - File follows project conventions and patterns

3. **Tests written**:
   - Node.js/test environment tested (undefined window)
   - `/conversations` path tested (exact and prefix match)
   - Other paths tested
   - Edge cases tested

4. **Tests pass**:
   - All detectBasename tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors
   - App still works after refactoring

5. **Coverage meets requirements**:
   - detectBasename function has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum, ≥90% for utilities)

6. **Code quality**:
   - Refactored code is clean and maintainable
   - Tests use appropriate mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

7. **Code committed and pushed**:
   - Refactored `main.tsx` committed
   - Test file committed
   - Commit message: `refactor: extract detectBasename and add comprehensive tests`
   - Code pushed to origin: `git push origin <branch-name>`

8. **User Story** (as a developer):
   - **As a** developer maintaining the basename detection logic
   - **I want** the function to be extracted and have comprehensive unit tests
   - **So that** I can confidently refactor and extend the utility without breaking functionality

9. **Automated Tests**:
   - All detectBasename tests written and passing
   - Test coverage for function meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- basename.test.ts` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `detectBasename` function extracted and exported
- ✅ `src/__tests__/basename.test.ts` (or appropriate location) created with comprehensive tests
- ✅ All scenarios tested (undefined window, /conversations paths, other paths, edge cases)
- ✅ App still works after refactoring
- ✅ All tests pass
- ✅ Test coverage meets requirements (≥90% for utilities)
- ✅ All changes committed and pushed to origin

**A Pull Request was created OR code was pushed to origin with the task complete**
