# TASK-28: Add integration tests for working directory tree

**Section**: 6. Integration Tests for Critical Flows (Phase 3)
**Subsection**: 6.4 Working Directory Tree Integration
**Task ID**: TASK-28

## Description

This task creates comprehensive integration tests for the working directory tree behavior. These tests verify that the file tree rendering, expand/collapse functionality, and keyboard navigation work correctly together across multiple levels of nesting.

The tests will verify:
- File tree loads and displays correctly
- Top-level directories are initially expanded
- Expand/collapse behavior works via click
- Expand/collapse behavior works via keyboard (Enter/Space)
- Keyboard navigation works across nested tree nodes
- Multi-level directory structures work correctly
- Tree state is maintained correctly

This is an integration test that exercises file tree rendering and interaction.

## Current State

- `WorkingDirectoryBrowser` component exists and displays file tree
- Component supports expand/collapse via click
- Component supports expand/collapse via keyboard (Enter/Space)
- Component handles nested directory structures
- No integration tests currently exist for this flow
- Unit tests for component may exist (from TASK-18)

**Reference Implementation**: 
- `src/components/WorkingDirectoryBrowser.tsx`
- `src/api/repositories.ts` for `getWorkingDirectoryFiles` API
- Existing integration test patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-18 are complete (all unit tests for components, APIs, and utilities).

## Checklist

### Preparation and Setup

- [ ] Review `WorkingDirectoryBrowser.tsx` component
- [ ] Review file tree structure and FileNode type
- [ ] Review expand/collapse logic
- [ ] Review keyboard navigation logic
- [ ] Review existing integration test patterns
- [ ] Understand nested tree structures

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/__tests__/working-directory-integration.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Import `WorkingDirectoryBrowser` component
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for working directory integration
  - [ ] Set up MSW handler for `/api/working-directory/files`
  - [ ] Create mock nested file tree data (multiple levels)
  - [ ] Set up test scenarios with different tree structures

- [ ] Step 3: Write tests for initial tree state
  - [ ] Test: File tree loads from API
  - [ ] Test: Top-level directories are initially expanded
  - [ ] Test: Nested directories are initially collapsed
  - [ ] Test: Files are displayed correctly
  - [ ] Test: Tree structure is rendered correctly

- [ ] Step 4: Write tests for expand/collapse via click
  - [ ] Test: Clicking a directory row toggles expansion
  - [ ] Test: Expanded directory shows children
  - [ ] Test: Collapsed directory hides children
  - [ ] Test: Multiple directories can be expanded/collapsed independently
  - [ ] Test: Nested directories can be expanded/collapsed
  - [ ] Test: Files don't toggle expansion (no children)

- [ ] Step 5: Write tests for expand/collapse via keyboard
  - [ ] Test: Pressing Enter on focused directory toggles expansion
  - [ ] Test: Pressing Space on focused directory toggles expansion
  - [ ] Test: Other keys don't trigger expansion
  - [ ] Test: Keyboard navigation works for nested directories
  - [ ] Test: Focus management works correctly

- [ ] Step 6: Write tests for nested tree structures
  - [ ] Test: Multi-level directory structure is rendered correctly
  - [ ] Test: Expanding parent shows children at correct indentation
  - [ ] Test: Nested expand/collapse works correctly
  - [ ] Test: Deep nesting (3+ levels) works correctly
  - [ ] Test: Tree structure is preserved correctly

- [ ] Step 7: Write tests for keyboard navigation
  - [ ] Test: Tab navigation moves focus between tree nodes
  - [ ] Test: Arrow keys navigate tree (if implemented)
  - [ ] Test: Keyboard navigation works across nested levels
  - [ ] Test: Focus is visible and correct

- [ ] Step 8: Write tests for tree state management
  - [ ] Test: Expanded state is maintained correctly
  - [ ] Test: Multiple directories can be expanded simultaneously
  - [ ] Test: Tree state updates correctly on expand/collapse

### Specific Requirements

- [ ] Requirement 1: Tree rendering tested
  - File tree loads correctly
  - Tree structure is rendered correctly
  - Initial expansion state is correct

- [ ] Requirement 2: Expand/collapse tested
  - Click interaction works
  - Keyboard interaction works (Enter/Space)
  - Nested directories work correctly

- [ ] Requirement 3: Keyboard navigation tested
  - Keyboard navigation works
  - Focus management works
  - Navigation works across nested levels

- [ ] Requirement 4: State management tested
  - Tree state is maintained correctly
  - Multiple expansions work correctly
  - State updates correctly

### Error Handling and Edge Cases

- [ ] Handle case: Very deep nesting (10+ levels)
  - Component handles gracefully
  - Rendering doesn't break

- [ ] Handle case: Large number of files in directory
  - Component handles gracefully
  - Performance is acceptable

- [ ] Handle case: Empty directories
  - Component handles gracefully
  - No errors thrown

- [ ] Handle case: Rapid expand/collapse clicks
  - Component handles gracefully
  - State is correct

### Testing

- [ ] Write all integration test cases
- [ ] Use MSW to mock API responses
- [ ] Use userEvent for click and keyboard interactions
- [ ] Test with nested file tree structures
- [ ] Test keyboard navigation carefully
- [ ] Run tests: `npm test -- working-directory-integration.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document keyboard navigation behavior

### Verification

- [ ] Verify all working directory tree integration is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 6: Integration Tests for Critical Flows (Phase 3)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-18 are complete (all unit tests for components, APIs, and utilities)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-18: Add tests for WorkingDirectoryBrowser
- **Important Considerations**: 
  - This is an integration test - test file tree rendering and interaction
  - Use MSW to mock API responses with nested file trees
  - Test expand/collapse with both click and keyboard
  - Test nested tree structures carefully
  - Use userEvent for realistic user interactions
  - Test keyboard navigation thoroughly
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: WorkingDirectoryBrowser component exists but has no integration tests

## Related Tasks

- Previous: TASK-27 (Add integration tests for task list → detail)
- Next: TASK-29 (Add integration tests for conversation flows)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-18: Add tests for WorkingDirectoryBrowser
- Related: TASK-18 (unit tests for WorkingDirectoryBrowser)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive integration tests for the working directory tree behavior.

**Definition of Done**: 

1. **Test file created**:
   - `src/__tests__/working-directory-integration.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Initial tree state tested
   - Expand/collapse via click tested
   - Expand/collapse via keyboard tested
   - Nested tree structures tested
   - Keyboard navigation tested
   - Tree state management tested

3. **Tests pass**:
   - All working directory integration tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - Integration test coverage is adequate
   - Coverage meets project thresholds

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests use userEvent for interactions
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add integration tests for working directory tree`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the working directory browser
   - **I want** comprehensive integration tests that verify file tree rendering, expand/collapse, and keyboard navigation
   - **So that** I can confidently refactor and extend the file tree without breaking functionality

8. **Automated Tests**:
   - All working directory integration tests written and passing
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- working-directory-integration.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/__tests__/working-directory-integration.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (tree rendering, expand/collapse, keyboard navigation, nested structures)
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
