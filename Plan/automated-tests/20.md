# TASK-20: Add tests for `src/api/queues.ts`

**Section**: 4. Unit Tests for Untested API Clients (Phase 2B)
**Subsection**: 4.1 Queue API Client
**Task ID**: TASK-20

## Description

This task creates comprehensive unit tests for the `src/api/queues.ts` API client module. This module provides functions to interact with the Bull MQ queue API endpoints.

The tests will verify:
- `listQueues` function handles successful responses
- `listQueues` function handles non-JSON responses
- `listQueues` function handles error responses (4xx/5xx)
- `getQueueInfo` function handles successful responses
- `getQueueInfo` function handles 404 responses (queue not found)
- `getQueueInfo` function handles non-JSON responses
- `getQueueInfo` function handles other error responses
- Error messages are clear and meaningful
- Response parsing works correctly

This is a pure API client module that requires thorough test coverage of all response scenarios.

## Current State

- `src/api/queues.ts` exists and exports `listQueues` and `getQueueInfo` functions
- Functions use `fetch` API directly
- Functions check content-type before parsing JSON
- Functions handle 404 errors specially
- Functions extract error messages from responses
- No tests currently exist for this module
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/api/queues.ts` (full file)
- Existing API client tests for patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `src/api/queues.ts` code
- [ ] Review MSW handlers from TASK-3 for queues endpoints
- [ ] Review existing API client tests for patterns
- [ ] Understand error handling patterns
- [ ] Understand content-type checking logic

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/api/__tests__/queues.test.ts`
  - [ ] Import necessary testing utilities
  - [ ] Import functions from `../queues`
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe blocks for each function
  - [ ] Set up MSW handlers for `/agents/queues` and `/agents/queues/:name`
  - [ ] Create mock queue data

- [ ] Step 3: Write tests for `listQueues` - success
  - [ ] Test: Successful JSON response returns queue array
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: Queue data structure is correct
  - [ ] Test: Multiple queues are returned correctly

- [ ] Step 4: Write tests for `listQueues` - non-JSON response
  - [ ] Test: Non-JSON response (wrong content-type) throws error
  - [ ] Test: Error message includes content-type information
  - [ ] Test: Error message includes response text (truncated)
  - [ ] Test: Error is thrown with clear message

- [ ] Step 5: Write tests for `listQueues` - error responses
  - [ ] Test: 4xx response returns error with server message
  - [ ] Test: 5xx response returns error with server message
  - [ ] Test: Error response with JSON error payload propagates message
  - [ ] Test: Error response without JSON uses status text
  - [ ] Test: Error messages are clear and meaningful

- [ ] Step 6: Write tests for `getQueueInfo` - success
  - [ ] Test: Successful JSON response returns queue info
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: Queue info structure is correct
  - [ ] Test: All queue fields are present

- [ ] Step 7: Write tests for `getQueueInfo` - 404 response
  - [ ] Test: 404 response throws "Queue not found" error
  - [ ] Test: Error message is clear and specific
  - [ ] Test: Error is thrown correctly

- [ ] Step 8: Write tests for `getQueueInfo` - non-JSON response
  - [ ] Test: Non-JSON response (wrong content-type) throws error
  - [ ] Test: Error message includes content-type information
  - [ ] Test: Error message includes response text (truncated)

- [ ] Step 9: Write tests for `getQueueInfo` - other error responses
  - [ ] Test: 4xx response (not 404) returns error with server message
  - [ ] Test: 5xx response returns error with server message
  - [ ] Test: Error response with JSON error payload propagates message
  - [ ] Test: Error response without JSON uses status text

### Specific Requirements

- [ ] Requirement 1: Success scenarios tested
  - Both functions handle successful responses
  - JSON parsing works correctly
  - Data structures are correct

- [ ] Requirement 2: Non-JSON responses tested
  - Both functions handle non-JSON responses
  - Error messages include content-type
  - Error messages are clear

- [ ] Requirement 3: Error responses tested
  - 4xx errors are handled
  - 5xx errors are handled
  - 404 errors are handled specially for `getQueueInfo`
  - Error messages are extracted correctly

- [ ] Requirement 4: Error messages tested
  - Error messages are clear and meaningful
  - Server-provided messages are used when available
  - Status text is used as fallback

### Error Handling and Edge Cases

- [ ] Handle case: Response has no content-type header
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Response is empty
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: JSON parsing fails
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Network error
  - Function handles gracefully
  - Appropriate error is thrown

### Testing

- [ ] Write all test cases for queues API client
- [ ] Use MSW to mock API responses
- [ ] Test all response scenarios
- [ ] Test error message extraction
- [ ] Run tests: `npm test -- queues.test.ts`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios

### Verification

- [ ] Verify all queues API client functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 4: Unit Tests for Untested API Clients (Phase 2B)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Use MSW handlers from TASK-3 for API mocking
  - Test content-type checking carefully
  - Test error message extraction from responses
  - Test both JSON and non-JSON error responses
  - Test 404 handling specially for `getQueueInfo`
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: queues.ts API client exists but has no tests

## Related Tasks

- Previous: TASK-19 (Add tests for BullMQQueueView)
- Next: TASK-21 (Add tests for src/api/repositories.ts)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-19 (BullMQQueueView uses this API client)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the queues API client module.

**Definition of Done**: 

1. **Test file created**:
   - `src/api/__tests__/queues.test.ts` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - `listQueues` success scenario tested
   - `listQueues` non-JSON response tested
   - `listQueues` error responses tested
   - `getQueueInfo` success scenario tested
   - `getQueueInfo` 404 response tested
   - `getQueueInfo` non-JSON response tested
   - `getQueueInfo` other error responses tested

3. **Tests pass**:
   - All queues API client tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - queues.ts module has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum, ≥90% for API clients)

5. **Code quality**:
   - Tests use MSW for API mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for queues API client`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the queues API client
   - **I want** comprehensive unit tests that verify all response scenarios and error handling
   - **So that** I can confidently refactor and extend the API client without breaking functionality

8. **Automated Tests**:
   - All queues API client tests written and passing
   - Test coverage for module meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- queues.test.ts` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/api/__tests__/queues.test.ts` created with comprehensive tests
- ✅ All scenarios tested (success, non-JSON, errors, 404)
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements (≥90% for API clients)
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
