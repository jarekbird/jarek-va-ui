# TASK-23: Add tests for `getApiBasePath`

**Section**: 5. Unit Tests for Utilities & Bootstrapping (Phase 2C)
**Subsection**: 5.1 API Base Path Utility
**Task ID**: TASK-23

## Description

This task creates comprehensive unit tests for the `getApiBasePath` utility function. This function determines the correct API base path based on the current window location, supporting both local development and production environments with path prefixes.

The tests will verify:
- Function returns `/api` when `window` is undefined (Node.js/test environment)
- Function returns `/conversations/api` when pathname is exactly `/conversations`
- Function returns `/conversations/api` when pathname starts with `/conversations/`
- Function returns `/api` for all other paths
- Function handles edge cases correctly

This is a pure utility function that requires thorough test coverage of all path scenarios.

## Current State

- `getApiBasePath` function exists at `src/utils/api-base.ts`
- Function checks `window` object existence
- Function checks `window.location.pathname`
- Function returns different paths based on pathname
- No tests currently exist for this function

**Reference Implementation**: 
- `src/utils/api-base.ts` (full file)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `src/utils/api-base.ts` code
- [ ] Understand the path matching logic
- [ ] Understand the use cases (local vs production)
- [ ] Review existing utility tests for patterns

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/utils/__tests__/api-base.test.ts`
  - [ ] Import necessary testing utilities
  - [ ] Import function from `../api-base`

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for getApiBasePath
  - [ ] Set up mocks for `window` object
  - [ ] Set up mocks for `window.location.pathname`

- [ ] Step 3: Write tests for Node.js/test environment
  - [ ] Test: When `window` is undefined, returns `/api`
  - [ ] Test: Function handles missing window gracefully
  - [ ] Test: No errors thrown when window is undefined

- [ ] Step 4: Write tests for `/conversations` path
  - [ ] Test: When pathname is exactly `/conversations`, returns `/conversations/api`
  - [ ] Test: When pathname starts with `/conversations/`, returns `/conversations/api`
  - [ ] Test: Path matching works for nested paths (e.g., `/conversations/123`)
  - [ ] Test: Path matching works for deep paths (e.g., `/conversations/123/details`)

- [ ] Step 5: Write tests for other paths
  - [ ] Test: When pathname is `/`, returns `/api`
  - [ ] Test: When pathname is `/tasks`, returns `/api`
  - [ ] Test: When pathname is `/dashboard`, returns `/api`
  - [ ] Test: When pathname is any other path, returns `/api`

- [ ] Step 6: Write tests for edge cases
  - [ ] Test: Empty pathname returns `/api`
  - [ ] Test: Pathname with query string works correctly
  - [ ] Test: Pathname with hash works correctly
  - [ ] Test: Case sensitivity (if applicable)

### Specific Requirements

- [ ] Requirement 1: Window detection tested
  - Function handles undefined window correctly
  - Function uses window when available

- [ ] Requirement 2: Path matching tested
  - Exact match `/conversations` works
  - Prefix match `/conversations/` works
  - Other paths return default

- [ ] Requirement 3: Return values tested
  - Correct path returned for each scenario
  - Path format is correct

- [ ] Requirement 4: Edge cases tested
  - Edge cases are handled gracefully
  - No errors thrown

### Error Handling and Edge Cases

- [ ] Handle case: Window is undefined
  - Function returns `/api`
  - No errors thrown

- [ ] Handle case: Pathname is empty
  - Function handles gracefully
  - Returns appropriate path

- [ ] Handle case: Pathname has query string
  - Function uses pathname only
  - Query string doesn't affect result

- [ ] Handle case: Pathname has hash
  - Function uses pathname only
  - Hash doesn't affect result

### Testing

- [ ] Write all test cases for getApiBasePath
- [ ] Mock `window` object for different scenarios
- [ ] Mock `window.location.pathname` for different paths
- [ ] Test all path scenarios
- [ ] Run tests: `npm test -- api-base.test.ts`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios

### Verification

- [ ] Verify all getApiBasePath functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 5: Unit Tests for Utilities & Bootstrapping (Phase 2C)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not needed for this utility)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Mock `window` object for testing
  - Mock `window.location.pathname` for different scenarios
  - Test both Node.js (undefined window) and browser (window available) scenarios
  - Test path matching logic carefully
  - Use Vitest's mocking capabilities
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: getApiBasePath function exists but has no tests

## Related Tasks

- Previous: TASK-22 (Add tests for src/api/tasks.ts)
- Next: TASK-24 (Add tests for detectBasename)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-21, TASK-22 (API clients use this utility), TASK-24 (similar utility function)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the getApiBasePath utility function.

**Definition of Done**: 

1. **Test file created**:
   - `src/utils/__tests__/api-base.test.ts` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Node.js/test environment tested (undefined window)
   - `/conversations` path tested (exact and prefix match)
   - Other paths tested
   - Edge cases tested

3. **Tests pass**:
   - All getApiBasePath tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - getApiBasePath function has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum, ≥90% for utilities)

5. **Code quality**:
   - Tests use appropriate mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for getApiBasePath utility`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the getApiBasePath utility
   - **I want** comprehensive unit tests that verify path detection and API base path resolution
   - **So that** I can confidently refactor and extend the utility without breaking functionality

8. **Automated Tests**:
   - All getApiBasePath tests written and passing
   - Test coverage for function meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- api-base.test.ts` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/utils/__tests__/api-base.test.ts` created with comprehensive tests
- ✅ All scenarios tested (undefined window, /conversations paths, other paths, edge cases)
- ✅ All tests pass
- ✅ Test coverage meets requirements (≥90% for utilities)
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
