# TASK-30: Add integration tests for agent conversation flows

**Section**: 6. Integration Tests for Critical Flows (Phase 3)
**Subsection**: 6.5 Agent Conversation Flows Integration
**Task ID**: TASK-30

## Description

This task creates comprehensive integration tests for the agent conversation flows. These tests verify pagination, filtering, search, opening details, observing polling updates, manual refresh, and failure paths where backend errors are gracefully surfaced.

The tests will verify:
- Pagination works correctly in list view
- Filters work correctly (agent dropdown, search input)
- Search filters by conversation ID, agent ID, and message content
- Opening detail view works correctly
- Polling updates work correctly in detail view
- Manual refresh works correctly
- Error paths are handled gracefully
- Full flow from list to detail with updates

This is an integration test that exercises the complete agent conversation flow with polling and filtering.

## Current State

- `AgentConversationListView` component exists with pagination, filters, and search
- `AgentConversationDetailView` component exists with polling
- API clients exist for agent conversations
- No integration tests currently exist for this flow
- Unit tests for individual components may exist (from TASK-9, TASK-10)

**Reference Implementation**: 
- `src/components/AgentConversationListView.tsx`
- `src/components/AgentConversationDetailView.tsx`
- `src/api/agent-conversations.ts`
- Existing integration test patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-9, TASK-10 are complete (all unit tests for components, APIs, and utilities).

## Checklist

### Preparation and Setup

- [ ] Review `AgentConversationListView.tsx` component
- [ ] Review `AgentConversationDetailView.tsx` component
- [ ] Review `src/api/agent-conversations.ts` API client
- [ ] Review polling implementation
- [ ] Review filtering and search logic
- [ ] Review existing integration test patterns
- [ ] Understand the agent conversation flow

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/__tests__/agent-flows-integration.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Import `App` or set up routing manually
  - [ ] Set up MSW handlers
  - [ ] Configure fake timers for polling tests

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for agent conversation flows
  - [ ] Set up MSW handlers for agent conversations API (list, get, create)
  - [ ] Create mock agent conversation data with pagination
  - [ ] Set up MemoryRouter starting at `/agent-conversations`
  - [ ] Set up fake timers using `vi.useFakeTimers()`

- [ ] Step 3: Write tests for pagination
  - [ ] Test: Initial load shows first page
  - [ ] Test: "Next" button loads next page
  - [ ] Test: "Previous" button loads previous page
  - [ ] Test: Pagination buttons enable/disable correctly
  - [ ] Test: Page number and total pages displayed correctly
  - [ ] Test: API calls include correct pagination parameters

- [ ] Step 4: Write tests for filters
  - [ ] Test: Agent dropdown filters by agentId
  - [ ] Test: Search input filters by conversation ID
  - [ ] Test: Search input filters by agent ID
  - [ ] Test: Search input filters by message content
  - [ ] Test: "Clear Filters" resets filters
  - [ ] Test: Filters work together (agent + search)
  - [ ] Test: Filtered results are displayed correctly

- [ ] Step 5: Write tests for sort selection
  - [ ] Test: Changing sort option updates backend sortBy mapping
  - [ ] Test: Changing sort order triggers reload
  - [ ] Test: Sort options work correctly
  - [ ] Test: API calls include correct sort parameters

- [ ] Step 6: Write tests for opening detail view
  - [ ] Test: Clicking conversation navigates to detail view
  - [ ] Test: Detail view loads conversation data
  - [ ] Test: Conversation details are displayed correctly
  - [ ] Test: URL changes to `/agent-conversation/:id`

- [ ] Step 7: Write tests for polling updates
  - [ ] Test: After initial load, polling interval is scheduled
  - [ ] Test: Polling calls API at intervals
  - [ ] Test: When new messages arrive, conversation updates
  - [ ] Test: UI reflects polling updates
  - [ ] Test: Polling stops on navigation away

- [ ] Step 8: Write tests for manual refresh
  - [ ] Test: Clicking "Refresh" triggers API call
  - [ ] Test: Conversation updates after refresh
  - [ ] Test: Loading state during refresh
  - [ ] Test: Error during refresh shows error message

- [ ] Step 9: Write tests for failure paths
  - [ ] Test: Backend errors during list load are gracefully surfaced
  - [ ] Test: Backend errors during detail load are gracefully surfaced
  - [ ] Test: Backend errors during polling are handled gracefully
  - [ ] Test: Error messages are clear and actionable
  - [ ] Test: Error states don't break navigation

- [ ] Step 10: Write tests for full flow
  - [ ] Test: Complete flow: list → filter → detail → polling → refresh
  - [ ] Test: Multiple conversations work correctly
  - [ ] Test: Navigation between conversations works
  - [ ] Test: State is preserved correctly during navigation

### Specific Requirements

- [ ] Requirement 1: Pagination tested
  - Pagination works correctly
  - API calls include correct parameters
  - UI updates correctly

- [ ] Requirement 2: Filters tested
  - All filter types work correctly
  - Filters combine correctly
  - Clear filters works

- [ ] Requirement 3: Polling tested
  - Polling works correctly
  - Updates are reflected in UI
  - Polling cleanup works

- [ ] Requirement 4: Error handling tested
  - All error scenarios are handled
  - Error messages are clear
  - Navigation works after errors

### Error Handling and Edge Cases

- [ ] Handle case: Polling request fails
  - Error is handled gracefully
  - Polling continues (or stops, verify behavior)
  - User experience is not disrupted

- [ ] Handle case: Conversation is deleted during polling
  - Error is shown
  - Polling stops
  - Navigation still works

- [ ] Handle case: Rapid filter changes
  - Component handles gracefully
  - No duplicate API calls

### Testing

- [ ] Write all integration test cases
- [ ] Use MSW to mock API responses
- [ ] Use fake timers for polling tests
- [ ] Use MemoryRouter for routing tests
- [ ] Use userEvent for user interactions
- [ ] Test full user flow
- [ ] Run tests: `npm test -- agent-flows-integration.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document polling behavior
- [ ] Document fake timer usage

### Verification

- [ ] Verify all agent conversation flow integration is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements
- [ ] Verify fake timers are properly cleaned up

## Notes

- This task is part of Section 6: Integration Tests for Critical Flows (Phase 3)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-9, TASK-10 are complete (all unit tests for components, APIs, and utilities)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-9: Add tests for AgentConversationListView
  - TASK-10: Add tests for AgentConversationDetailView
- **Important Considerations**: 
  - This is an integration test - test full user flow with polling
  - Use MSW to mock API responses
  - Use fake timers for polling tests
  - Test pagination, filtering, and search carefully
  - Test polling behavior with fake timers
  - Test error scenarios
  - Use userEvent for realistic user interactions
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: Agent conversation components exist but have no integration tests

## Related Tasks

- Previous: TASK-29 (Add integration tests for conversation flows)
- Next: TASK-31 (Add integration tests for voice dashboard)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-9: Add tests for AgentConversationListView
  - TASK-10: Add tests for AgentConversationDetailView
- Related: TASK-9, TASK-10 (unit tests for components used in this integration)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive integration tests for the agent conversation flows with polling and filtering.

**Definition of Done**: 

1. **Test file created**:
   - `src/__tests__/agent-flows-integration.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Pagination tested
   - Filters tested (agent, search)
   - Sort selection tested
   - Opening detail tested
   - Polling updates tested
   - Manual refresh tested
   - Failure paths tested
   - Full flow tested

3. **Tests pass**:
   - All agent conversation flow integration tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors
   - Fake timers are properly managed

4. **Coverage meets requirements**:
   - Integration test coverage is adequate
   - Coverage meets project thresholds

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests use fake timers correctly
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add integration tests for agent conversation flows with polling`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the agent conversation system
   - **I want** comprehensive integration tests that verify pagination, filtering, polling, and error handling
   - **So that** I can confidently refactor and extend the agent conversation system without breaking functionality

8. **Automated Tests**:
   - All agent conversation flow integration tests written and passing
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- agent-flows-integration.test.tsx` and confirm all tests pass
   - Fake timers are properly cleaned up (no hanging tests)

**Acceptance Criteria**:
- ✅ `src/__tests__/agent-flows-integration.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (pagination, filters, polling, refresh, errors, full flow)
- ✅ MSW used for API mocking
- ✅ Fake timers used correctly for polling tests
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
