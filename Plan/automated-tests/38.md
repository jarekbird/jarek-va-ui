# TASK-38: Wire tests into CI/CD

**Section**: 8. Finalization & Ongoing Maintenance
**Subsection**: 8.2 CI/CD Integration
**Task ID**: TASK-38

## Description

This task wires all test commands into the CI/CD pipeline to ensure tests run automatically on every commit and pull request. This includes linting, type checking, unit/integration tests with coverage, and E2E tests.

The CI/CD setup will:
- Run linting on every commit/PR
- Run type checking on every commit/PR
- Run unit/integration tests with coverage on every commit/PR
- Run E2E tests (on main/nightly if runtime is long)
- Mark these checks as required for merges
- Ensure tests must pass before code can be merged

This ensures code quality and prevents regressions from being merged.

## Current State

- Test suite exists (from previous tasks)
- Linting may or may not be configured
- Type checking may or may not be configured
- Coverage reporting may or may not be configured
- E2E tests may exist (from TASK-33)
- CI/CD configuration may or may not exist

**Reference Implementation**: 
- CI/CD platform documentation (GitHub Actions, GitLab CI, etc.)
- Existing CI configuration (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, and all test implementation tasks (TASK-5 through TASK-37) are complete.

## Checklist

### Preparation and Setup

- [ ] Review CI/CD platform (GitHub Actions, GitLab CI, etc.)
- [ ] Review existing CI configuration (if any)
- [ ] Review npm scripts for testing
- [ ] Understand CI/CD best practices
- [ ] Review project requirements for CI

### Implementation Steps

- [ ] Step 1: Locate or create CI configuration
  - [ ] Find existing CI configuration file (`.github/workflows/`, `.gitlab-ci.yml`, etc.)
  - [ ] Or create new CI configuration file
  - [ ] Understand CI platform and syntax

- [ ] Step 2: Configure linting in CI
  - [ ] Add step to run `npm run lint`
  - [ ] Configure step to fail on linting errors
  - [ ] Add step to cache node_modules (if applicable)
  - [ ] Test linting step works

- [ ] Step 3: Configure type checking in CI
  - [ ] Add step to run `npm run type-check`
  - [ ] Configure step to fail on type errors
  - [ ] Test type checking step works

- [ ] Step 4: Configure unit/integration tests in CI
  - [ ] Add step to run `npm run test:coverage`
  - [ ] Configure step to fail if tests fail
  - [ ] Configure step to fail if coverage thresholds are not met
  - [ ] Add step to upload coverage reports (if applicable)
  - [ ] Test test step works

- [ ] Step 5: Configure E2E tests in CI
  - [ ] Add step to run `npm run e2e`
  - [ ] Configure step to run on main branch or nightly (if runtime is long)
  - [ ] Or configure to run on all PRs (if runtime is acceptable)
  - [ ] Configure step to fail if E2E tests fail
  - [ ] Add step to install browsers (for Playwright)
  - [ ] Test E2E step works

- [ ] Step 6: Configure required checks
  - [ ] Mark linting as required for merges
  - [ ] Mark type checking as required for merges
  - [ ] Mark test coverage as required for merges
  - [ ] Mark E2E tests as required for merges (if running on all PRs)
  - [ ] Verify required checks are enforced

- [ ] Step 7: Optimize CI performance
  - [ ] Add caching for node_modules
  - [ ] Add caching for browsers (if applicable)
  - [ ] Parallelize test runs if possible
  - [ ] Optimize test execution time

- [ ] Step 8: Test CI configuration
  - [ ] Create test PR to verify CI runs
  - [ ] Verify all checks run
  - [ ] Verify checks fail appropriately on errors
  - [ ] Verify checks pass on valid code
  - [ ] Verify required checks block merges

### Specific Requirements

- [ ] Requirement 1: Linting in CI
  - Linting runs on every commit/PR
  - Linting fails on errors
  - Linting is required for merges

- [ ] Requirement 2: Type checking in CI
  - Type checking runs on every commit/PR
  - Type checking fails on errors
  - Type checking is required for merges

- [ ] Requirement 3: Tests in CI
  - Unit/integration tests run on every commit/PR
  - Coverage is checked
  - Tests fail if coverage thresholds are not met
  - Tests are required for merges

- [ ] Requirement 4: E2E tests in CI
  - E2E tests run (on main/nightly or all PRs)
  - E2E tests fail on errors
  - E2E tests are required for merges (if running on all PRs)

### Error Handling and Edge Cases

- [ ] Handle case: CI step fails
  - Error is reported clearly
  - PR is blocked from merging
  - Developer can see what failed

- [ ] Handle case: CI times out
  - Timeout is appropriate
  - Tests are optimized
  - Timeout is documented

- [ ] Handle case: Flaky tests in CI
  - Tests are stable
  - Flakiness is addressed
  - Retry logic is considered (if needed)

### Testing

- [ ] Verify CI configuration is correct
- [ ] Test CI runs on test PR
- [ ] Verify all checks run
- [ ] Verify checks fail appropriately
- [ ] Verify checks pass on valid code
- [ ] Verify required checks block merges
- [ ] Test CI performance

### Documentation

- [ ] Document CI/CD setup
- [ ] Document required checks
- [ ] Document how to run CI locally (if applicable)
- [ ] Document CI troubleshooting
- [ ] Update README with CI information (if applicable)

### Verification

- [ ] Verify CI configuration is complete
- [ ] Verify all checks run
- [ ] Verify required checks are enforced
- [ ] Verify CI performance is acceptable

## Notes

- This task is part of Section 8: Finalization & Ongoing Maintenance
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, and all test implementation tasks (TASK-5 through TASK-37) are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required for this task)
  - TASK-4: Configure coverage thresholds (required)
  - All test implementation tasks (TASK-5 through TASK-37)
- **Important Considerations**: 
  - CI should run all quality checks (lint, type-check, test, coverage)
  - E2E tests may run on main/nightly only if runtime is long
  - Required checks should block merges
  - CI should be fast and efficient
  - Caching should be used to speed up CI
  - CI configuration should be version controlled
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: CI/CD may or may not be configured

## Related Tasks

- Previous: TASK-37 (Raise and enforce coverage to target thresholds)
- Next: TASK-39 (Establish contribution rules)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required)
  - TASK-4: Configure coverage thresholds (required)
  - All test implementation tasks (TASK-5 through TASK-37)
- Related: TASK-4 (coverage thresholds), TASK-37 (coverage enforcement), TASK-39 (contribution rules)

## Definition of Done

### Task Type: CONFIGURATION TASK

**Description**: This task involves configuring CI/CD to run all test commands and enforce quality checks.

**Definition of Done**: 

1. **CI configuration created/updated**:
   - CI configuration file exists
   - All test commands are configured
   - Required checks are configured

2. **Linting in CI**:
   - `npm run lint` runs in CI
   - Linting is required for merges
   - Linting fails on errors

3. **Type checking in CI**:
   - `npm run type-check` runs in CI
   - Type checking is required for merges
   - Type checking fails on errors

4. **Tests in CI**:
   - `npm run test:coverage` runs in CI
   - Coverage is checked
   - Tests are required for merges
   - Tests fail if coverage thresholds are not met

5. **E2E tests in CI**:
   - `npm run e2e` runs in CI (on main/nightly or all PRs)
   - E2E tests are required for merges (if running on all PRs)
   - E2E tests fail on errors

6. **Required checks enforced**:
   - All checks are marked as required
   - PRs are blocked if checks fail
   - Checks must pass before merge

7. **Code committed and pushed**:
   - CI configuration file committed
   - Commit message: `feat: wire tests into CI/CD pipeline`
   - Code pushed to origin: `git push origin <branch-name>`

8. **User Story** (as a developer):
   - **As a** developer contributing to the project
   - **I want** CI/CD to automatically run all quality checks
   - **So that** I can ensure code quality and prevent regressions from being merged

9. **Automated Tests**:
   - CI runs all test commands successfully
   - CI fails appropriately on errors
   - CI blocks merges when checks fail
   - Test verification: Create a test PR and verify all CI checks run and are required

**Acceptance Criteria**:
- ✅ CI configuration includes linting, type checking, tests, and E2E tests
- ✅ All checks are marked as required for merges
- ✅ CI runs successfully on test PR
- ✅ CI blocks merges when checks fail
- ✅ All changes committed and pushed to origin

**Configuration is complete, verified to work correctly, and committed to git**
