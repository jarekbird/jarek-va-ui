# TASK-26: Add integration tests for task dashboard flow

**Section**: 6. Integration Tests for Critical Flows (Phase 3)
**Subsection**: 6.2 Task Dashboard Integration
**Task ID**: TASK-26

## Description

This task creates comprehensive integration tests for the Task Dashboard flow. These tests verify that all four panels (file viewer, note-taking, task management, queue view) work together correctly, particularly the orchestration logic where note conversation updates trigger refreshes on both the file browser and task panel.

The tests will verify:
- All four panels render correctly
- Note conversation updates trigger refresh on WorkingDirectoryBrowser
- Note conversation updates trigger refresh on TaskManagementPanel
- Combined loading/error states for panels
- Panel coordination works correctly

This is an integration test that exercises multiple components working together with ref-based communication.

## Current State

- `TaskDashboard` component exists and orchestrates four panels
- `WorkingDirectoryBrowser` exposes `refresh()` via ref
- `TaskManagementPanel` exposes `refresh()` via ref
- `NoteTakingPanel` has `onConversationUpdate` callback
- TaskDashboard calls both refresh methods when notes are updated
- No integration tests currently exist for this flow
- Unit tests for individual components may exist (from TASK-16, TASK-17, TASK-18)

**Reference Implementation**: 
- `src/components/TaskDashboard.tsx`
- `src/components/WorkingDirectoryBrowser.tsx`
- `src/components/TaskManagementPanel.tsx`
- `src/components/NoteTakingPanel.tsx`
- Existing integration test patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-16, TASK-17, TASK-18 are complete (all unit tests for components, APIs, and utilities).

## Checklist

### Preparation and Setup

- [ ] Review `TaskDashboard.tsx` component
- [ ] Review `WorkingDirectoryBrowser` ref interface
- [ ] Review `TaskManagementPanel` ref interface
- [ ] Review `NoteTakingPanel` component and callback
- [ ] Review existing integration test patterns
- [ ] Understand the orchestration logic

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/__tests__/task-dashboard-integration.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Import `TaskDashboard` component
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for TaskDashboard integration
  - [ ] Set up MSW handlers for tasks, file tree, and queue APIs
  - [ ] Create mock data for tasks, files, and queues
  - [ ] Set up spies/mocks for `WorkingDirectoryBrowser.refresh` and `TaskManagementPanel.refresh`

- [ ] Step 3: Write tests for panel rendering
  - [ ] Test: All four panels are rendered (file viewer, note-taking, task management, queue view)
  - [ ] Test: WorkingDirectoryBrowser is rendered with ref
  - [ ] Test: NoteTakingPanel is rendered with correct props
  - [ ] Test: TaskManagementPanel is rendered with ref
  - [ ] Test: BullMQQueueView is rendered

- [ ] Step 4: Write tests for note conversation update flow
  - [ ] Test: When NoteTakingPanel fires `onConversationUpdate`, `WorkingDirectoryBrowser.refresh` is called
  - [ ] Test: When NoteTakingPanel fires `onConversationUpdate`, `TaskManagementPanel.refresh` is called
  - [ ] Test: Both refresh methods are invoked when conversation is updated
  - [ ] Test: Ref methods are called correctly
  - [ ] Test: Multiple updates trigger multiple refreshes

- [ ] Step 5: Write tests for combined loading states
  - [ ] Test: All panels show loading states initially
  - [ ] Test: Panels load independently
  - [ ] Test: Loading states are managed correctly

- [ ] Step 6: Write tests for combined error states
  - [ ] Test: Error in one panel doesn't block other panels
  - [ ] Test: Error states are displayed correctly
  - [ ] Test: Error recovery works correctly

- [ ] Step 7: Write tests for panel coordination
  - [ ] Test: Panels work together correctly
  - [ ] Test: Data flows between panels correctly
  - [ ] Test: Panel updates don't interfere with each other

### Specific Requirements

- [ ] Requirement 1: Panel rendering tested
  - All four panels are rendered
  - Panels receive correct props
  - Refs are attached correctly

- [ ] Requirement 2: Orchestration tested
  - Note conversation updates trigger refreshes
  - Both file browser and task panel are refreshed
  - Ref methods are called correctly

- [ ] Requirement 3: State management tested
  - Combined loading states work correctly
  - Combined error states work correctly
  - Panel coordination works correctly

- [ ] Requirement 4: Integration tested
  - Multiple components work together
  - Ref-based communication works
  - Callback-based communication works

### Error Handling and Edge Cases

- [ ] Handle case: One panel fails to load
  - Other panels still work
  - Error is displayed correctly

- [ ] Handle case: Ref is not available
  - Component handles gracefully
  - No errors thrown

- [ ] Handle case: Multiple rapid conversation updates
  - Component handles gracefully
  - Refreshes are called appropriately

### Testing

- [ ] Write all integration test cases
- [ ] Use MSW to mock API responses
- [ ] Use spies to verify ref method calls
- [ ] Mock child components if needed
- [ ] Run tests: `npm test -- task-dashboard-integration.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document orchestration behavior

### Verification

- [ ] Verify all task dashboard integration is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 6: Integration Tests for Critical Flows (Phase 3)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-16, TASK-17, TASK-18 are complete (all unit tests for components, APIs, and utilities)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-16: Add tests for TaskManagementPanel
  - TASK-17: Add tests for TaskDashboard
  - TASK-18: Add tests for WorkingDirectoryBrowser
- **Important Considerations**: 
  - This is an integration test - test multiple components working together
  - Use MSW to mock API responses for all panels
  - Use spies to verify ref method calls
  - Mock child components if needed to isolate tests
  - Test orchestration logic carefully
  - Test combined loading/error states
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: TaskDashboard and related components exist but have no integration tests

## Related Tasks

- Previous: TASK-25 (Add integration tests for navigation + feature flags)
- Next: TASK-27 (Add integration tests for task list → detail)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-16: Add tests for TaskManagementPanel
  - TASK-17: Add tests for TaskDashboard
  - TASK-18: Add tests for WorkingDirectoryBrowser
- Related: TASK-16, TASK-17, TASK-18 (unit tests for components used in this integration)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive integration tests for the Task Dashboard flow.

**Definition of Done**: 

1. **Test file created**:
   - `src/__tests__/task-dashboard-integration.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Panel rendering tested
   - Note conversation update flow tested
   - Combined loading states tested
   - Combined error states tested
   - Panel coordination tested

3. **Tests pass**:
   - All task dashboard integration tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - Integration test coverage is adequate
   - Coverage meets project thresholds

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests use spies to verify ref calls
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add integration tests for task dashboard flow`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the Task Dashboard
   - **I want** comprehensive integration tests that verify panel orchestration and inter-component communication
   - **So that** I can confidently refactor and extend the dashboard without breaking functionality

8. **Automated Tests**:
   - All task dashboard integration tests written and passing
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- task-dashboard-integration.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/__tests__/task-dashboard-integration.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (panel rendering, orchestration, states, coordination)
- ✅ MSW used for API mocking
- ✅ Ref method calls verified with spies
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
