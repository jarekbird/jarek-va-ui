# TASK-11: Add tests for `AgentConfigView`

**Section**: 3. Unit Tests for Untested Components (Phase 2A)
**Subsection**: 3.2 Agent Conversation Components
**Task ID**: TASK-11

## Description

This task creates comprehensive unit tests for the `AgentConfigView` component. This component displays agent configuration and health status information, with the ability to refresh both config and health data.

The tests will verify:
- Successful loading of both config and health data
- Error handling for config load (blocks UI)
- Error handling for health load (non-critical, logs warning)
- Refresh functionality
- Status color and icon logic for different health statuses
- Integration with MSW for API mocking

This component uses direct fetch calls (not the API client layer) and requires special attention to error handling differences between config and health.

## Current State

- `AgentConfigView` component exists at `src/components/AgentConfigView.tsx`
- Component uses direct `fetch` calls to `/config` and `/config/health`
- Component uses environment variable `VITE_ELEVENLABS_AGENT_URL` for base URL
- Component loads both config and health in parallel on mount
- Component has refresh button that reloads both
- Component displays status colors and icons based on health status
- No tests currently exist for this component
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/components/AgentConfigView.tsx` (full file)
- MSW handlers from TASK-3 (may need to add handlers for `/config` endpoints)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `AgentConfigView.tsx` component code
- [ ] Review status color and icon logic
- [ ] Review MSW handlers from TASK-3 (may need to add `/config` handlers)
- [ ] Understand the difference between config and health error handling
- [ ] Review environment variable usage

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/components/__tests__/AgentConfigView.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Set up MSW handlers for `/config` and `/config/health` endpoints

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for AgentConfigView
  - [ ] Set up MSW handlers for `GET /config` and `GET /config/health`
  - [ ] Create mock config and health data
  - [ ] Mock environment variables if needed

- [ ] Step 3: Write tests for successful load
  - [ ] Test: Component loads both config and health on mount
  - [ ] Test: Config data is displayed correctly (agentId, agentUrl, etc.)
  - [ ] Test: Health data is displayed correctly (service status, dependencies)
  - [ ] Test: Navigation component is rendered
  - [ ] Test: LoadingSpinner shown during load, then hidden
  - [ ] Test: Both API calls happen in parallel (Promise.all)

- [ ] Step 4: Write tests for config error handling
  - [ ] Test: Config load error displays error message
  - [ ] Test: ErrorMessage component receives error message
  - [ ] Test: Config section not displayed when error occurs
  - [ ] Test: Health section still loads even if config fails (if possible)
  - [ ] Test: Different error types (network, 404, 500) are handled

- [ ] Step 5: Write tests for health error handling
  - [ ] Test: Health load failure logs warning to console
  - [ ] Test: Health load failure does not block UI
  - [ ] Test: Config still displays even if health fails
  - [ ] Test: Health section shows appropriate state when health fails

- [ ] Step 6: Write tests for refresh functionality
  - [ ] Test: "Refresh" button triggers both `loadConfig` and `loadHealth`
  - [ ] Test: Button shows "Refreshing..." during refresh
  - [ ] Test: Button is disabled during refresh
  - [ ] Test: Both config and health are reloaded
  - [ ] Test: Error state is cleared on successful refresh
  - [ ] Test: Error during refresh shows error message

- [ ] Step 7: Write tests for status color/icon logic
  - [ ] Test: Status "ok" or "connected" shows green color and checkmark icon
  - [ ] Test: Status "degraded" shows orange/yellow color and warning icon
  - [ ] Test: Status "disconnected" or "unhealthy" shows red color and X icon
  - [ ] Test: Unknown status shows gray color and question mark icon
  - [ ] Test: Status colors apply to service, redis, and cursorRunner statuses
  - [ ] Test: Icons are displayed correctly for each status

- [ ] Step 8: Write tests for environment variable handling
  - [ ] Test: Component uses `VITE_ELEVENLABS_AGENT_URL` if set
  - [ ] Test: Component uses relative paths if env var not set
  - [ ] Test: API calls use correct base URL

### Specific Requirements

- [ ] Requirement 1: API integration tested
  - Both `/config` and `/config/health` endpoints tested
  - MSW handlers work correctly
  - Error responses are handled differently for config vs health

- [ ] Requirement 2: Error handling tested
  - Config errors block UI and show error message
  - Health errors are non-critical and log warnings
  - Both error types are handled correctly

- [ ] Requirement 3: Refresh functionality tested
  - Refresh button works correctly
  - Both endpoints are refreshed
  - Loading state during refresh

- [ ] Requirement 4: Status display tested
  - Status colors are correct for all status types
  - Status icons are correct for all status types
  - Status applies to all health indicators

### Error Handling and Edge Cases

- [ ] Handle case: Config API returns invalid JSON
  - Error message is shown
  - Component doesn't crash

- [ ] Handle case: Health API returns invalid JSON
  - Warning is logged
  - Component continues to function

- [ ] Handle case: Both config and health fail
  - Config error is shown
  - Health failure is logged
  - UI is still functional

- [ ] Handle case: Environment variable changes
  - Component uses correct base URL
  - API calls go to correct endpoints

### Testing

- [ ] Write all test cases for AgentConfigView
- [ ] Use MSW to mock API responses
- [ ] Mock console.warn to verify health error logging
- [ ] Use userEvent for button clicks
- [ ] Run tests: `npm test -- AgentConfigView.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document environment variable handling

### Verification

- [ ] Verify all AgentConfigView functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 3: Unit Tests for Untested Components (Phase 2A)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking, may need to add `/config` handlers)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Component uses direct `fetch`, not API client layer
  - Health errors are non-critical (log warning, don't block UI)
  - Config errors are critical (show error, block UI)
  - May need to add MSW handlers for `/config` and `/config/health` if not in TASK-3
  - Environment variable handling may need mocking
  - Use `vi.spyOn(console, 'warn')` to verify health error logging
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: AgentConfigView component exists but has no tests

## Related Tasks

- Previous: TASK-10 (Add tests for AgentConversationDetailView)
- Next: TASK-12 (Add tests for TaskList)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required, may need to extend handlers)
  - TASK-4: Configure coverage thresholds
- Related: None

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the AgentConfigView component.

**Definition of Done**: 

1. **Test file created**:
   - `src/components/__tests__/AgentConfigView.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Successful load tested (config and health)
   - Config error handling tested
   - Health error handling tested (non-critical)
   - Refresh functionality tested
   - Status color/icon logic tested
   - Environment variable handling tested

3. **Tests pass**:
   - All AgentConfigView tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - AgentConfigView component has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum)

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests verify console.warn for health errors
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - MSW handler updates committed (if needed)
   - Commit message: `test: add comprehensive tests for AgentConfigView component`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the AgentConfigView component
   - **I want** comprehensive unit tests that verify config/health loading, error handling, and status display
   - **So that** I can confidently refactor and extend the component without breaking functionality

8. **Automated Tests**:
   - All AgentConfigView tests written and passing
   - Test coverage for component meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- AgentConfigView.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/components/__tests__/AgentConfigView.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (load, errors, refresh, status display)
- ✅ MSW used for API mocking (handlers added if needed)
- ✅ Health error logging verified
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
