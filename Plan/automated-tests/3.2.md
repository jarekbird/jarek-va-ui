# TASK-3.2: Create MSW mock handlers for all API endpoints

**Section**: 2. Testing Infrastructure Enhancements (Phase 1)
**Subsection**: 2.1
**Task ID**: TASK-3.2
**Parent Task**: TASK-3
**Order**: 2 of 4

## Description

This task creates MSW mock handlers for all API endpoints used by the application. Handlers define how MSW should respond to network requests, allowing tests to control API responses without depending on a real backend.

The handlers will cover:
- Conversations API endpoints (list, get, create)
- Agent conversations API endpoints (list, get, create with pagination)
- Tasks API endpoints (list, get, create with filtering/sorting)
- Queues API endpoints (list, get)
- Repository/working directory file endpoints
- Support for query parameters, path parameters, and error responses

This is a critical step that enables all future tests to mock API calls reliably.

## Current State

- MSW should be installed (from TASK-3.1)
- `src/test/mocks/` directory may not exist
- No MSW handlers exist
- API endpoints that need mocking:
  - `/api/conversations` and `/api/conversations/:id`
  - `/api/agent-conversations` and `/api/agent-conversations/:id`
  - `/api/tasks` and `/api/tasks/:id`
  - `/agents/queues` and `/agents/queues/:name`
  - `/repositories/api/:repository/files`
  - `/api/working-directory/files`
  - `/conversations/api/*` (when using `getApiBasePath`)

**Reference Implementation**: 
- MSW documentation: https://mswjs.io/docs/
- Existing API clients in `src/api/` directory
- `src/utils/api-base.ts` for path resolution

**Important**: This task should be executed after TASK-3.1 is complete.

## Checklist

### Preparation and Setup

- [ ] Review MSW handler documentation and best practices
- [ ] Review existing API client files to understand endpoint structure
- [ ] Review `src/utils/api-base.ts` to understand path resolution
- [ ] Understand the API response formats from existing code
- [ ] Review actual API response structures (if available)

### Implementation Steps

- [ ] Step 1: Create handlers directory and file
  - [ ] Create directory `src/test/mocks/` if it doesn't exist
  - [ ] Create `src/test/mocks/handlers.ts`
  - [ ] Import `http` from `msw`
  - [ ] Set up basic file structure

- [ ] Step 2: Create conversation handlers
  - [ ] Create handler for `GET /api/conversations`:
    - Returns array of conversation objects
    - Supports query parameters if needed
  - [ ] Create handler for `GET /api/conversations/:id`:
    - Returns single conversation object
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/conversations`:
    - Accepts conversation data in body
    - Returns created conversation with ID

- [ ] Step 3: Create agent conversation handlers
  - [ ] Create handler for `GET /api/agent-conversations`:
    - Returns paginated response with conversations and pagination metadata
    - Supports query parameters: limit, offset, sortBy, sortOrder
  - [ ] Create handler for `GET /api/agent-conversations/:id`:
    - Returns single agent conversation
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/agent-conversations`:
    - Returns created agent conversation

- [ ] Step 4: Create task handlers
  - [ ] Create handler for `GET /api/tasks`:
    - Returns array of tasks or paginated response
    - Supports query parameters: page, limit, status, status_label, conversation_id, sortBy, sortOrder
  - [ ] Create handler for `GET /api/tasks/:id`:
    - Returns single task
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/tasks`:
    - Accepts `{ prompt: string }` in body
    - Returns created task

- [ ] Step 5: Create queue handlers
  - [ ] Create handler for `GET /agents/queues`:
    - Returns `{ queues: QueueInfo[] }`
  - [ ] Create handler for `GET /agents/queues/:name`:
    - Returns single queue info
    - Handles 404 for non-existent queue names

- [ ] Step 6: Create repository/working directory handlers
  - [ ] Create handler for `GET /repositories/api/:repository/files`:
    - Returns file tree structure
    - Handles 404 for non-existent repositories
  - [ ] Create handler for `GET /api/working-directory/files`:
    - Returns file tree for working directory
    - Handles 404 if working directory not found

- [ ] Step 7: Create handlers for alternative path patterns
  - [ ] Create handlers for `/conversations/api/*` paths (using path matching):
    - Handles same endpoints but with `/conversations/api` prefix
    - Supports path matching for dynamic segments

- [ ] Step 8: Export handlers
  - [ ] Export all handlers as an array
  - [ ] Ensure handlers are properly typed
  - [ ] Add JSDoc comments for each handler

### Specific Requirements

- [ ] Requirement 1: All endpoints have handlers
  - All API endpoints used by the app have handlers
  - Handlers match actual API paths exactly
  - Path parameters are handled correctly

- [ ] Requirement 2: Realistic response data
  - Handlers return realistic response data matching actual API responses
  - Response structures match TypeScript types
  - Data includes required fields

- [ ] Requirement 3: Query parameter support
  - Handlers support required query parameters
  - Query parameters are parsed correctly
  - Handlers respond appropriately to different parameter values

- [ ] Requirement 4: Error handling
  - Error cases (404, 500) are handled
  - Error responses match actual API error format
  - Error messages are clear

### Error Handling and Edge Cases

- [ ] Handle case: Handler conflicts with real network
  - Ensure handlers match actual API paths exactly
  - Check path matching for dynamic routes
  - Verify no path conflicts

- [ ] Handle case: Path resolution issues
  - Test handlers with both `/api/*` and `/conversations/api/*` paths
  - Verify `getApiBasePath()` works with MSW
  - Test path matching for dynamic segments

- [ ] Handle case: Missing query parameters
  - Handlers handle missing optional parameters
  - Default values are used when appropriate

- [ ] Handle case: Invalid path parameters
  - Handlers handle invalid IDs gracefully
  - 404 responses are returned for non-existent resources

### Testing

- [ ] Write test to verify handlers work
  - Create a simple test that makes a fetch request
  - Verify the request is intercepted by MSW
  - Verify the handler response is returned correctly

- [ ] Run type checking: `npm run type-check`
  - Verify no type errors in handlers file
  - Fix any TypeScript issues

- [ ] Run linting: `npm run lint`
  - Fix any linting issues in handlers file

### Documentation

- [ ] Add JSDoc comments to handler functions
- [ ] Document handler response formats
- [ ] Document query parameter support
- [ ] Document error response formats
- [ ] Add comments explaining handler logic

### Verification

- [ ] Verify all handlers are created
- [ ] Verify handlers return correct response structures
- [ ] Verify error cases are handled
- [ ] Verify query parameters are supported

## Notes

- This task is part of **Section 2: Testing Infrastructure Enhancements (Phase 1)**
- **Execution Timing**: Execute after TASK-3.1 is complete
- **Dependencies**: 
  - TASK-3.1: Install MSW package (must be complete)
- **Important Considerations**: 
  - Handlers should return realistic data matching actual API responses
  - Use `http` from `msw` for creating handlers
  - Path matching must account for both `/api/*` and `/conversations/api/*` patterns
  - Handlers should support all query parameters used by the application
- **Task Independence**: Can be completed independently after TASK-3.1
- **Current State**: MSW handlers do not exist

## Related Tasks

- Parent: TASK-3 (Introduce MSW for network mocking)
- Previous: TASK-3.1 (Install MSW package)
- Next: TASK-3.3 (Create MSW server configuration)
- Dependencies:
  - TASK-3.1: Install MSW package

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**Description**: This task involves creating MSW mock handlers for all API endpoints.

**Definition of Done**: 

1. **Handlers file created**:
   - `src/test/mocks/handlers.ts` exists
   - File follows project conventions and patterns

2. **All handlers created**:
   - Handlers for all API endpoints exist
   - Handlers return realistic response data
   - Error cases (404, 500) are handled
   - Query parameters are supported

3. **Handlers tested**:
   - Simple verification test confirms handlers work
   - Type checking passes
   - Linting passes

4. **Code committed and pushed**:
   - `src/test/mocks/handlers.ts` committed
   - Commit message: `feat: create MSW handlers for all API endpoints`
   - Code pushed to origin: `git push origin <branch-name>`

5. **User Story** (as a developer):
   - **As a** developer writing tests
   - **I want** MSW handlers for all API endpoints
   - **So that** I can mock API responses in tests without depending on a real backend

6. **Automated Tests**:
   - Simple verification test confirms handlers work
   - Test verification: Create a test that makes a fetch request and verifies MSW intercepts it

**Acceptance Criteria**:
- ✅ `src/test/mocks/handlers.ts` created with handlers for all API endpoints
- ✅ Handlers return realistic response data
- ✅ Error cases (404, 500) are handled
- ✅ Query parameters are supported
- ✅ All changes committed and pushed to origin

**A Pull Request was created OR code was pushed to origin with the task complete**










