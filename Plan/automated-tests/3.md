# TASK-3: Introduce MSW (Mock Service Worker) for network mocking

**Section**: 2. Testing Infrastructure Enhancements (Phase 1)
**Subsection**: 2.1
**Task ID**: TASK-3

## Description

This task introduces Mock Service Worker (MSW) as the network mocking solution for the jarek-va-ui test suite. MSW intercepts network requests at the service worker level, allowing us to mock API responses in a realistic way without modifying the application code or using complex mocking libraries.

MSW will be used to:
- Mock all API endpoints used by the application
- Provide consistent test data across test suites
- Test error scenarios (404, 500, network errors)
- Test different response scenarios without backend dependencies

This infrastructure is critical for writing reliable, isolated unit and integration tests for components that make API calls.

## Current State

- MSW is not currently installed or configured
- Tests may be using manual fetch mocking or no mocking at all
- API endpoints that need mocking:
  - `/api/conversations` and `/api/conversations/:id`
  - `/api/agent-conversations` and `/api/agent-conversations/:id`
  - `/api/tasks` and `/api/tasks/:id`
  - `/agents/queues` and `/agents/queues/:name`
  - `/repositories/api/:repository/files`
  - `/conversations/api/*` (when using `getApiBasePath`)

**Reference Implementation**: 
- MSW documentation: https://mswjs.io/docs/
- Existing API clients in `src/api/` directory

**Important**: This task should be executed after TASK-1 and TASK-2 are complete.

## Checklist

### Preparation and Setup

- [ ] Review MSW documentation and best practices
- [ ] Review existing API client files to understand endpoint structure
- [ ] Review `src/utils/api-base.ts` to understand path resolution
- [ ] Check `package.json` for current dependencies
- [ ] Understand the API response formats from existing code

### Implementation Steps

- [ ] Step 1: Install MSW
  - [ ] Run `npm install --save-dev msw`
  - [ ] Verify MSW is added to `package.json` devDependencies
  - [ ] Verify installation completes without errors

- [ ] Step 2: Create mock handlers
  - [ ] Create directory `src/test/mocks/` if it doesn't exist
  - [ ] Create `src/test/mocks/handlers.ts`
  - [ ] Import `http` from `msw`
  - [ ] Create handler for `GET /api/conversations`:
    - Returns array of conversation objects
    - Supports query parameters if needed
  - [ ] Create handler for `GET /api/conversations/:id`:
    - Returns single conversation object
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/conversations`:
    - Returns created conversation with ID
  - [ ] Create handler for `GET /api/agent-conversations`:
    - Returns paginated response with conversations and pagination metadata
    - Supports query parameters: limit, offset, sortBy, sortOrder
  - [ ] Create handler for `GET /api/agent-conversations/:id`:
    - Returns single agent conversation
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/agent-conversations`:
    - Returns created agent conversation
  - [ ] Create handler for `GET /api/tasks`:
    - Returns array of tasks or paginated response
    - Supports query parameters: page, limit, status, status_label, conversation_id, sortBy, sortOrder
  - [ ] Create handler for `GET /api/tasks/:id`:
    - Returns single task
    - Handles 404 for non-existent IDs
  - [ ] Create handler for `POST /api/tasks`:
    - Accepts `{ prompt: string }` in body
    - Returns created task
  - [ ] Create handler for `GET /agents/queues`:
    - Returns `{ queues: QueueInfo[] }`
  - [ ] Create handler for `GET /agents/queues/:name`:
    - Returns single queue info
    - Handles 404 for non-existent queue names
  - [ ] Create handler for `GET /repositories/api/:repository/files`:
    - Returns file tree structure
    - Handles 404 for non-existent repositories
  - [ ] Create handler for `GET /api/working-directory/files`:
    - Returns file tree for working directory
    - Handles 404 if working directory not found
  - [ ] Create handlers for `/conversations/api/*` paths (using path matching):
    - Handles same endpoints but with `/conversations/api` prefix
  - [ ] Export all handlers as an array

- [ ] Step 3: Create MSW server configuration
  - [ ] Create `src/test/mocks/server.ts`
  - [ ] Import `setupServer` from `msw/node`
  - [ ] Import handlers from `./handlers`
  - [ ] Create server instance: `setupServer(...handlers)`
  - [ ] Export the server instance

- [ ] Step 4: Wire MSW into test setup
  - [ ] Open `src/test/setup.ts`
  - [ ] Import server from `./mocks/server`
  - [ ] Add `beforeAll` hook to start server: `server.listen({ onUnhandledRequest: 'error' })`
  - [ ] Add `afterEach` hook to reset handlers: `server.resetHandlers()`
  - [ ] Add `afterAll` hook to close server: `server.close()`
  - [ ] Ensure this doesn't conflict with existing cleanup

- [ ] Step 5: Verify MSW integration
  - [ ] Run a subset of existing tests: `npm test -- src/__tests__/App.test.tsx`
  - [ ] Verify tests still pass
  - [ ] Check for any MSW-related errors
  - [ ] Verify network requests are being intercepted
  - [ ] Fix any issues that arise

### Specific Requirements

- [ ] Requirement 1: MSW installed
  - `msw` package is in `package.json` devDependencies
  - Package is installed in `node_modules/`
  - No installation errors

- [ ] Requirement 2: Handlers created for all endpoints
  - All API endpoints used by the app have handlers
  - Handlers return realistic response data
  - Handlers support required query parameters
  - Error cases (404, 500) are handled

- [ ] Requirement 3: Server configured
  - Server instance is created with all handlers
  - Server is exported for use in tests
  - Server configuration is correct

- [ ] Requirement 4: MSW integrated into test setup
  - Server starts before all tests
  - Handlers reset between tests
  - Server closes after all tests
  - No conflicts with existing test setup

- [ ] Requirement 5: Existing tests still pass
  - All existing tests pass with MSW enabled
  - No test failures introduced by MSW
  - Network requests are properly intercepted

### Error Handling and Edge Cases

- [ ] Handle case: MSW installation fails
  - Check Node.js version compatibility
  - Verify npm registry access
  - Check for dependency conflicts

- [ ] Handle case: Handler conflicts with real network
  - Ensure `onUnhandledRequest: 'error'` catches unmocked requests
  - Verify handlers match actual API paths exactly
  - Check path matching for dynamic routes

- [ ] Handle case: Tests fail after MSW integration
  - Check if tests were relying on real network calls
  - Verify handler responses match expected formats
  - Ensure handlers return correct status codes

- [ ] Handle case: Path resolution issues
  - Test handlers with both `/api/*` and `/conversations/api/*` paths
  - Verify `getApiBasePath()` works with MSW
  - Test path matching for dynamic segments

### Testing

- [ ] Write test to verify MSW is working
  - Create a simple test that makes a fetch request
  - Verify the request is intercepted by MSW
  - Verify the handler response is returned

- [ ] Run existing tests: `npm test`
  - Verify all tests pass
  - Check for any MSW-related warnings or errors
  - Verify no tests are making real network requests

- [ ] Run type checking: `npm run type-check`
  - Verify no type errors in MSW setup files
  - Fix any TypeScript issues

- [ ] Run linting: `npm run lint`
  - Fix any linting issues in new files

### Documentation

- [ ] Add JSDoc comments to handler functions
- [ ] Document handler response formats
- [ ] Add comments explaining MSW setup in `setup.ts`
- [ ] Document how to add new handlers
- [ ] Update test README if it exists

### Verification

- [ ] Verify MSW is installed correctly
- [ ] Verify all handlers are created
- [ ] Verify server is configured
- [ ] Verify MSW is integrated into test setup
- [ ] Verify existing tests pass
- [ ] Verify network requests are intercepted

## Notes

- This task is part of Section 2: Testing Infrastructure Enhancements (Phase 1)
- **Execution Timing**: Execute after TASK-1 and TASK-2 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup (must be complete)
  - TASK-2: Review existing test utilities (must be complete)
- **Important Considerations**: 
  - MSW uses service workers in the browser, but for Node.js (Vitest), we use `msw/node`
  - Handlers should return realistic data matching actual API responses
  - Use `onUnhandledRequest: 'error'` to catch unmocked requests during development
  - Path matching must account for both `/api/*` and `/conversations/api/*` patterns
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: MSW is not installed or configured

## Related Tasks

- Previous: TASK-2 (Review existing test utilities)
- Next: TASK-4 (Configure and enforce coverage thresholds)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
- Related: All future test tasks will use MSW for API mocking

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**Description**: This task involves installing MSW, creating mock handlers, configuring the server, and integrating it into the test setup.

**Definition of Done**: 

1. **MSW installed**:
   - `msw` package added to `package.json` devDependencies
   - Package installed successfully in `node_modules/`

2. **Handlers created**:
   - `src/test/mocks/handlers.ts` created with handlers for all API endpoints
   - Handlers return realistic response data
   - Error cases (404, 500) are handled

3. **Server configured**:
   - `src/test/mocks/server.ts` created and exports server instance
   - Server configured with all handlers

4. **MSW integrated**:
   - `src/test/setup.ts` updated to start/stop/reset MSW server
   - Server lifecycle properly managed (beforeAll, afterEach, afterAll)

5. **Tests pass**:
   - All existing tests pass: `npm test` completes successfully
   - No test failures introduced by MSW
   - Network requests are properly intercepted

6. **Code committed and pushed**:
   - All new files committed (handlers.ts, server.ts)
   - All modified files committed (setup.ts, package.json, package-lock.json)
   - Commit message: `feat: introduce MSW for network mocking in tests`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer writing tests
   - **I want** to mock API responses using MSW
   - **So that** I can write isolated, reliable tests without depending on a real backend

8. **Automated Tests**:
   - Create a simple verification test that confirms MSW is working
   - All existing tests must pass: `npm test` must complete successfully
   - Test verification: Run `npm test` and confirm all tests pass with MSW enabled

**Acceptance Criteria**:
- ✅ MSW installed as dev dependency
- ✅ `src/test/mocks/handlers.ts` created with all required handlers
- ✅ `src/test/mocks/server.ts` created and configured
- ✅ `src/test/setup.ts` updated to integrate MSW
- ✅ All existing tests pass with MSW enabled
- ✅ All changes committed and pushed to origin

**A Pull Request was created OR code was pushed to origin with the task complete**
