# TASK-29: Add integration tests for conversation flows (note-taking)

**Section**: 6. Integration Tests for Critical Flows (Phase 3)
**Subsection**: 6.5 Conversation Flows Integration
**Task ID**: TASK-29

## Description

This task creates comprehensive integration tests for the note-taking conversation flows. These tests verify the complete user journey from loading the conversation list, creating a new conversation, navigating to detail view, updating the conversation, and verifying UI updates.

The tests will verify:
- Conversation list loads and displays conversations
- Creating a new conversation works correctly
- Navigation to conversation detail works
- Conversation detail displays correctly
- Updating conversation works correctly
- UI updates reflect changes
- Error paths are handled gracefully

This is an integration test that exercises the full conversation flow from list to detail to update.

## Current State

- `ConversationListView` component exists and displays conversation list
- `ConversationDetailView` component exists and displays conversation details
- `ConversationDetails` component handles conversation updates
- API clients exist for conversations (`listConversations`, `createConversation`, `getConversationById`)
- No integration tests currently exist for this flow
- Unit tests for individual components may exist (from TASK-6, TASK-7)

**Reference Implementation**: 
- `src/components/ConversationListView.tsx`
- `src/components/ConversationDetailView.tsx`
- `src/components/ConversationDetails.tsx`
- `src/api/conversations.ts`
- Existing integration test patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-6, TASK-7 are complete (all unit tests for components, APIs, and utilities).

## Checklist

### Preparation and Setup

- [ ] Review `ConversationListView.tsx` component
- [ ] Review `ConversationDetailView.tsx` component
- [ ] Review `ConversationDetails.tsx` component
- [ ] Review `src/api/conversations.ts` API client
- [ ] Review existing integration test patterns
- [ ] Understand the conversation flow

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/__tests__/note-flows-integration.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Import `App` or set up routing manually
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for conversation flows
  - [ ] Set up MSW handlers for conversations API (list, create, get, update)
  - [ ] Create mock conversation data
  - [ ] Set up MemoryRouter starting at `/`

- [ ] Step 3: Write tests for initial list load
  - [ ] Test: Conversation list loads from API
  - [ ] Test: Conversations are displayed correctly
  - [ ] Test: Loading state is shown then hidden
  - [ ] Test: Empty state is shown when no conversations

- [ ] Step 4: Write tests for creating new conversation
  - [ ] Test: Clicking "+ New Note" creates new conversation
  - [ ] Test: `createConversation` API is called
  - [ ] Test: Navigation to detail view occurs
  - [ ] Test: Conversation list is reloaded after creation
  - [ ] Test: New conversation appears in list

- [ ] Step 5: Write tests for navigation to detail
  - [ ] Test: Clicking a conversation navigates to detail view
  - [ ] Test: URL changes to `/conversation/:id`
  - [ ] Test: Detail view loads conversation data
  - [ ] Test: Conversation details are displayed correctly

- [ ] Step 6: Write tests for updating conversation
  - [ ] Test: Updating conversation calls API
  - [ ] Test: Conversation data is updated
  - [ ] Test: UI reflects updates correctly
  - [ ] Test: Updates persist correctly

- [ ] Step 7: Write tests for error paths
  - [ ] Test: Error during list load shows error message
  - [ ] Test: Error during creation shows error message
  - [ ] Test: Error during detail load shows error message
  - [ ] Test: Error during update shows error message
  - [ ] Test: Error states don't break navigation
  - [ ] Test: Retry functionality works

- [ ] Step 8: Write tests for full flow
  - [ ] Test: Complete flow: list → create → detail → update → verify
  - [ ] Test: Multiple conversations work correctly
  - [ ] Test: Navigation between conversations works
  - [ ] Test: State is preserved correctly during navigation

### Specific Requirements

- [ ] Requirement 1: List view tested
  - Conversation list loads correctly
  - Conversations are displayed correctly
  - Loading and error states work

- [ ] Requirement 2: Creation tested
  - New conversation creation works
  - Navigation occurs correctly
  - List is updated correctly

- [ ] Requirement 3: Detail view tested
  - Conversation details load correctly
  - Conversation information is displayed correctly
  - Updates work correctly

- [ ] Requirement 4: Error handling tested
  - All error scenarios are handled
  - Error messages are clear
  - Navigation works after errors

### Error Handling and Edge Cases

- [ ] Handle case: Conversation is deleted between list and detail load
  - 404 error is shown
  - Navigation still works

- [ ] Handle case: Network error during creation
  - Error message is shown
  - User can retry

- [ ] Handle case: Rapid conversation creation
  - Component handles gracefully
  - No duplicate conversations

### Testing

- [ ] Write all integration test cases
- [ ] Use MSW to mock API responses
- [ ] Use MemoryRouter for routing tests
- [ ] Use userEvent for user interactions
- [ ] Test full user flow
- [ ] Run tests: `npm test -- note-flows-integration.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document conversation flow

### Verification

- [ ] Verify all conversation flow integration is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 6: Integration Tests for Critical Flows (Phase 3)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-6, TASK-7 are complete (all unit tests for components, APIs, and utilities)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-6: Add tests for ConversationListView
  - TASK-7: Add tests for ConversationDetailView
- **Important Considerations**: 
  - This is an integration test - test full user flow
  - Use MSW to mock API responses
  - Use MemoryRouter for routing tests
  - Test complete flow from list to detail to update
  - Test error scenarios
  - Use userEvent for realistic user interactions
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: Conversation components exist but have no integration tests

## Related Tasks

- Previous: TASK-28 (Add integration tests for working directory tree)
- Next: TASK-30 (Add integration tests for agent conversation flows)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-6: Add tests for ConversationListView
  - TASK-7: Add tests for ConversationDetailView
- Related: TASK-6, TASK-7 (unit tests for components used in this integration)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive integration tests for the note-taking conversation flows.

**Definition of Done**: 

1. **Test file created**:
   - `src/__tests__/note-flows-integration.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Initial list load tested
   - Creating new conversation tested
   - Navigation to detail tested
   - Updating conversation tested
   - Error paths tested
   - Full flow tested

3. **Tests pass**:
   - All conversation flow integration tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - Integration test coverage is adequate
   - Coverage meets project thresholds

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests use MemoryRouter for routing
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add integration tests for note-taking conversation flows`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the conversation system
   - **I want** comprehensive integration tests that verify the complete conversation flow from list to detail to update
   - **So that** I can confidently refactor and extend the conversation system without breaking functionality

8. **Automated Tests**:
   - All conversation flow integration tests written and passing
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- note-flows-integration.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/__tests__/note-flows-integration.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (list, create, detail, update, errors, full flow)
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
