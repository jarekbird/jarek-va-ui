# TASK-35: Add visual regression tests (optional)

**Section**: 7. E2E, Accessibility, and Regression Tests (Phase 4)
**Subsection**: 7.4 Visual Regression Testing
**Task ID**: TASK-35

## Description

This task adds visual regression testing to catch unintended visual changes in the UI. Visual regression tests capture screenshots of critical pages and compare them against baseline images to detect visual differences.

The tests will:
- Capture baseline screenshots for critical pages
- Compare screenshots on future runs
- Detect visual regressions
- Store baseline images
- Report visual differences

This is an optional but valuable addition to the test suite that helps catch UI regressions.

## Current State

- E2E framework should be set up (from TASK-32)
- E2E tests may exist (from TASK-33)
- No visual regression testing is currently set up
- No baseline screenshots exist

**Reference Implementation**: 
- Playwright screenshot documentation: https://playwright.dev/docs/test-screenshots
- Cypress screenshot documentation: https://docs.cypress.io/api/commands/screenshot
- Visual regression testing best practices

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-32, TASK-33 are complete (all unit tests, integration tests, and E2E framework setup). This task is optional.

## Checklist

### Preparation and Setup

- [ ] Review E2E framework screenshot capabilities
- [ ] Review visual regression testing tools
- [ ] Review application critical pages
- [ ] Understand visual regression testing best practices
- [ ] Decide on visual regression approach (screenshots vs dedicated tool)

### Implementation Steps

- [ ] Step 1: Choose visual regression approach
  - [ ] Evaluate options: Playwright screenshots, Cypress screenshots, or dedicated tool (e.g., Percy, Chromatic)
  - [ ] Choose approach (recommended: Playwright screenshots for simplicity)
  - [ ] Document choice and rationale

- [ ] Step 2: Configure screenshot capture
  - [ ] Configure E2E framework to capture screenshots
  - [ ] Set up screenshot directory structure
  - [ ] Configure screenshot comparison (if using framework built-in)
  - [ ] Or integrate dedicated visual regression tool

- [ ] Step 3: Create baseline screenshots
  - [ ] Capture baseline for conversation list page
  - [ ] Capture baseline for conversation detail page
  - [ ] Capture baseline for task list page
  - [ ] Capture baseline for task detail page
  - [ ] Capture baseline for task dashboard
  - [ ] Store baselines in appropriate location (e.g., `e2e/screenshots/baseline/`)

- [ ] Step 4: Write visual regression tests
  - [ ] Test: Conversation list matches baseline
  - [ ] Test: Conversation detail matches baseline
  - [ ] Test: Task list matches baseline
  - [ ] Test: Task detail matches baseline
  - [ ] Test: Task dashboard matches baseline
  - [ ] Test: Screenshots are compared against baselines

- [ ] Step 5: Configure screenshot comparison
  - [ ] Set up screenshot comparison logic
  - [ ] Configure threshold for differences (pixel tolerance)
  - [ ] Configure failure handling
  - [ ] Set up diff image generation (if applicable)

- [ ] Step 6: Add npm scripts
  - [ ] Add `npm run e2e:visual` script for visual regression tests
  - [ ] Add `npm run e2e:visual:update` script to update baselines
  - [ ] Verify scripts work correctly

- [ ] Step 7: Configure CI integration (if applicable)
  - [ ] Update CI to run visual regression tests
  - [ ] Configure CI to store baseline images
  - [ ] Configure CI to handle visual diffs
  - [ ] Test CI integration

### Specific Requirements

- [ ] Requirement 1: Screenshot capture configured
  - Screenshots can be captured
  - Screenshot directory structure is set up
  - Baselines can be stored

- [ ] Requirement 2: Baseline screenshots created
  - Baselines exist for critical pages
  - Baselines are stored correctly
  - Baselines represent current UI state

- [ ] Requirement 3: Comparison works
  - Screenshots are compared against baselines
  - Differences are detected
  - Diff images are generated (if applicable)

- [ ] Requirement 4: Tests work
  - Visual regression tests pass
  - Tests can be run via npm scripts
  - Tests fail when visual changes are detected

### Error Handling and Edge Cases

- [ ] Handle case: Baseline doesn't exist
  - Test creates baseline or fails with clear message
  - User can update baselines easily

- [ ] Handle case: Visual differences are detected
  - Differences are reported clearly
  - Diff images are generated (if applicable)
  - User can review and approve changes

- [ ] Handle case: Flaky visual tests
  - Tests are stable
  - Thresholds are appropriate
  - False positives are minimized

### Testing

- [ ] Verify screenshot capture works
- [ ] Verify baseline screenshots are created
- [ ] Verify screenshot comparison works
- [ ] Run visual regression tests: `npm run e2e:visual`
- [ ] Verify tests pass
- [ ] Test updating baselines: `npm run e2e:visual:update`
- [ ] Verify baseline update works

### Documentation

- [ ] Document visual regression testing approach
- [ ] Document how to run visual regression tests
- [ ] Document how to update baselines
- [ ] Document screenshot comparison settings
- [ ] Document known visual differences (if any)

### Verification

- [ ] Verify visual regression testing is set up
- [ ] Verify baseline screenshots are created
- [ ] Verify tests work correctly
- [ ] Verify CI integration works (if applicable)

## Notes

- This task is part of Section 7: E2E, Accessibility, and Regression Tests (Phase 4)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-32, TASK-33 are complete (all unit tests, integration tests, and E2E framework setup)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required for visual regression)
  - TASK-4: Configure coverage thresholds
  - TASK-32: Set up Playwright or Cypress for E2E (required)
  - TASK-33: Implement core E2E journeys (recommended)
- **Important Considerations**: 
  - This task is optional but valuable
  - Use E2E framework screenshot capabilities for simplicity
  - Capture baselines for critical pages only
  - Set appropriate thresholds for pixel differences
  - Make it easy to update baselines when intentional changes are made
  - Consider using dedicated tools (Percy, Chromatic) for more advanced features
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: No visual regression testing is set up

## Related Tasks

- Previous: TASK-34 (Add accessibility checks)
- Next: TASK-36 (Add negative E2E journeys)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not required)
  - TASK-4: Configure coverage thresholds
  - TASK-32: Set up Playwright or Cypress for E2E (required)
  - TASK-33: Implement core E2E journeys (recommended)
- Related: TASK-32, TASK-33 (E2E framework and tests)

## Definition of Done

### Task Type: CONFIGURATION TASK + TESTING TASK

**Description**: This task involves setting up visual regression testing and creating baseline screenshots.

**Definition of Done**: 

1. **Visual regression setup complete**:
   - Screenshot capture is configured
   - Screenshot comparison is configured
   - Baseline directory structure is set up

2. **Baseline screenshots created**:
   - Baselines exist for critical pages
   - Baselines are stored correctly
   - Baselines represent current UI state

3. **Visual regression tests written**:
   - Tests capture screenshots
   - Tests compare against baselines
   - Tests detect visual differences

4. **Tests pass**:
   - Visual regression tests pass
   - Tests run successfully: `npm run e2e:visual`
   - Baseline update works: `npm run e2e:visual:update`

5. **Code quality**:
   - Configuration is correct
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Configuration files committed
   - Baseline screenshots committed (or stored in appropriate location)
   - Test files committed
   - npm scripts committed (package.json)
   - Commit message: `feat: add visual regression tests with baseline screenshots`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the UI
   - **I want** visual regression tests that detect unintended visual changes
   - **So that** I can catch UI regressions before they reach production

8. **Automated Tests**:
   - Visual regression tests written and passing
   - Tests run successfully: `npm run e2e:visual` must complete successfully
   - Test verification: Run `npm run e2e:visual` and confirm tests pass and compare against baselines

**Acceptance Criteria**:
- ✅ Visual regression testing is configured
- ✅ Baseline screenshots are created for critical pages
- ✅ Visual regression tests are written
- ✅ Tests compare screenshots against baselines
- ✅ All tests pass
- ✅ All changes committed and pushed to origin

**Configuration is complete, verified to work correctly, and committed to git**
