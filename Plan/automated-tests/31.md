# TASK-31: Add integration tests for voice dashboard

**Section**: 6. Integration Tests for Critical Flows (Phase 3)
**Subsection**: 6.6 Voice Dashboard Integration
**Task ID**: TASK-31

## Description

This task creates comprehensive integration tests for the voice dashboard flow. These tests verify voice connect/disconnect functionality, status changes, mode changes, error handling, and UI reactions to voice service events.

The tests will verify:
- Voice service initialization works correctly
- Voice connect/disconnect works with various preconditions
- Status change callbacks update UI correctly
- Mode change callbacks update UI correctly
- Error callbacks are handled correctly
- UI reacts correctly to voice service events
- Preconditions (no agent ID, no conversation) are handled

This is an integration test that exercises the voice dashboard with mocked voice service.

## Current State

- `Dashboard` component exists and uses `ElevenLabsVoiceService`
- Voice service has methods: `startVoiceSession`, `endVoiceSession`, `configure`
- Voice service emits callbacks: `onStatusChange`, `onModeChange`, `onError`
- `VoiceIndicator` component displays voice status
- No integration tests currently exist for this flow
- Unit tests for individual components may exist

**Reference Implementation**: 
- `src/components/Dashboard.tsx`
- `src/components/VoiceIndicator.tsx`
- `ElevenLabsVoiceService` implementation
- Existing integration test patterns (if any)

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete (all unit tests for components, APIs, and utilities).

## Checklist

### Preparation and Setup

- [ ] Review `Dashboard.tsx` component
- [ ] Review `VoiceIndicator.tsx` component
- [ ] Review `ElevenLabsVoiceService` implementation
- [ ] Understand voice service API
- [ ] Review existing integration test patterns
- [ ] Understand voice service callbacks

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/__tests__/voice-dashboard-integration.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Import `Dashboard` component
  - [ ] Set up mocks for `ElevenLabsVoiceService`

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for voice dashboard integration
  - [ ] Mock `ElevenLabsVoiceService` with stubs for methods
  - [ ] Create mock voice service instance
  - [ ] Set up callback handlers

- [ ] Step 3: Write tests for voice service initialization
  - [ ] Test: Voice service is instantiated on mount
  - [ ] Test: Voice service is configured correctly
  - [ ] Test: Voice service cleanup on unmount
  - [ ] Test: VoiceIndicator receives status prop

- [ ] Step 4: Write tests for voice connect
  - [ ] Test: Voice connect with valid agent ID and conversation
  - [ ] Test: `startVoiceSession` is called with correct parameters
  - [ ] Test: Status changes to "connecting" then "connected"
  - [ ] Test: UI updates reflect status changes
  - [ ] Test: Voice connect without agent ID shows appropriate error
  - [ ] Test: Voice connect without conversation shows appropriate error

- [ ] Step 5: Write tests for voice disconnect
  - [ ] Test: Voice disconnect calls `endVoiceSession`
  - [ ] Test: Status changes to "disconnected"
  - [ ] Test: UI updates reflect status changes
  - [ ] Test: Disconnect works from any state

- [ ] Step 6: Write tests for status change callbacks
  - [ ] Test: `onStatusChange` callback updates UI
  - [ ] Test: Status changes are reflected in VoiceIndicator
  - [ ] Test: Multiple status changes work correctly
  - [ ] Test: Status changes trigger re-renders

- [ ] Step 7: Write tests for mode change callbacks
  - [ ] Test: `onModeChange` callback updates UI
  - [ ] Test: Mode changes are reflected in UI
  - [ ] Test: Multiple mode changes work correctly

- [ ] Step 8: Write tests for error callbacks
  - [ ] Test: `onError` callback shows error message
  - [ ] Test: Error messages are displayed correctly
  - [ ] Test: Errors don't break voice service
  - [ ] Test: Error recovery works correctly

- [ ] Step 9: Write tests for preconditions
  - [ ] Test: Voice connect without agent ID shows error
  - [ ] Test: Voice connect without conversation shows error
  - [ ] Test: Precondition errors are clear
  - [ ] Test: UI handles missing preconditions gracefully

### Specific Requirements

- [ ] Requirement 1: Voice service tested
  - Service initialization works
  - Service cleanup works
  - Service methods are called correctly

- [ ] Requirement 2: Connect/disconnect tested
  - Connect works with valid preconditions
  - Connect fails with invalid preconditions
  - Disconnect works correctly

- [ ] Requirement 3: Callbacks tested
  - Status change callbacks work
  - Mode change callbacks work
  - Error callbacks work

- [ ] Requirement 4: UI updates tested
  - UI reflects status changes
  - UI reflects mode changes
  - UI displays errors correctly

### Error Handling and Edge Cases

- [ ] Handle case: Voice service fails to initialize
  - Error is shown
  - Component doesn't crash

- [ ] Handle case: Voice service connection fails
  - Error callback is triggered
  - UI shows error message

- [ ] Handle case: Rapid connect/disconnect
  - Component handles gracefully
  - State is correct

### Testing

- [ ] Write all integration test cases
- [ ] Mock `ElevenLabsVoiceService` appropriately
- [ ] Test callback handlers
- [ ] Test UI updates
- [ ] Run tests: `npm test -- voice-dashboard-integration.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios
- [ ] Document voice service mocking

### Verification

- [ ] Verify all voice dashboard integration is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 6: Integration Tests for Critical Flows (Phase 3)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete (all unit tests for components, APIs, and utilities)
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (not strictly needed but good to have)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - This is an integration test - test voice service integration
  - Mock `ElevenLabsVoiceService` with stubs
  - Test callback handlers carefully
  - Test UI reactions to callbacks
  - Test preconditions (no agent ID, no conversation)
  - Use Vitest's mocking capabilities
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: Dashboard and voice components exist but have no integration tests

## Related Tasks

- Previous: TASK-30 (Add integration tests for agent conversation flows)
- Next: TASK-32 (Set up Playwright or Cypress for E2E)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (recommended)
  - TASK-4: Configure coverage thresholds
- Related: None

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive integration tests for the voice dashboard flow.

**Definition of Done**: 

1. **Test file created**:
   - `src/__tests__/voice-dashboard-integration.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Voice service initialization tested
   - Voice connect/disconnect tested
   - Status change callbacks tested
   - Mode change callbacks tested
   - Error callbacks tested
   - Preconditions tested

3. **Tests pass**:
   - All voice dashboard integration tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - Integration test coverage is adequate
   - Coverage meets project thresholds

5. **Code quality**:
   - Tests use semantic queries
   - Tests mock voice service appropriately
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add integration tests for voice dashboard`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the voice dashboard
   - **I want** comprehensive integration tests that verify voice service integration and UI reactions
   - **So that** I can confidently refactor and extend the voice dashboard without breaking functionality

8. **Automated Tests**:
   - All voice dashboard integration tests written and passing
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- voice-dashboard-integration.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/__tests__/voice-dashboard-integration.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (initialization, connect/disconnect, callbacks, preconditions)
- ✅ Voice service mocked appropriately
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
