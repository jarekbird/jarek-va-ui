# TASK-9: Add tests for `AgentConversationListView`

**Section**: 3. Unit Tests for Untested Components (Phase 2A)
**Subsection**: 3.2 Agent Conversation Components
**Task ID**: TASK-9

## Description

This task creates comprehensive unit tests for the `AgentConversationListView` component. This component is responsible for displaying a paginated, filterable, sortable list of agent conversations with search functionality.

The tests will verify:
- Initial load with pagination parameters
- Pagination controls (Next/Previous buttons)
- Filtering by agent ID and search query
- Sorting by different fields with order control
- New conversation creation
- Error and empty states
- Integration with MSW for API mocking

This is a complex component with multiple features requiring thorough test coverage.

## Current State

- `AgentConversationListView` component exists at `src/components/AgentConversationListView.tsx`
- Component uses `listAgentConversations` and `createAgentConversation` from API
- Component has pagination, filtering, and sorting features
- Component uses React Router for navigation
- Component renders `AgentConversationList`, `Navigation`, `LoadingSpinner`, `ErrorMessage`
- No tests currently exist for this component
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/components/AgentConversationListView.tsx` (full file)
- `src/api/agent-conversations.ts` for API client structure
- `src/components/__tests__/ConversationListView.test.tsx` for similar patterns

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4, TASK-8 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `AgentConversationListView.tsx` component code
- [ ] Review `src/api/agent-conversations.ts` to understand API structure
- [ ] Review MSW handlers from TASK-3 for agent conversations endpoints
- [ ] Review `ConversationListView.test.tsx` for similar test patterns
- [ ] Understand pagination, filtering, and sorting logic

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/components/__tests__/AgentConversationListView.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Set up MSW handlers for agent conversations API

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for AgentConversationListView
  - [ ] Set up MSW handlers for `/api/agent-conversations` (GET, POST)
  - [ ] Create mock agent conversation data with pagination
  - [ ] Set up MemoryRouter for routing tests

- [ ] Step 3: Write tests for initial load
  - [ ] Test: Component calls `listAgentConversations` with default parameters on mount
  - [ ] Test: Default parameters: `limit: 20`, `offset: 0`, `sortBy: 'lastAccessedAt'`, `sortOrder: 'desc'`
  - [ ] Test: Conversations are rendered via `AgentConversationList`
  - [ ] Test: Total count is displayed correctly
  - [ ] Test: LoadingSpinner shown during load, then hidden

- [ ] Step 4: Write tests for pagination
  - [ ] Test: "Next" button enabled when more pages available
  - [ ] Test: "Next" button disabled on last page
  - [ ] Test: "Previous" button disabled on first page
  - [ ] Test: "Previous" button enabled when not on first page
  - [ ] Test: Clicking "Next" increments page and triggers API call
  - [ ] Test: Clicking "Previous" decrements page and triggers API call
  - [ ] Test: Page number and total pages displayed correctly
  - [ ] Test: Pagination only shown when totalCount > pageSize and no filters active

- [ ] Step 5: Write tests for filtering
  - [ ] Test: Agent dropdown filters conversations by `agentId`
  - [ ] Test: Search input filters by conversation ID
  - [ ] Test: Search input filters by agent ID
  - [ ] Test: Search input filters by message content
  - [ ] Test: "Clear Filters" button resets both filters
  - [ ] Test: Filter count display shows correct numbers
  - [ ] Test: Filters work together (agent + search)

- [ ] Step 6: Write tests for sorting
  - [ ] Test: Sort by "Last Accessed" maps to `lastAccessedAt` backend field
  - [ ] Test: Sort by "Created Date" maps to `createdAt` backend field
  - [ ] Test: Sort by "Message Count" maps to `messageCount` backend field
  - [ ] Test: Sort order "Newest First" maps to `desc`
  - [ ] Test: Sort order "Oldest First" maps to `asc`
  - [ ] Test: Changing sort triggers API reload
  - [ ] Test: Changing sort order triggers API reload

- [ ] Step 7: Write tests for new conversation creation
  - [ ] Test: Clicking "+ New Agent Conversation" calls `createAgentConversation`
  - [ ] Test: Button shows "Creating..." during creation
  - [ ] Test: Button is disabled during creation
  - [ ] Test: After creation, navigates to `/agent-conversation/:id`
  - [ ] Test: After creation, reloads conversations list
  - [ ] Test: Error during creation shows error message

- [ ] Step 8: Write tests for error and empty states
  - [ ] Test: Network error displays friendly message and retry button
  - [ ] Test: 404 error displays appropriate message
  - [ ] Test: 500 error displays appropriate message
  - [ ] Test: Retry button calls `loadConversations` again
  - [ ] Test: Empty state message shown when no conversations
  - [ ] Test: "No conversations match your search criteria" shown when filters return no results

### Specific Requirements

- [ ] Requirement 1: API integration tested
  - `listAgentConversations` API call tested with various parameters
  - `createAgentConversation` API call tested
  - MSW handlers work correctly
  - Error responses are handled

- [ ] Requirement 2: Pagination tested
  - Page navigation works correctly
  - Button states are correct
  - API calls include correct offset calculation

- [ ] Requirement 3: Filtering tested
  - All filter types work correctly
  - Filters combine correctly
  - Clear filters works

- [ ] Requirement 4: Sorting tested
  - Sort field mapping is correct
  - Sort order mapping is correct
  - API calls include correct sort parameters

### Error Handling and Edge Cases

- [ ] Handle case: API returns empty array
  - Empty state is displayed
  - No errors thrown

- [ ] Handle case: Filters return no results
  - Appropriate message is shown
  - Component doesn't crash

- [ ] Handle case: Pagination with filters
  - Pagination hidden when filters active
  - Filtered results displayed correctly

- [ ] Handle case: Multiple rapid filter changes
  - Component handles rapid changes gracefully
  - No duplicate API calls

### Testing

- [ ] Write all test cases for AgentConversationListView
- [ ] Use MSW to mock API responses
- [ ] Use userEvent for user interactions
- [ ] Use MemoryRouter for routing
- [ ] Run tests: `npm test -- AgentConversationListView.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios

### Verification

- [ ] Verify all AgentConversationListView functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 3: Unit Tests for Untested Components (Phase 2A)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4, TASK-8 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking)
  - TASK-4: Configure coverage thresholds
  - TASK-8: Add tests for AgentConversationList (uses this component)
- **Important Considerations**: 
  - Use MSW handlers from TASK-3 for API mocking
  - Test pagination with realistic data (multiple pages)
  - Test all filter combinations
  - Test sort field and order mappings carefully
  - Use userEvent for realistic user interactions
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: AgentConversationListView component exists but has no tests

## Related Tasks

- Previous: TASK-8 (Add tests for AgentConversationList)
- Next: TASK-10 (Add tests for AgentConversationDetailView)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
  - TASK-8: Add tests for AgentConversationList
- Related: TASK-8 (AgentConversationList is used by this component), TASK-10 (detail view counterpart)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the AgentConversationListView component.

**Definition of Done**: 

1. **Test file created**:
   - `src/components/__tests__/AgentConversationListView.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Initial load tested
   - Pagination tested
   - Filtering tested (agent, search)
   - Sorting tested (field and order mapping)
   - New conversation creation tested
   - Error and empty states tested

3. **Tests pass**:
   - All AgentConversationListView tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - AgentConversationListView component has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum)

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for AgentConversationListView component`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the AgentConversationListView component
   - **I want** comprehensive unit tests that verify pagination, filtering, sorting, and API integration
   - **So that** I can confidently refactor and extend the component without breaking functionality

8. **Automated Tests**:
   - All AgentConversationListView tests written and passing
   - Test coverage for component meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- AgentConversationListView.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/components/__tests__/AgentConversationListView.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (load, pagination, filters, sorting, creation, errors)
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
