# TASK-4: Configure and enforce coverage thresholds

**Section**: 2. Testing Infrastructure Enhancements (Phase 1)
**Subsection**: 2.2
**Task ID**: TASK-4

## Description

This task configures code coverage thresholds in Vitest to enforce minimum coverage requirements across the codebase. Coverage thresholds ensure that:

1. Overall code coverage meets a minimum standard (≥80%)
2. Critical domains (components, APIs, services) meet higher standards (≥90%)
3. Coverage is tracked and enforced in CI/CD
4. Coverage reports are generated for analysis

This establishes quality gates that prevent code coverage from regressing and ensures comprehensive test coverage as we build out the test suite.

## Current State

- `vitest.config.ts` exists and has basic coverage configuration
- Coverage provider is set to 'v8'
- Coverage reporters are configured (text, json, html, lcov)
- Coverage thresholds are NOT currently configured
- `@vitest/coverage-v8` is likely already installed (check package.json)
- `npm run test:coverage` script may or may not exist

**Reference Implementation**: 
- `vitest.config.ts` (lines 1-23)
- Vitest coverage documentation: https://vitest.dev/guide/coverage.html

**Important**: This task should be executed after TASK-1 is complete.

## Checklist

### Preparation and Setup

- [ ] Review current `vitest.config.ts` configuration
- [ ] Check if `@vitest/coverage-v8` is installed in `package.json`
- [ ] Review Vitest coverage threshold documentation
- [ ] Understand current coverage baseline (run `npm run test:coverage` if script exists)
- [ ] Review CI/CD configuration files (if any)

### Implementation Steps

- [ ] Step 1: Verify coverage package installation
  - [ ] Check `package.json` for `@vitest/coverage-v8`
  - [ ] If missing, install: `npm install --save-dev @vitest/coverage-v8`
  - [ ] Verify installation completes successfully

- [ ] Step 2: Update vitest.config.ts with thresholds
  - [ ] Open `vitest.config.ts`
  - [ ] Locate the `coverage` configuration object
  - [ ] Add `thresholds` configuration:
    - [ ] Set global thresholds:
      - `statements: 80`
      - `branches: 80`
      - `functions: 80`
      - `lines: 80`
    - [ ] Optionally add per-directory thresholds:
      - `src/components`: 90% for all metrics
      - `src/api`: 90% for all metrics
      - `src/services`: 90% for all metrics
  - [ ] Save the file

- [ ] Step 3: Verify test:coverage script
  - [ ] Check `package.json` for `test:coverage` script
  - [ ] If missing, add: `"test:coverage": "vitest --coverage --run"`
  - [ ] Verify script is correctly configured

- [ ] Step 4: Update CI configuration (if applicable)
  - [ ] Locate CI configuration file (`.github/workflows/`, `.gitlab-ci.yml`, etc.)
  - [ ] Add or verify step that runs `npm run test:coverage`
  - [ ] Ensure coverage thresholds are enforced (tests fail if thresholds not met)
  - [ ] If no CI config exists, document requirement for future setup

- [ ] Step 5: Run coverage and establish baseline
  - [ ] Run `npm run test:coverage`
  - [ ] Review coverage report output
  - [ ] Note current coverage percentages
  - [ ] Document baseline coverage in task notes
  - [ ] If thresholds are too high for current state, adjust temporarily (document as technical debt)

### Specific Requirements

- [ ] Requirement 1: Coverage thresholds configured
  - Global thresholds set to ≥80% for statements, branches, functions, lines
  - Per-directory thresholds set to ≥90% for critical domains (if applicable)
  - Thresholds are properly formatted in vitest.config.ts

- [ ] Requirement 2: Coverage script available
  - `npm run test:coverage` script exists in package.json
  - Script runs coverage and exits with appropriate code
  - Coverage reports are generated

- [ ] Requirement 3: CI integration (if applicable)
  - CI runs coverage checks
  - CI enforces thresholds (fails if not met)
  - Coverage reports are accessible in CI

- [ ] Requirement 4: Baseline established
  - Current coverage percentages documented
  - Baseline is realistic given current test state
  - Thresholds are achievable or adjusted appropriately

### Error Handling and Edge Cases

- [ ] Handle case: Coverage package not installed
  - Install `@vitest/coverage-v8` if missing
  - Verify installation completes successfully

- [ ] Handle case: Current coverage below thresholds
  - Document current baseline
  - Consider setting initial thresholds slightly below current coverage
  - Plan to raise thresholds as coverage improves
  - Document as technical debt if needed

- [ ] Handle case: CI configuration doesn't exist
  - Document requirement for CI integration
  - Note that thresholds should be enforced in CI when it's set up
  - Don't block task completion if CI isn't configured yet

- [ ] Handle case: Coverage script fails
  - Check that coverage provider is correctly configured
  - Verify all dependencies are installed
  - Check for configuration errors

### Testing

- [ ] Verify coverage configuration
  - Run `npm run test:coverage`
  - Verify coverage report is generated
  - Check that thresholds are being evaluated
  - Verify coverage percentages are displayed

- [ ] Test threshold enforcement
  - If possible, temporarily lower a threshold to verify it works
  - Verify that tests fail if threshold is not met (when coverage is below)
  - Restore correct thresholds

- [ ] Run type checking: `npm run type-check`
  - Verify no type errors in vitest.config.ts

- [ ] Run linting: `npm run lint`
  - Fix any linting issues

### Documentation

- [ ] Document coverage thresholds in vitest.config.ts (comments)
- [ ] Document baseline coverage percentages
- [ ] Document any technical debt (thresholds set below target temporarily)
- [ ] Update README or test documentation with coverage information (if applicable)

### Verification

- [ ] Verify thresholds are configured correctly
- [ ] Verify coverage script works
- [ ] Verify CI integration (if applicable)
- [ ] Verify baseline is documented
- [ ] Verify configuration is committed

## Notes

- This task is part of Section 2: Testing Infrastructure Enhancements (Phase 1)
- **Execution Timing**: Execute after TASK-1 is complete (can run in parallel with TASK-3)
- **Dependencies**: 
  - TASK-1: Confirm local setup (must be complete)
- **Important Considerations**: 
  - Thresholds should be realistic for current coverage state
  - Can start with lower thresholds and raise them as coverage improves
  - Per-directory thresholds are optional but recommended for critical code
  - CI enforcement is important but not blocking if CI isn't set up yet
- **Task Independence**: Can be completed independently after TASK-1
- **Current State**: Coverage thresholds are not configured

## Related Tasks

- Previous: TASK-3 (Introduce MSW for network mocking)
- Next: TASK-5 (Add tests for Navigation)
- Dependencies:
  - TASK-1: Confirm local setup
- Related: All future test tasks will benefit from coverage tracking

## Definition of Done

### Task Type: CONFIGURATION TASK

**Description**: This task involves configuring coverage thresholds in Vitest and ensuring coverage tracking is set up.

**Definition of Done**: 

1. **Coverage thresholds configured**:
   - `vitest.config.ts` updated with global thresholds ≥80%
   - Optional per-directory thresholds ≥90% for critical domains
   - Thresholds are properly formatted and valid

2. **Coverage script available**:
   - `npm run test:coverage` script exists in `package.json`
   - Script runs successfully and generates coverage reports

3. **CI integration verified or documented**:
   - CI configuration updated to run coverage (if CI exists)
   - Or requirement documented for future CI setup

4. **Baseline established**:
   - Current coverage percentages documented
   - Baseline is realistic and achievable

5. **Configuration verified**:
   - `npm run test:coverage` runs successfully
   - Coverage reports are generated
   - Thresholds are evaluated (even if not yet met)

6. **Code committed and pushed**:
   - `vitest.config.ts` changes committed
   - `package.json` changes committed (if script added)
   - CI configuration changes committed (if applicable)
   - Commit message: `feat: configure coverage thresholds in Vitest`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining test coverage
   - **I want** coverage thresholds configured and enforced
   - **So that** I can ensure code quality and prevent coverage regressions

8. **Automated Tests**:
   - No new tests are written in this task
   - Coverage configuration is verified by running `npm run test:coverage`
   - Test verification: Run `npm run test:coverage` and confirm it completes and generates reports

**Acceptance Criteria**:
- ✅ Coverage thresholds configured in `vitest.config.ts` (≥80% global, ≥90% for critical domains)
- ✅ `npm run test:coverage` script exists and works
- ✅ Coverage reports are generated successfully
- ✅ Baseline coverage documented
- ✅ All changes committed and pushed to origin

**Configuration is complete, verified to work correctly, and committed to git**
