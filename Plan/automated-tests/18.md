# TASK-18: Add tests for `WorkingDirectoryBrowser`

**Section**: 3. Unit Tests for Untested Components (Phase 2A)
**Subsection**: 3.4 File System & Queue Components
**Task ID**: TASK-18

## Description

This task creates comprehensive unit tests for the `WorkingDirectoryBrowser` component. This component displays a file tree view of the cursor working directory with expand/collapse functionality and keyboard navigation.

The tests will verify:
- Component loads file tree on mount via `getWorkingDirectoryFiles` API
- Top-level directories are initially expanded
- Directory expand/collapse works via click
- Keyboard navigation (Enter/Space) works for expand/collapse
- Error handling displays appropriate messages
- Empty state is displayed when no files
- `refresh()` method exposed via ref works correctly
- Integration with MSW for API mocking

This component uses `forwardRef` and `useImperativeHandle` to expose refresh functionality.

## Current State

- `WorkingDirectoryBrowser` component exists at `src/components/WorkingDirectoryBrowser.tsx`
- Component uses `getWorkingDirectoryFiles` from `src/api/repositories`
- Component uses `forwardRef` and `useImperativeHandle` to expose `refresh()` method
- Component renders file tree with expand/collapse functionality
- Component supports keyboard navigation (Enter/Space)
- Component handles loading, error, and empty states
- No tests currently exist for this component
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/components/WorkingDirectoryBrowser.tsx` (full file)
- `src/api/repositories.ts` for API client structure
- `src/types/file-tree.ts` for FileNode type definition

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `WorkingDirectoryBrowser.tsx` component code
- [ ] Review `forwardRef` and `useImperativeHandle` usage
- [ ] Review `src/api/repositories.ts` to understand `getWorkingDirectoryFiles` API
- [ ] Review MSW handlers from TASK-3 for working directory endpoint
- [ ] Understand FileNode type structure
- [ ] Understand expand/collapse state management

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/components/__tests__/WorkingDirectoryBrowser.test.tsx`
  - [ ] Import necessary testing utilities and components
  - [ ] Set up MSW handlers for working directory API

- [ ] Step 2: Set up test structure
  - [ ] Create describe block for WorkingDirectoryBrowser
  - [ ] Set up MSW handler for `GET /api/working-directory/files`
  - [ ] Create mock file tree data (nested structure)
  - [ ] Set up ref for testing `refresh()` method

- [ ] Step 3: Write tests for initial load
  - [ ] Test: Component calls `getWorkingDirectoryFiles` on mount
  - [ ] Test: File tree is rendered
  - [ ] Test: Top-level directories are initially expanded
  - [ ] Test: LoadingSpinner shown during load, then hidden
  - [ ] Test: File and directory icons are displayed correctly

- [ ] Step 4: Write tests for expand/collapse (click)
  - [ ] Test: Clicking a directory row toggles expansion
  - [ ] Test: Expanded directory shows children
  - [ ] Test: Collapsed directory hides children
  - [ ] Test: Multiple directories can be expanded/collapsed independently
  - [ ] Test: Files (non-directories) don't toggle expansion

- [ ] Step 5: Write tests for keyboard navigation
  - [ ] Test: Pressing Enter on focused directory toggles expansion
  - [ ] Test: Pressing Space on focused directory toggles expansion
  - [ ] Test: Keyboard navigation works for nested directories
  - [ ] Test: Other keys don't trigger expansion
  - [ ] Test: Focus management works correctly

- [ ] Step 6: Write tests for nested tree structure
  - [ ] Test: Multi-level directory structure is rendered correctly
  - [ ] Test: Expanding parent shows children at correct indentation
  - [ ] Test: Nested expand/collapse works correctly
  - [ ] Test: Tree structure is preserved on refresh

- [ ] Step 7: Write tests for error handling
  - [ ] Test: Non-JSON response shows error message
  - [ ] Test: Error response shows error message
  - [ ] Test: ErrorMessage component receives error message
  - [ ] Test: File tree not rendered when error occurs
  - [ ] Test: 404 error shows appropriate message

- [ ] Step 8: Write tests for empty state
  - [ ] Test: "No files found" message shown when file list is empty
  - [ ] Test: Empty state only shown when not loading and no error
  - [ ] Test: File tree not rendered when empty

- [ ] Step 9: Write tests for ref-based refresh
  - [ ] Test: `refresh()` method is exposed via ref
  - [ ] Test: Calling `refresh()` via ref calls `getWorkingDirectoryFiles`
  - [ ] Test: Calling `refresh()` updates file tree
  - [ ] Test: Expanded state is preserved on refresh (if applicable)

### Specific Requirements

- [ ] Requirement 1: API integration tested
  - `getWorkingDirectoryFiles` API call is tested
  - MSW handlers work correctly
  - Error responses are handled
  - Non-JSON responses are handled

- [ ] Requirement 2: Expand/collapse tested
  - Click interaction works
  - Keyboard interaction works (Enter/Space)
  - Multiple directories work independently
  - Nested directories work correctly

- [ ] Requirement 3: Initial state tested
  - Top-level directories are expanded initially
  - File tree structure is correct
  - Icons are displayed correctly

- [ ] Requirement 4: Ref API tested
  - `refresh()` method is exposed
  - Method works correctly
  - Ref can be used by parent

### Error Handling and Edge Cases

- [ ] Handle case: API returns empty array
  - Empty state is displayed
  - No errors thrown

- [ ] Handle case: API returns non-JSON response
  - Error message is displayed
  - Component doesn't crash

- [ ] Handle case: File tree has very deep nesting
  - Component handles gracefully
  - Rendering doesn't break

- [ ] Handle case: Rapid expand/collapse clicks
  - Component handles gracefully
  - State is correct

- [ ] Handle case: Ref is not provided
  - Component still works
  - No errors thrown

### Testing

- [ ] Write all test cases for WorkingDirectoryBrowser
- [ ] Use MSW to mock API responses
- [ ] Use `createRef` or `useRef` to test ref functionality
- [ ] Use userEvent for click and keyboard interactions
- [ ] Test with nested file tree structures
- [ ] Run tests: `npm test -- WorkingDirectoryBrowser.test.tsx`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for ref testing patterns
- [ ] Add comments for keyboard navigation tests

### Verification

- [ ] Verify all WorkingDirectoryBrowser functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 3: Unit Tests for Untested Components (Phase 2A)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Use MSW handlers from TASK-3 for API mocking
  - Test expand/collapse with nested structures
  - Test keyboard navigation carefully (Enter/Space)
  - Use userEvent for realistic interactions
  - Test ref-based API using `createRef` or `useRef` in tests
  - Test initial expansion state (top-level directories)
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: WorkingDirectoryBrowser component exists but has no tests

## Related Tasks

- Previous: TASK-17 (Add tests for TaskDashboard)
- Next: TASK-19 (Add tests for BullMQQueueView)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-17 (TaskDashboard uses this component)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the WorkingDirectoryBrowser component, including file tree rendering, expand/collapse, and keyboard navigation.

**Definition of Done**: 

1. **Test file created**:
   - `src/components/__tests__/WorkingDirectoryBrowser.test.tsx` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - Initial load tested
   - Expand/collapse tested (click and keyboard)
   - Nested tree structure tested
   - Error handling tested
   - Empty state tested
   - Ref-based refresh tested

3. **Tests pass**:
   - All WorkingDirectoryBrowser tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - WorkingDirectoryBrowser component has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum)

5. **Code quality**:
   - Tests use semantic queries
   - Tests use MSW for API mocking
   - Tests verify ref functionality
   - Tests verify keyboard navigation
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for WorkingDirectoryBrowser component`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the WorkingDirectoryBrowser component
   - **I want** comprehensive unit tests that verify file tree rendering, expand/collapse, keyboard navigation, and ref functionality
   - **So that** I can confidently refactor and extend the component without breaking functionality

8. **Automated Tests**:
   - All WorkingDirectoryBrowser tests written and passing
   - Test coverage for component meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- WorkingDirectoryBrowser.test.tsx` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/components/__tests__/WorkingDirectoryBrowser.test.tsx` created with comprehensive tests
- ✅ All scenarios tested (load, expand/collapse, keyboard, errors, empty, refresh)
- ✅ MSW used for API mocking
- ✅ Ref functionality tested
- ✅ All tests pass
- ✅ Test coverage meets requirements
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
