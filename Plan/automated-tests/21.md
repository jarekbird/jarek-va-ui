# TASK-21: Add tests for `src/api/repositories.ts`

**Section**: 4. Unit Tests for Untested API Clients (Phase 2B)
**Subsection**: 4.2 Repository API Client
**Task ID**: TASK-21

## Description

This task creates comprehensive unit tests for the `src/api/repositories.ts` API client module. This module provides functions to interact with repository file browser API endpoints.

The tests will verify:
- `getWorkingDirectoryFiles` function handles successful responses
- `getWorkingDirectoryFiles` function handles 404 responses (working directory not found)
- `getWorkingDirectoryFiles` function handles non-JSON responses
- `getRepositoryFiles` function handles successful responses
- `getRepositoryFiles` function handles 404 responses (repository not found) with correct error message
- `getRepositoryFiles` function handles non-JSON responses
- Error messages are clear and meaningful
- Response parsing works correctly

This is a pure API client module that requires thorough test coverage of all response scenarios.

## Current State

- `src/api/repositories.ts` exists and exports `getWorkingDirectoryFiles` and `getRepositoryFiles` functions
- Functions use `fetch` API directly
- Functions use `getApiBasePath()` for working directory endpoint
- Functions check content-type before parsing JSON
- Functions handle 404 errors specially
- Functions extract error messages from responses
- No tests currently exist for this module
- MSW should be set up (from TASK-3) for API mocking

**Reference Implementation**: 
- `src/api/repositories.ts` (full file)
- `src/utils/api-base.ts` for `getApiBasePath` function
- Existing API client tests for patterns

**Important**: This task should be executed after TASK-1, TASK-2, TASK-3, TASK-4 are complete.

## Checklist

### Preparation and Setup

- [ ] Review `src/api/repositories.ts` code
- [ ] Review `getApiBasePath` function usage
- [ ] Review MSW handlers from TASK-3 for repository endpoints
- [ ] Review existing API client tests for patterns
- [ ] Understand error handling patterns
- [ ] Understand content-type checking logic

### Implementation Steps

- [ ] Step 1: Create test file
  - [ ] Create `src/api/__tests__/repositories.test.ts`
  - [ ] Import necessary testing utilities
  - [ ] Import functions from `../repositories`
  - [ ] Set up MSW handlers

- [ ] Step 2: Set up test structure
  - [ ] Create describe blocks for each function
  - [ ] Set up MSW handlers for `/api/working-directory/files` and `/repositories/api/:repository/files`
  - [ ] Create mock file tree data

- [ ] Step 3: Write tests for `getWorkingDirectoryFiles` - success
  - [ ] Test: Successful JSON response returns file tree array
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: File tree structure is correct (FileNode[])
  - [ ] Test: Nested file tree is returned correctly

- [ ] Step 4: Write tests for `getWorkingDirectoryFiles` - 404 response
  - [ ] Test: 404 response throws "Working directory not found" error
  - [ ] Test: Error message is clear and specific
  - [ ] Test: Error is thrown correctly

- [ ] Step 5: Write tests for `getWorkingDirectoryFiles` - non-JSON response
  - [ ] Test: Non-JSON response (wrong content-type) throws error
  - [ ] Test: Error message includes content-type information
  - [ ] Test: Error message includes response text (truncated)
  - [ ] Test: Error is thrown with clear message

- [ ] Step 6: Write tests for `getWorkingDirectoryFiles` - other error responses
  - [ ] Test: 4xx response (not 404) returns error with server message
  - [ ] Test: 5xx response returns error with server message
  - [ ] Test: Error response with JSON error payload propagates message
  - [ ] Test: Error response without JSON uses status text

- [ ] Step 7: Write tests for `getRepositoryFiles` - success
  - [ ] Test: Successful JSON response returns file tree array
  - [ ] Test: Response with correct content-type is parsed
  - [ ] Test: File tree structure is correct (FileNode[])
  - [ ] Test: Repository name is used in URL correctly
  - [ ] Test: Nested file tree is returned correctly

- [ ] Step 8: Write tests for `getRepositoryFiles` - 404 response
  - [ ] Test: 404 response throws error with repository name in message
  - [ ] Test: Error message format: `Repository '${repository}' not found`
  - [ ] Test: Error message is clear and specific
  - [ ] Test: Error is thrown correctly

- [ ] Step 9: Write tests for `getRepositoryFiles` - non-JSON response
  - [ ] Test: Non-JSON response (wrong content-type) throws error
  - [ ] Test: Error message includes content-type information
  - [ ] Test: Error message includes response text (truncated)

- [ ] Step 10: Write tests for `getRepositoryFiles` - other error responses
  - [ ] Test: 4xx response (not 404) returns error with server message
  - [ ] Test: 5xx response returns error with server message
  - [ ] Test: Error response with JSON error payload propagates message
  - [ ] Test: Error response without JSON uses status text

### Specific Requirements

- [ ] Requirement 1: Success scenarios tested
  - Both functions handle successful responses
  - JSON parsing works correctly
  - File tree data structures are correct

- [ ] Requirement 2: Non-JSON responses tested
  - Both functions handle non-JSON responses
  - Error messages include content-type
  - Error messages are clear

- [ ] Requirement 3: Error responses tested
  - 4xx errors are handled
  - 5xx errors are handled
  - 404 errors are handled specially with appropriate messages
  - Error messages are extracted correctly

- [ ] Requirement 4: Error messages tested
  - Error messages are clear and meaningful
  - Repository name is included in 404 error for `getRepositoryFiles`
  - Server-provided messages are used when available
  - Status text is used as fallback

### Error Handling and Edge Cases

- [ ] Handle case: Response has no content-type header
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Response is empty
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: JSON parsing fails
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Network error
  - Function handles gracefully
  - Appropriate error is thrown

- [ ] Handle case: Repository name with special characters
  - URL encoding works correctly
  - Function handles gracefully

### Testing

- [ ] Write all test cases for repositories API client
- [ ] Use MSW to mock API responses
- [ ] Test all response scenarios
- [ ] Test error message extraction
- [ ] Test `getApiBasePath` integration (if applicable)
- [ ] Run tests: `npm test -- repositories.test.ts`
- [ ] Verify all tests pass
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] Check test coverage

### Documentation

- [ ] Add JSDoc comments to test file if needed
- [ ] Document test patterns used
- [ ] Add comments for complex test scenarios

### Verification

- [ ] Verify all repositories API client functionality is tested
- [ ] Verify tests pass
- [ ] Verify no regressions in other tests
- [ ] Verify test coverage meets requirements

## Notes

- This task is part of Section 4: Unit Tests for Untested API Clients (Phase 2B)
- **Execution Timing**: Execute after TASK-1, TASK-2, TASK-3, TASK-4 are complete
- **Dependencies**: 
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required for API mocking)
  - TASK-4: Configure coverage thresholds
- **Important Considerations**: 
  - Use MSW handlers from TASK-3 for API mocking
  - Test content-type checking carefully
  - Test error message extraction from responses
  - Test both JSON and non-JSON error responses
  - Test 404 handling with repository name in error message for `getRepositoryFiles`
  - Test `getApiBasePath` integration if it affects behavior
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: repositories.ts API client exists but has no tests

## Related Tasks

- Previous: TASK-20 (Add tests for src/api/queues.ts)
- Next: TASK-22 (Add tests for src/api/tasks.ts)
- Dependencies:
  - TASK-1: Confirm local setup
  - TASK-2: Review existing test utilities
  - TASK-3: Introduce MSW (required)
  - TASK-4: Configure coverage thresholds
- Related: TASK-18 (WorkingDirectoryBrowser uses `getWorkingDirectoryFiles`), TASK-23 (getApiBasePath is used by repositories)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive unit tests for the repositories API client module.

**Definition of Done**: 

1. **Test file created**:
   - `src/api/__tests__/repositories.test.ts` exists
   - File follows project conventions and patterns

2. **Tests written**:
   - `getWorkingDirectoryFiles` success scenario tested
   - `getWorkingDirectoryFiles` 404 response tested
   - `getWorkingDirectoryFiles` non-JSON response tested
   - `getWorkingDirectoryFiles` other error responses tested
   - `getRepositoryFiles` success scenario tested
   - `getRepositoryFiles` 404 response tested (with repository name in error)
   - `getRepositoryFiles` non-JSON response tested
   - `getRepositoryFiles` other error responses tested

3. **Tests pass**:
   - All repositories API client tests pass
   - Full test suite passes: `npm test`
   - No test failures or errors

4. **Coverage meets requirements**:
   - repositories.ts module has adequate test coverage
   - Coverage meets project thresholds (≥80% minimum, ≥90% for API clients)

5. **Code quality**:
   - Tests use MSW for API mocking
   - Tests are readable and maintainable
   - No linting errors
   - Type checking passes

6. **Code committed and pushed**:
   - Test file committed
   - Commit message: `test: add comprehensive tests for repositories API client`
   - Code pushed to origin: `git push origin <branch-name>`

7. **User Story** (as a developer):
   - **As a** developer maintaining the repositories API client
   - **I want** comprehensive unit tests that verify all response scenarios and error handling
   - **So that** I can confidently refactor and extend the API client without breaking functionality

8. **Automated Tests**:
   - All repositories API client tests written and passing
   - Test coverage for module meets requirements
   - Full test suite passes: `npm test` must complete successfully
   - Test verification: Run `npm test -- repositories.test.ts` and confirm all tests pass

**Acceptance Criteria**:
- ✅ `src/api/__tests__/repositories.test.ts` created with comprehensive tests
- ✅ All scenarios tested (success, 404, non-JSON, errors)
- ✅ Repository name included in 404 error message for `getRepositoryFiles`
- ✅ MSW used for API mocking
- ✅ All tests pass
- ✅ Test coverage meets requirements (≥90% for API clients)
- ✅ All changes committed and pushed to origin

**Tests are written, all tests pass, and test coverage meets project requirements**
