# TASK-3.4: Wire MSW into test setup and verify integration

**Section**: 2. Testing Infrastructure Enhancements (Phase 1)
**Subsection**: 2.1
**Task ID**: TASK-3.4
**Parent Task**: TASK-3
**Order**: 4 of 4

## Description

This task wires the MSW server into the test setup file, ensuring that the server starts before tests run, resets between tests, and closes after all tests complete. This integration enables MSW to intercept network requests during test execution.

The task also includes verification that MSW is working correctly and that existing tests still pass with MSW enabled.

## Current State

- MSW should be installed (from TASK-3.1)
- Handlers should be created (from TASK-3.2)
- Server should be configured (from TASK-3.3)
- `src/test/setup.ts` exists but may not have MSW integration
- MSW is not yet integrated into the test lifecycle

**Reference Implementation**: 
- MSW documentation: https://mswjs.io/docs/getting-started/integrate/node
- `src/test/mocks/server.ts` for server instance
- `src/test/setup.ts` for test setup file

**Important**: This task should be executed after TASK-3.1, TASK-3.2, and TASK-3.3 are complete.

## Checklist

### Preparation and Setup

- [ ] Review MSW test setup documentation
- [ ] Review `src/test/setup.ts` to understand current test setup
- [ ] Review `src/test/mocks/server.ts` to understand server instance
- [ ] Understand Vitest lifecycle hooks (beforeAll, afterEach, afterAll)

### Implementation Steps

- [ ] Step 1: Import server into test setup
  - [ ] Open `src/test/setup.ts`
  - [ ] Import server from `./mocks/server`
  - [ ] Verify import path is correct

- [ ] Step 2: Add server lifecycle hooks
  - [ ] Add `beforeAll` hook to start server: `server.listen({ onUnhandledRequest: 'error' })`
  - [ ] Add `afterEach` hook to reset handlers: `server.resetHandlers()`
  - [ ] Add `afterAll` hook to close server: `server.close()`
  - [ ] Ensure this doesn't conflict with existing cleanup

- [ ] Step 3: Verify MSW integration
  - [ ] Run a subset of existing tests: `npm test -- src/__tests__/App.test.tsx`
  - [ ] Verify tests still pass
  - [ ] Check for any MSW-related errors
  - [ ] Verify network requests are being intercepted
  - [ ] Fix any issues that arise

- [ ] Step 4: Write verification test
  - [ ] Create a simple test that makes a fetch request
  - [ ] Verify the request is intercepted by MSW
  - [ ] Verify the handler response is returned
  - [ ] Run the verification test

### Specific Requirements

- [ ] Requirement 1: MSW integrated into test setup
  - Server starts before all tests
  - Handlers reset between tests
  - Server closes after all tests
  - No conflicts with existing test setup

- [ ] Requirement 2: Existing tests still pass
  - All existing tests pass with MSW enabled
  - No test failures introduced by MSW
  - Network requests are properly intercepted

- [ ] Requirement 3: Verification test passes
  - Verification test confirms MSW is working
  - Test demonstrates request interception
  - Test demonstrates handler response

### Error Handling and Edge Cases

- [ ] Handle case: Tests fail after MSW integration
  - Check if tests were relying on real network calls
  - Verify handler responses match expected formats
  - Ensure handlers return correct status codes
  - Update tests to work with MSW if needed

- [ ] Handle case: Handler conflicts with existing mocks
  - Review existing test mocks
  - Ensure MSW doesn't conflict with manual mocks
  - Update or remove conflicting mocks

- [ ] Handle case: Server lifecycle conflicts
  - Ensure MSW hooks don't conflict with existing hooks
  - Verify cleanup order is correct
  - Test that server properly closes

- [ ] Handle case: Unhandled requests
  - Ensure `onUnhandledRequest: 'error'` catches unmocked requests
  - Verify error messages are clear
  - Add handlers for any missing endpoints

### Testing

- [ ] Write verification test for MSW
  - Create a simple test that makes a fetch request
  - Verify the request is intercepted by MSW
  - Verify the handler response is returned

- [ ] Run existing tests: `npm test`
  - Verify all tests pass
  - Check for any MSW-related warnings or errors
  - Verify no tests are making real network requests

- [ ] Run type checking: `npm run type-check`
  - Verify no type errors in setup file
  - Fix any TypeScript issues

- [ ] Run linting: `npm run lint`
  - Fix any linting issues in setup file

### Documentation

- [ ] Add comments explaining MSW setup in `setup.ts`
- [ ] Document server lifecycle management
- [ ] Document how to add new handlers
- [ ] Update test README if it exists

### Verification

- [ ] Verify MSW is integrated into test setup
- [ ] Verify existing tests pass
- [ ] Verify network requests are intercepted
- [ ] Verify verification test passes

## Notes

- This task is part of **Section 2: Testing Infrastructure Enhancements (Phase 1)**
- **Execution Timing**: Execute after TASK-3.1, TASK-3.2, and TASK-3.3 are complete
- **Dependencies**: 
  - TASK-3.1: Install MSW package (must be complete)
  - TASK-3.2: Create mock handlers (must be complete)
  - TASK-3.3: Create MSW server configuration (must be complete)
- **Important Considerations**: 
  - Use `onUnhandledRequest: 'error'` to catch unmocked requests during development
  - Server lifecycle must be properly managed (start, reset, close)
  - Ensure MSW doesn't conflict with existing test setup
  - All existing tests should pass with MSW enabled
- **Task Independence**: Can be completed independently after prerequisites
- **Current State**: MSW is not integrated into test setup

## Related Tasks

- Parent: TASK-3 (Introduce MSW for network mocking)
- Previous: TASK-3.3 (Create MSW server configuration)
- Next: TASK-4 (Configure and enforce coverage thresholds)
- Dependencies:
  - TASK-3.1: Install MSW package
  - TASK-3.2: Create mock handlers
  - TASK-3.3: Create MSW server configuration

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**Description**: This task involves wiring MSW into the test setup and verifying integration.

**Definition of Done**: 

1. **MSW integrated**:
   - `src/test/setup.ts` updated to start/stop/reset MSW server
   - Server lifecycle properly managed (beforeAll, afterEach, afterAll)
   - No conflicts with existing test setup

2. **Tests pass**:
   - All existing tests pass: `npm test` completes successfully
   - No test failures introduced by MSW
   - Network requests are properly intercepted

3. **Verification test**:
   - Verification test confirms MSW is working
   - Test demonstrates request interception and handler response

4. **Code committed and pushed**:
   - `src/test/setup.ts` committed
   - Verification test committed (if created as separate file)
   - Commit message: `feat: wire MSW into test setup and verify integration`
   - Code pushed to origin: `git push origin <branch-name>`

5. **User Story** (as a developer):
   - **As a** developer writing tests
   - **I want** MSW integrated into the test setup
   - **So that** network requests are automatically intercepted during test execution

6. **Automated Tests**:
   - Verification test confirms MSW is working
   - All existing tests must pass: `npm test` must complete successfully
   - Test verification: Run `npm test` and confirm all tests pass with MSW enabled

**Acceptance Criteria**:
- ✅ `src/test/setup.ts` updated to integrate MSW
- ✅ Server lifecycle properly managed
- ✅ All existing tests pass with MSW enabled
- ✅ Verification test confirms MSW is working
- ✅ All changes committed and pushed to origin

**A Pull Request was created OR code was pushed to origin with the task complete**
















